<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Bloques - Tralalero Contracts</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #blocklyDiv {
            height: 400px;
            width: 100%;
            border: 1px solid #ccc;
        }

        .info {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <h1>Test de Bloques por Defecto</h1>
    <div class="info">
        <p>Este es un test para verificar que los bloques se crean y conectan correctamente.</p>
        <button onclick="testBlocks()">üß™ Probar Creaci√≥n de Bloques</button>
        <button onclick="readData()">üìñ Leer Datos</button>
        <div id="output"></div>
    </div>
    <div id="blocklyDiv"></div>

    <script>
        // Definir bloques (simplificado)
        Blockly.Blocks['contract_settings'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("üîÆ Mi Contrato M√°gico");
                this.appendStatementInput("SETTINGS")
                    .setCheck(null);
                this.setColour(290);
            }
        };

        Blockly.Blocks['token_name'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("Nombre de la moneda")
                    .appendField(new Blockly.FieldTextInput("Mi Tesoro"), "NAME");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(190);
            }
        };

        Blockly.Blocks['token_symbol'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("S√≠mbolo (dibujito)")
                    .appendField(new Blockly.FieldTextInput("ORO"), "SYMBOL");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(190);
            }
        };

        Blockly.Blocks['initial_supply'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("üí∞ Cantidad inicial de monedas")
                    .appendField(new Blockly.FieldNumber(1000, 1), "SUPPLY");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(230);
            }
        };

        // Crear workspace
        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: `
                <xml>
                    <category name="üöÄ Empezar">
                        <block type="contract_settings"></block>
                    </category>
                    <category name="üé® Propiedades">
                        <block type="token_name"></block>
                        <block type="token_symbol"></block>
                        <block type="initial_supply"></block>
                    </category>
                </xml>
            `,
            scrollbars: true,
            trashcan: true
        });

        function testBlocks() {
            workspace.clear();

            // Crear bloques
            const contractBlock = workspace.newBlock('contract_settings');
            contractBlock.moveBy(50, 50);

            const nameBlock = workspace.newBlock('token_name');
            nameBlock.setFieldValue('Mi Token M√°gico', 'NAME');
            nameBlock.moveBy(50, 120);

            const symbolBlock = workspace.newBlock('token_symbol');
            symbolBlock.setFieldValue('MAGIC', 'SYMBOL');
            symbolBlock.moveBy(50, 180);

            const supplyBlock = workspace.newBlock('initial_supply');
            supplyBlock.setFieldValue('1000', 'SUPPLY');
            supplyBlock.moveBy(50, 240);

            // Conectar bloques
            try {
                const settingsInput = contractBlock.getInput('SETTINGS');
                if (settingsInput && settingsInput.connection) {
                    settingsInput.connection.connect(nameBlock.outputConnection);
                }

                if (nameBlock.nextConnection && symbolBlock.previousConnection) {
                    nameBlock.nextConnection.connect(symbolBlock.previousConnection);
                }

                if (symbolBlock.nextConnection && supplyBlock.previousConnection) {
                    symbolBlock.nextConnection.connect(supplyBlock.previousConnection);
                }

                workspace.render();
                document.getElementById('output').innerHTML = '<p style="color: green;">‚úÖ Bloques creados y conectados correctamente</p>';
            } catch (error) {
                document.getElementById('output').innerHTML = '<p style="color: red;">‚ùå Error: ' + error.message + '</p>';
            }
        }

        function readData() {
            const contractBlock = workspace.getBlocksByType('contract_settings', false)[0];
            if (!contractBlock) {
                document.getElementById('output').innerHTML = '<p style="color: red;">‚ùå No hay bloque de contrato</p>';
                return;
            }

            const data = {};
            let currentBlock = contractBlock.getInputTargetBlock('SETTINGS');

            while (currentBlock) {
                switch (currentBlock.type) {
                    case 'token_name':
                        data.name = currentBlock.getFieldValue('NAME');
                        break;
                    case 'token_symbol':
                        data.symbol = currentBlock.getFieldValue('SYMBOL');
                        break;
                    case 'initial_supply':
                        data.supply = currentBlock.getFieldValue('SUPPLY');
                        break;
                }
                currentBlock = currentBlock.getNextBlock();
            }

            document.getElementById('output').innerHTML =
                '<p><strong>Datos le√≠dos:</strong></p>' +
                '<ul>' +
                '<li>Nombre: ' + (data.name || 'No encontrado') + '</li>' +
                '<li>S√≠mbolo: ' + (data.symbol || 'No encontrado') + '</li>' +
                '<li>Suministro: ' + (data.supply || 'No encontrado') + '</li>' +
                '</ul>';
        }

        // Crear bloques autom√°ticamente al cargar
        testBlocks();
    </script>
</body>

</html>