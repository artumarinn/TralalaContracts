<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tralalero Contracts - Crea tu Token paso a paso</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Schabo+Condensed:wght@400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="main-container">
        <!-- Grid Pattern Background -->
        <div id="gridBackground" class="grid-background"></div>

        <!-- Header -->
        <div class="header">
            <div class="logo-container">
                <video src="/tralala.mp4" alt="Tralalero Contracts Video Logo" class="logo" autoplay muted loop
                    playsinline></video>
                <h1 class="title">
                    <span class="title-line1">TRALALA</span>
                    <span class="title-line2">CONTRACTS</span>
                </h1>
            </div>
        </div>
        <!-- Stepper Container -->
        <div class="stepper-container">
            <!-- Stepper Progress -->
            <div class="stepper">
                <div class="stepper-line" id="stepperLine"></div>
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Conectar Wallet</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Configurar Token</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Configurar Smart Contract</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Revisar y Desplegar</div>
                </div>
            </div>

            <!-- Step Content -->
            <div class="step-content active" id="step1">
                <div class="wallets-container">
                    <div class="description-box">
                        <h2 class="wallets-title">Conecta tu billetera y empieza a construir tu smart contract</h2>
                    </div>
                    <div class="wallet-options">
                        <div class="wallet-option" id="connectFreighter">
                            <div class="wallet-icon">ü¶ä</div>
                            <div class="wallet-label">Freighter</div>
                        </div>
                        <div class="wallet-option" id="connectXbull">
                            <div class="wallet-icon">üêÇ</div>
                            <div class="wallet-label">xBull</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Token Configuration -->
            <div class="step-content" id="step2">
                <div class="blockly-container">
                    <div class="description-box">
                        <h2 class="wallets-title">¬°Arrastra y conecta los bloques!</h2>
                        <p class="wallets-title">Usa los bloques de la izquierda para configurar tu token. <br />
                            Arrastra el bloque "üîÆ Mi
                            Contrato
                            M√°gico" y conecta los bloques de propiedades debajo.</p>
                    </div>
                    <div id="blocklyDiv"></div>
                </div>
            </div>

            <!-- Step 3: Smart Contract Configuration -->
            <div class="step-content" id="step3">
                <div class="smart-contract-container">
                    <div class="description-box">
                        <h2 class="wallets-title">‚öôÔ∏è Configuraci√≥n Avanzada del Smart Contract</h2>
                        <p class="wallets-title">Configura las caracter√≠sticas avanzadas de tu smart contract. ¬°Arrastra
                            m√°s bloques para a√±adir funcionalidades!</p>
                    </div>

                    <!-- Preview del C√≥digo -->
                    <div class="code-preview-section">
                        <div class="preview-header">
                            <h3>üìã Vista Previa del C√≥digo</h3>
                            <div class="preview-actions">
                                <button class="btn btn-secondary" id="refreshPreview">üîÑ Actualizar</button>
                                <button class="btn btn-secondary" id="validateContract">‚úÖ Validar</button>
                                <button class="btn btn-secondary" id="viewFullCode">üëÅÔ∏è Ver C√≥digo Completo</button>
                            </div>
                        </div>
                        <div class="code-preview" id="codePreview">
                            <pre
                                id="contractPreview">// El c√≥digo se generar√° autom√°ticamente cuando configures los bloques...</pre>
                        </div>
                        <div class="validation-result hidden" id="validationResult">
                            <div id="validationMessage"></div>
                        </div>
                    </div>

                    <!-- Interfaz de Blockly Expandida -->
                    <div class="blockly-advanced-container">
                        <div id="blocklyDiv"></div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Review and Deploy -->
            <div class="step-content" id="step4">
                <div class="create-token-container">
                    <h2 class="step-title">üöÄ Revisa y despliega tu Smart Contract</h2>

                    <!-- Resumen del Contrato -->
                    <div class="contract-summary" id="contractSummary">
                        <h3>üìÑ Resumen del Contrato</h3>
                        <div class="summary-grid" id="summaryGrid">
                            <div class="summary-item">
                                <strong>Tipo:</strong> <span id="summaryType">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Nombre:</strong> <span id="summaryName">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>S√≠mbolo:</strong> <span id="summarySymbol">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Cantidad Inicial:</strong> <span id="summarySupply">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Caracter√≠sticas:</strong> <span id="summaryFeatures">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Licencia:</strong> <span id="summaryLicense">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Administrador:</strong> <span id="summaryAdmin">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Red:</strong> <span id="summaryNetwork">Stellar Testnet</span>
                            </div>
                        </div>
                    </div>

                    <!-- Progreso de Despliegue -->
                    <div class="deployment-pipeline" id="deploymentPipeline">
                        <div class="pipeline-step" id="pipelineValidation">
                            <div class="step-icon">üîç</div>
                            <div class="step-info">
                                <h4>Validaci√≥n</h4>
                                <p>Verificando configuraci√≥n del contrato...</p>
                            </div>
                            <div class="step-status pending">‚è≥</div>
                        </div>

                        <div class="pipeline-step" id="pipelineCompilation">
                            <div class="step-icon">‚öôÔ∏è</div>
                            <div class="step-info">
                                <h4>Compilaci√≥n</h4>
                                <p>Generando c√≥digo Rust del smart contract...</p>
                            </div>
                            <div class="step-status pending">‚è≥</div>
                        </div>

                        <div class="pipeline-step" id="pipelineWasm">
                            <div class="step-icon">üì¶</div>
                            <div class="step-info">
                                <h4>Build WASM</h4>
                                <p>Compilando a WebAssembly optimizado...</p>
                            </div>
                            <div class="step-status pending">‚è≥</div>
                        </div>

                        <div class="pipeline-step" id="pipelineDeployment">
                            <div class="step-icon">üöÄ</div>
                            <div class="step-info">
                                <h4>Despliegue</h4>
                                <p>Desplegando a la red Stellar...</p>
                            </div>
                            <div class="step-status pending">‚è≥</div>
                        </div>
                    </div>

                    <!-- Estado de Despliegue -->
                    <div class="deployment-status hidden" id="deploymentStatus">
                        <div class="deployment-message" id="deploymentMessage">Preparando despliegue...</div>
                        <div class="deployment-progress">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                    </div>

                    <!-- Resultado del Despliegue -->
                    <div class="deployment-result hidden" id="deploymentResult">
                        <div class="result-content" id="resultContent"></div>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="stepper-navigation">
                <button class="btn btn-secondary" id="prevBtn" disabled>Anterior</button>
                <button class="btn btn-primary" id="nextBtn">Siguiente</button>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stellar/stellar-sdk@11.3.0/dist/stellar-sdk.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stellar/freighter-api@1.7.0/build/index.min.js"></script>
    <script src="https://unpkg.com/albedo-sdk@^0.10.4/dist/albedo.min.js"></script>
    <script>
        // Estado global de la aplicaci√≥n
        const appState = {
            currentStep: 1,
            totalSteps: 4,
            walletConnected: false,
            walletAddress: null,
            walletType: null,
            contractCompiled: false,
            contractValidated: false,
            tokenData: {
                // Configuraci√≥n b√°sica
                tokenType: 'SMART_CONTRACT',
                contractType: 'TOKEN',
                name: '',
                symbol: '',
                supply: 0,
                decimals: 2,
                adminAddress: '',

                // Caracter√≠sticas avanzadas
                features: {
                    mintable: false,
                    burnable: false,
                    pausable: false,
                    upgradeable: false,
                    accessControl: false,
                    governance: false,
                    stakeable: false,
                    timeLock: false,
                    multiSig: false
                },

                // Configuraci√≥n de seguridad
                security: {
                    transferLimit: 0,
                    dailyLimit: 0,
                    whitelistEnabled: false,
                    freezeable: false,
                    recoverableKeys: false
                },

                // Informaci√≥n del contrato
                metadata: {
                    securityContact: '',
                    license: 'MIT',
                    version: '1.0.0',
                    description: '',
                    website: '',
                    logoUrl: ''
                },

                // Configuraci√≥n avanzada
                economics: {
                    transactionFee: 0,
                    burnRate: 0,
                    stakingReward: 0,
                    inflationRate: 0
                },

                // Backward compatibility
                initialSupply: 0
            }
        };

        // Variable global para el workspace de Blockly
        let blocklyWorkspace = null;

        // Elementos del DOM
        const elements = {
            stepper: document.querySelector('.stepper'),
            stepperLine: document.getElementById('stepperLine'),
            steps: document.querySelectorAll('.step'),
            stepContents: document.querySelectorAll('.step-content'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),

            // Summary elements
            tokenSummary: document.getElementById('tokenSummary'),
            summaryType: document.getElementById('summaryType'),
            summaryName: document.getElementById('summaryName'),
            summarySymbol: document.getElementById('summarySymbol'),
            summarySupply: document.getElementById('summarySupply'),
            summaryFeatures: document.getElementById('summaryFeatures'),
            summaryLicense: document.getElementById('summaryLicense'),
            summaryAdmin: document.getElementById('summaryAdmin'),

            // Deployment elements
            deploymentStatus: document.getElementById('deploymentStatus'),
            deploymentMessage: document.getElementById('deploymentMessage'),
            deploymentResult: document.getElementById('deploymentResult'),
            resultContent: document.getElementById('resultContent')
        };

        // Funciones del stepper
        function updateStepper() {
            // Actualizar pasos
            elements.steps.forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed');

                if (stepNumber === appState.currentStep) {
                    step.classList.add('active');
                } else if (stepNumber < appState.currentStep) {
                    step.classList.add('completed');
                }
            });

            // Actualizar contenido de pasos con transici√≥n suave
            elements.stepContents.forEach((content, index) => {
                content.classList.remove('active');
                if (index + 1 === appState.currentStep) {
                    // Peque√±o delay para permitir que la transici√≥n anterior termine
                    setTimeout(() => {
                        content.classList.add('active');
                    }, 50);
                }
            });

            // Actualizar l√≠nea de progreso con transici√≥n suave
            const progress = ((appState.currentStep - 1) / (appState.totalSteps - 1)) * 100;
            elements.stepperLine.style.transition = 'width 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            elements.stepperLine.style.width = `${progress}%`;

            // Actualizar botones
            elements.prevBtn.disabled = appState.currentStep === 1;

            if (appState.currentStep === appState.totalSteps) {
                elements.nextBtn.textContent = 'Crear Token';
            } else {
                elements.nextBtn.textContent = 'Siguiente';
            }

            // Actualizar contenido din√°mico seg√∫n el paso
            updateStepContent();
        }

        function goToStep(stepNumber) {
            if (stepNumber >= 1 && stepNumber <= appState.totalSteps) {
                appState.currentStep = stepNumber;
                updateStepper();
            }
        }

        function nextStep() {
            if (validateCurrentStep()) {
                if (appState.currentStep < appState.totalSteps) {
                    goToStep(appState.currentStep + 1);
                } else {
                    deployToken();
                }
            }
        }

        function prevStep() {
            if (appState.currentStep > 1) {
                goToStep(appState.currentStep - 1);
            }
        }

        function updateStepContent() {
            switch (appState.currentStep) {
                case 2:
                    // Inicializar Blockly cuando se llega al paso 2
                    if (!blocklyWorkspace) {
                        initializeBlockly();
                    }
                    break;
                case 3:
                    // Configuraci√≥n avanzada de smart contracts
                    if (!blocklyWorkspace) {
                        initializeBlockly();
                    }
                    updateCodePreview();
                    break;
                case 4:
                    updateTokenSummary();
                    updateDeploymentPipeline();
                    break;
            }
        }

        // Funci√≥n para actualizar el preview del c√≥digo
        function updateCodePreview() {
            const contractPreview = document.getElementById('contractPreview');
            if (!contractPreview) return;

            const blocklyData = readBlocklyData();
            if (!blocklyData || !blocklyData.name) {
                contractPreview.textContent = '// Configura los bloques para ver el preview del c√≥digo...';
                return;
            }

            const rustCode = generateAdvancedRustCode(blocklyData);
            contractPreview.textContent = rustCode;
        }

        // Funci√≥n para generar c√≥digo Rust avanzado
        function generateAdvancedRustCode(data) {
            const features = [];

            if (data.features.mintable) features.push('Mintable');
            if (data.features.burnable) features.push('Burnable');
            if (data.features.pausable) features.push('Pausable');
            if (data.features.upgradeable) features.push('Upgradeable');
            if (data.features.governance) features.push('Governance');
            if (data.features.stakeable) features.push('Stakeable');
            if (data.features.timeLock) features.push('TimeLock');
            if (data.features.accessControl) features.push('AccessControl');

            return `// Smart Contract: ${data.name || 'Mi Token'}
// Generado autom√°ticamente por Tralalero Contracts
#![no_std]

use soroban_sdk::{
    contract, contractimpl, Address, Env, String, Symbol, Map,
    token::{self, Interface as TokenInterface},
    auth::{Context, CustomAccountInterface},
    ${data.features.governance ? 'governance::GovernanceInterface,' : ''}
    ${data.features.stakeable ? 'staking::StakingInterface,' : ''}
};

// Constantes del contrato
const TOKEN_NAME: &str = "${data.name || 'Mi Token'}";
const TOKEN_SYMBOL: &str = "${data.symbol || 'TOKEN'}";
const DECIMALS: u32 = ${data.decimals || 2};
const INITIAL_SUPPLY: i128 = ${data.supply || 1000};

// Claves de almacenamiento
const ADMIN: Symbol = symbol_short!("ADMIN");
const PAUSED: Symbol = symbol_short!("PAUSED");
const TOTAL_SUPPLY: Symbol = symbol_short!("TOTAL_SUP");
${data.security.transferLimit ? `const TRANSFER_LIMIT: Symbol = symbol_short!("TRANS_LIM");` : ''}
${data.features.stakeable ? `const STAKING_POOL: Symbol = symbol_short!("STAKING");` : ''}

#[contract]
pub struct TokenContract;

#[contractimpl]
impl TokenContract {
    
    /// Inicializa el contrato con configuraci√≥n personalizada
    pub fn initialize(env: Env, admin: Address) {
        if env.storage().instance().has(&ADMIN) {
            panic!("Contract already initialized");
        }
        
        env.storage().instance().set(&ADMIN, &admin);
        env.storage().instance().set(&TOTAL_SUPPLY, &INITIAL_SUPPLY);
        ${data.features.pausable ? 'env.storage().instance().set(&PAUSED, &false);' : ''}
        ${data.security.transferLimit ? `env.storage().instance().set(&TRANSFER_LIMIT, &${data.security.transferLimit});` : ''}
        
        // Mint inicial al admin
        if INITIAL_SUPPLY > 0 {
            token::Client::new(&env, &env.current_contract_address())
                .mint(&admin, &INITIAL_SUPPLY);
        }
    }

    /// Metadata del token
    pub fn name(env: Env) -> String {
        String::from_str(&env, TOKEN_NAME)
    }
    
    pub fn symbol(env: Env) -> String {
        String::from_str(&env, TOKEN_SYMBOL)
    }
    
    pub fn decimals(env: Env) -> u32 {
        DECIMALS
    }

    ${data.features.mintable ? `
    /// Mint nuevos tokens (solo admin)
    pub fn mint(env: Env, to: Address, amount: i128) {
        Self::check_admin(&env);
        ${data.features.pausable ? 'Self::check_not_paused(&env);' : ''}
        
        token::Client::new(&env, &env.current_contract_address())
            .mint(&to, &amount);
    }` : ''}

    ${data.features.burnable ? `
    /// Burn tokens
    pub fn burn(env: Env, from: Address, amount: i128) {
        from.require_auth();
        ${data.features.pausable ? 'Self::check_not_paused(&env);' : ''}
        
        token::Client::new(&env, &env.current_contract_address())
            .burn(&from, &amount);
    }` : ''}

    ${data.features.pausable ? `
    /// Pausar el contrato (solo admin)
    pub fn pause(env: Env) {
        Self::check_admin(&env);
        env.storage().instance().set(&PAUSED, &true);
    }
    
    /// Despausar el contrato (solo admin)
    pub fn unpause(env: Env) {
        Self::check_admin(&env);
        env.storage().instance().set(&PAUSED, &false);
    }` : ''}

    ${data.features.stakeable ? `
    /// Hacer staking de tokens
    pub fn stake(env: Env, from: Address, amount: i128) {
        from.require_auth();
        Self::check_not_paused(&env);
        
        // L√≥gica de staking...
        // TODO: Implementar pool de staking
    }` : ''}

    /// Funciones auxiliares
    fn check_admin(env: &Env) {
        let admin: Address = env.storage().instance().get(&ADMIN).unwrap();
        admin.require_auth();
    }

    ${data.features.pausable ? `
    fn check_not_paused(env: &Env) {
        let paused: bool = env.storage().instance().get(&PAUSED).unwrap_or(false);
        if paused {
            panic!("Contract is paused");
        }
    }` : ''}
}

// Caracter√≠sticas habilitadas: ${features.join(', ') || 'Ninguna'}
// L√≠mite de transferencia: ${data.security.transferLimit || 'Sin l√≠mite'}
// Recompensa de staking: ${data.economics.stakingReward || 0}% anual
// Fee de transacci√≥n: ${data.economics.transactionFee || 0}%
// Burn rate: ${data.economics.burnRate || 0}%`;
        }

        // Funci√≥n para validar el contrato
        function validateSmartContract() {
            const validationResult = document.getElementById('validationResult');
            const validationMessage = document.getElementById('validationMessage');

            if (!validationResult || !validationMessage) return false;

            const blocklyData = readBlocklyData();
            const errors = [];
            const warnings = [];

            // Validaciones b√°sicas
            if (!blocklyData.name || blocklyData.name.trim() === '') {
                errors.push('‚ùå El nombre del token es requerido');
            }

            if (!blocklyData.symbol || blocklyData.symbol.trim() === '') {
                errors.push('‚ùå El s√≠mbolo del token es requerido');
            }

            if (!blocklyData.supply || blocklyData.supply <= 0) {
                errors.push('‚ùå El suministro inicial debe ser mayor a 0');
            }

            // Validaciones avanzadas
            if (blocklyData.features.stakeable && !blocklyData.economics.stakingReward) {
                warnings.push('‚ö†Ô∏è Staking habilitado pero sin recompensa definida');
            }

            if (blocklyData.features.governance && !blocklyData.features.accessControl) {
                warnings.push('‚ö†Ô∏è Governance sin control de acceso puede ser inseguro');
            }

            if (blocklyData.economics.transactionFee > 10) {
                warnings.push('‚ö†Ô∏è Fee de transacci√≥n muy alto (>10%)');
            }

            if (blocklyData.economics.burnRate > 5) {
                warnings.push('‚ö†Ô∏è Burn rate muy alto (>5%)');
            }

            // Mostrar resultados
            validationResult.classList.remove('hidden');

            if (errors.length > 0) {
                validationMessage.innerHTML = `
                    <div style="color: #dc2626; font-weight: bold;">‚ùå Errores encontrados:</div>
                    ${errors.map(error => `<div style="margin: 0.5rem 0;">${error}</div>`).join('')}
                `;
                validationResult.style.backgroundColor = '#fef2f2';
                validationResult.style.borderColor = '#dc2626';
                appState.contractValidated = false;
                return false;
            } else {
                let message = '<div style="color: #059669; font-weight: bold;">‚úÖ Contrato v√°lido!</div>';

                if (warnings.length > 0) {
                    message += `
                        <div style="color: #d97706; font-weight: bold; margin-top: 1rem;">‚ö†Ô∏è Advertencias:</div>
                        ${warnings.map(warning => `<div style="margin: 0.5rem 0;">${warning}</div>`).join('')}
                    `;
                }

                validationMessage.innerHTML = message;
                validationResult.style.backgroundColor = warnings.length > 0 ? '#fffbeb' : '#f0fdf4';
                validationResult.style.borderColor = warnings.length > 0 ? '#d97706' : '#059669';
                appState.contractValidated = true;
                return true;
            }
        }

        // Funci√≥n para actualizar el pipeline de despliegue
        function updateDeploymentPipeline() {
            const pipeline = document.getElementById('deploymentPipeline');
            if (!pipeline) return;

            // Resetear estados
            const steps = pipeline.querySelectorAll('.pipeline-step');
            steps.forEach(step => {
                const status = step.querySelector('.step-status');
                status.className = 'step-status pending';
                status.textContent = '‚è≥';
            });

            // Marcar validaci√≥n como completada si est√° validado
            if (appState.contractValidated) {
                const validationStep = document.getElementById('pipelineValidation');
                if (validationStep) {
                    const status = validationStep.querySelector('.step-status');
                    status.className = 'step-status completed';
                    status.textContent = '‚úÖ';
                }
            }
        }

        // Funci√≥n para actualizar un paso espec√≠fico del pipeline
        async function updatePipelineStep(stepId, status, message) {
            const step = document.getElementById(stepId);
            if (!step) return;

            const stepStatus = step.querySelector('.step-status');
            const stepInfo = step.querySelector('.step-info p');

            // Remover clases anteriores
            step.className = 'pipeline-step';
            stepStatus.className = 'step-status';

            // A√±adir nueva clase y actualizar contenido
            step.classList.add(status);
            stepStatus.classList.add(status);

            switch (status) {
                case 'active':
                    stepStatus.textContent = 'üîÑ';
                    step.style.animation = 'pulse 1.5s infinite';
                    break;
                case 'completed':
                    stepStatus.textContent = '‚úÖ';
                    step.style.animation = 'none';
                    break;
                case 'error':
                    stepStatus.textContent = '‚ùå';
                    step.style.animation = 'none';
                    break;
                default:
                    stepStatus.textContent = '‚è≥';
                    step.style.animation = 'none';
            }

            if (message && stepInfo) {
                stepInfo.textContent = message;
            }

            // Peque√±a animaci√≥n para mostrar progreso
            if (status === 'completed') {
                step.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    step.style.transform = 'scale(1)';
                }, 300);
            }
        }

        // Funciones de Blockly
        function initializeBlockly() {
            if (typeof Blockly === 'undefined') {
                console.error('Blockly no est√° cargado');
                return;
            }

            // Definir bloques personalizados
            Blockly.Blocks['contract_settings'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üîÆ Mi Contrato M√°gico");
                    this.appendStatementInput("SETTINGS")
                        .setCheck(null);
                    this.setColour(290);
                    this.setTooltip("Bloque principal del contrato");
                }
            };

            Blockly.Blocks['token_name'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("Nombre de la moneda")
                        .appendField(new Blockly.FieldTextInput("Mi Tesoro"), "NAME");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(190);
                    this.setTooltip("Define el nombre de tu token");
                }
            };

            Blockly.Blocks['token_symbol'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("S√≠mbolo (dibujito)")
                        .appendField(new Blockly.FieldTextInput("ORO"), "SYMBOL");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(190);
                    this.setTooltip("Define el s√≠mbolo corto de tu token");
                }
            };

            Blockly.Blocks['initial_supply'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üí∞ Cantidad inicial de monedas")
                        .appendField(new Blockly.FieldNumber(1000, 1), "SUPPLY");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(230);
                    this.setTooltip("Define cu√°ntas monedas se crear√°n inicialmente");
                }
            };

            // Bloques de tipo de token
            Blockly.Blocks['token_type'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üéØ Tipo de token")
                        .appendField(new Blockly.FieldDropdown([
                            ["Fungible", "FUNGIBLE"],
                            ["NonFungible", "NON_FUNGIBLE"],
                            ["Stablecoin", "STABLECOIN"]
                        ]), "TYPE");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                    this.setTooltip("Selecciona el tipo de token que quieres crear");
                }
            };

            // Bloques de caracter√≠sticas b√°sicas
            Blockly.Blocks['feature_mintable'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("‚ö° Mintable")
                        .appendField(new Blockly.FieldCheckbox("FALSE"), "ENABLED");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(120);
                    this.setTooltip("Permite crear m√°s tokens despu√©s del despliegue");
                }
            };

            Blockly.Blocks['feature_burnable'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üî• Burnable")
                        .appendField(new Blockly.FieldCheckbox("FALSE"), "ENABLED");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(120);
                    this.setTooltip("Permite quemar tokens para reducir el suministro");
                }
            };

            Blockly.Blocks['feature_pausable'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("‚è∏Ô∏è Pausable")
                        .appendField(new Blockly.FieldCheckbox("FALSE"), "ENABLED");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(120);
                    this.setTooltip("Permite pausar todas las transferencias del token");
                }
            };

            Blockly.Blocks['feature_upgradeable'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üîÑ Upgradeable")
                        .appendField(new Blockly.FieldCheckbox("FALSE"), "ENABLED");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(120);
                    this.setTooltip("Permite actualizar el contrato en el futuro");
                }
            };

            // Bloques de caracter√≠sticas avanzadas
            Blockly.Blocks['feature_governance'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üó≥Ô∏è Governance")
                        .appendField(new Blockly.FieldCheckbox("FALSE"), "ENABLED");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(120);
                    this.setTooltip("Permite votaci√≥n descentralizada para cambios");
                }
            };

            Blockly.Blocks['feature_stakeable'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("ü•© Stakeable")
                        .appendField(new Blockly.FieldCheckbox("FALSE"), "ENABLED");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(120);
                    this.setTooltip("Permite hacer staking para generar recompensas");
                }
            };

            Blockly.Blocks['feature_timelock'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("‚è∞ Time Lock")
                        .appendField(new Blockly.FieldCheckbox("FALSE"), "ENABLED")
                        .appendField("D√≠as:")
                        .appendField(new Blockly.FieldNumber(30, 1, 365), "DAYS");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(120);
                    this.setTooltip("Bloquea tokens por un per√≠odo de tiempo");
                }
            };

            // Bloques de seguridad
            Blockly.Blocks['access_control'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üîê Control de Acceso")
                        .appendField(new Blockly.FieldCheckbox("FALSE"), "ENABLED");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(80);
                    this.setTooltip("Habilita sistema de roles y permisos");
                }
            };

            Blockly.Blocks['security_transferlimit'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üö¶ L√≠mite de Transferencia")
                        .appendField(new Blockly.FieldNumber(1000, 0), "LIMIT");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(80);
                    this.setTooltip("L√≠mite m√°ximo por transferencia");
                }
            };

            Blockly.Blocks['security_whitelist'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üìã Whitelist")
                        .appendField(new Blockly.FieldCheckbox("FALSE"), "ENABLED");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(80);
                    this.setTooltip("Solo direcciones aprobadas pueden transferir");
                }
            };

            Blockly.Blocks['security_freezeable'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üßä Freezeable")
                        .appendField(new Blockly.FieldCheckbox("FALSE"), "ENABLED");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(80);
                    this.setTooltip("Permite congelar cuentas espec√≠ficas");
                }
            };

            // Bloques de econom√≠a
            Blockly.Blocks['economics_fee'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üí∞ Fee de Transacci√≥n")
                        .appendField(new Blockly.FieldNumber(0, 0, 100), "FEE")
                        .appendField("%");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(220);
                    this.setTooltip("Porcentaje de fee por cada transacci√≥n");
                }
            };

            Blockly.Blocks['economics_burnrate'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üî• Burn Rate")
                        .appendField(new Blockly.FieldNumber(0, 0, 100), "RATE")
                        .appendField("% por transacci√≥n");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(220);
                    this.setTooltip("Porcentaje de tokens quemados autom√°ticamente");
                }
            };

            Blockly.Blocks['economics_staking'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üéØ Staking Reward")
                        .appendField(new Blockly.FieldNumber(5, 0, 100), "REWARD")
                        .appendField("% anual");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(220);
                    this.setTooltip("Recompensa anual por hacer staking");
                }
            };

            // Bloques de informaci√≥n
            Blockly.Blocks['security_contact'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üìß Contacto de Seguridad")
                        .appendField(new Blockly.FieldTextInput("security@example.com"), "EMAIL");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(300);
                    this.setTooltip("Email de contacto para reportar problemas de seguridad");
                }
            };

            Blockly.Blocks['license'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üìÑ Licencia")
                        .appendField(new Blockly.FieldDropdown([
                            ["MIT", "MIT"],
                            ["GPL-3.0", "GPL-3.0"],
                            ["Apache-2.0", "Apache-2.0"],
                            ["BSD-3-Clause", "BSD-3-Clause"],
                            ["Unlicense", "Unlicense"]
                        ]), "LICENSE");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(300);
                    this.setTooltip("Tipo de licencia para tu contrato");
                }
            };

            // Crear workspace de Blockly
            blocklyWorkspace = Blockly.inject('blocklyDiv', {
                toolbox: `
                    <xml>
                        <category name="üöÄ Empezar">
                            <block type="contract_settings"></block>
                        </category>
                        <category name="‚öôÔ∏è Configuraci√≥n B√°sica">
                            <block type="token_type"></block>
                            <block type="token_name"></block>
                            <block type="token_symbol"></block>
                            <block type="initial_supply"></block>
                        </category>
                        <category name="‚ú® Caracter√≠sticas B√°sicas">
                            <block type="feature_mintable"></block>
                            <block type="feature_burnable"></block>
                            <block type="feature_pausable"></block>
                            <block type="feature_upgradeable"></block>
                        </category>
                        <category name="üéØ Caracter√≠sticas Avanzadas">
                            <block type="feature_governance"></block>
                            <block type="feature_stakeable"></block>
                            <block type="feature_timelock"></block>
                        </category>
                        <category name="üîê Seguridad">
                            <block type="access_control"></block>
                            <block type="security_transferlimit"></block>
                            <block type="security_whitelist"></block>
                            <block type="security_freezeable"></block>
                        </category>
                        <category name="üí∞ Econom√≠a">
                            <block type="economics_fee"></block>
                            <block type="economics_burnrate"></block>
                            <block type="economics_staking"></block>
                        </category>
                        <category name="üìã Informaci√≥n">
                            <block type="security_contact"></block>
                            <block type="license"></block>
                        </category>
                    </xml>
                `,
                scrollbars: true,
                trashcan: true,
                zoom: {
                    controls: true,
                    wheel: true,
                    startScale: 1.0,
                    maxScale: 3,
                    minScale: 0.3,
                    scaleSpeed: 1.2
                },
                theme: Blockly.Themes.Modern
            });

            // Crear bloques por defecto
            createDefaultBlocks();
        }

        function createDefaultBlocks() {
            if (!blocklyWorkspace) return;

            // Limpiar workspace
            blocklyWorkspace.clear();

            // Crear bloque principal
            const contractBlock = blocklyWorkspace.newBlock('contract_settings');
            contractBlock.moveBy(50, 50);

            // Crear bloques de configuraci√≥n b√°sica
            const tokenTypeBlock = blocklyWorkspace.newBlock('token_type');
            tokenTypeBlock.setFieldValue('FUNGIBLE', 'TYPE');
            tokenTypeBlock.moveBy(50, 120);

            const nameBlock = blocklyWorkspace.newBlock('token_name');
            nameBlock.setFieldValue('MyToken', 'NAME');
            nameBlock.moveBy(50, 180);

            const symbolBlock = blocklyWorkspace.newBlock('token_symbol');
            symbolBlock.setFieldValue('MTK', 'SYMBOL');
            symbolBlock.moveBy(50, 240);

            const supplyBlock = blocklyWorkspace.newBlock('initial_supply');
            supplyBlock.setFieldValue('0', 'SUPPLY');
            supplyBlock.moveBy(50, 300);

            // Crear bloques de caracter√≠sticas
            const mintableBlock = blocklyWorkspace.newBlock('feature_mintable');
            mintableBlock.setFieldValue('TRUE', 'ENABLED');
            mintableBlock.moveBy(50, 360);

            const burnableBlock = blocklyWorkspace.newBlock('feature_burnable');
            burnableBlock.setFieldValue('TRUE', 'ENABLED');
            burnableBlock.moveBy(50, 420);

            const pausableBlock = blocklyWorkspace.newBlock('feature_pausable');
            pausableBlock.setFieldValue('TRUE', 'ENABLED');
            pausableBlock.moveBy(50, 480);

            const upgradeableBlock = blocklyWorkspace.newBlock('feature_upgradeable');
            upgradeableBlock.setFieldValue('TRUE', 'ENABLED');
            upgradeableBlock.moveBy(50, 540);

            // Crear bloques de informaci√≥n
            const securityBlock = blocklyWorkspace.newBlock('security_contact');
            securityBlock.setFieldValue('security@example.com', 'EMAIL');
            securityBlock.moveBy(50, 600);

            const licenseBlock = blocklyWorkspace.newBlock('license');
            licenseBlock.setFieldValue('MIT', 'LICENSE');
            licenseBlock.moveBy(50, 660);

            // Conectar bloques autom√°ticamente
            try {
                // Inicializar todos los bloques antes de conectar
                contractBlock.initSvg();
                tokenTypeBlock.initSvg();
                nameBlock.initSvg();
                symbolBlock.initSvg();
                supplyBlock.initSvg();
                mintableBlock.initSvg();
                burnableBlock.initSvg();
                pausableBlock.initSvg();
                upgradeableBlock.initSvg();
                securityBlock.initSvg();
                licenseBlock.initSvg();

                // Conectar en cadena todos los bloques
                const settingsInput = contractBlock.getInput('SETTINGS');
                if (settingsInput && settingsInput.connection) {
                    settingsInput.connection.connect(tokenTypeBlock.previousConnection);
                }

                // Cadena de conexiones
                const blocks = [tokenTypeBlock, nameBlock, symbolBlock, supplyBlock,
                    mintableBlock, burnableBlock, pausableBlock, upgradeableBlock,
                    securityBlock, licenseBlock];

                for (let i = 0; i < blocks.length - 1; i++) {
                    if (blocks[i].nextConnection && blocks[i + 1].previousConnection) {
                        blocks[i].nextConnection.connect(blocks[i + 1].previousConnection);
                    }
                }

                blocklyWorkspace.render();
            } catch (error) {
                console.error('Error conectando bloques:', error);
            }
        }

        function readBlocklyData() {
            if (!blocklyWorkspace) {
                console.error('Blockly workspace no est√° inicializado');
                return null;
            }

            const contractBlock = blocklyWorkspace.getBlocksByType('contract_settings', false)[0];
            if (!contractBlock) {
                console.error('No se encontr√≥ bloque de contrato');
                return null;
            }

            const data = {
                // Configuraci√≥n b√°sica
                tokenType: 'FUNGIBLE',
                name: '',
                symbol: '',
                supply: 0,
                decimals: 2, // Valor por defecto
                adminAddress: appState.walletAddress || '',

                // Caracter√≠sticas
                features: {
                    mintable: false,
                    burnable: false,
                    pausable: false,
                    upgradeable: false,
                    accessControl: false
                },

                // Seguridad
                security: {
                    transferLimit: 0,
                    whitelistEnabled: false,
                    freezeable: false
                },

                // Econom√≠a
                economics: {
                    transactionFee: 0,
                    burnRate: 0,
                    stakingReward: 0
                },

                // Metadatos
                metadata: {
                    securityContact: '',
                    license: 'MIT'
                }
            };

            let currentBlock = contractBlock.getInputTargetBlock('SETTINGS');

            while (currentBlock) {
                switch (currentBlock.type) {
                    case 'token_type':
                        data.tokenType = currentBlock.getFieldValue('TYPE');
                        break;
                    case 'token_name':
                        data.name = currentBlock.getFieldValue('NAME');
                        break;
                    case 'token_symbol':
                        data.symbol = currentBlock.getFieldValue('SYMBOL');
                        break;
                    case 'initial_supply':
                        data.supply = parseInt(currentBlock.getFieldValue('SUPPLY')) || 0;
                        break;

                    // Caracter√≠sticas b√°sicas
                    case 'feature_mintable':
                        data.features.mintable = currentBlock.getFieldValue('ENABLED') === 'TRUE';
                        break;
                    case 'feature_burnable':
                        data.features.burnable = currentBlock.getFieldValue('ENABLED') === 'TRUE';
                        break;
                    case 'feature_pausable':
                        data.features.pausable = currentBlock.getFieldValue('ENABLED') === 'TRUE';
                        break;
                    case 'feature_upgradeable':
                        data.features.upgradeable = currentBlock.getFieldValue('ENABLED') === 'TRUE';
                        break;

                    // Caracter√≠sticas avanzadas
                    case 'feature_governance':
                        data.features.governance = currentBlock.getFieldValue('ENABLED') === 'TRUE';
                        break;
                    case 'feature_stakeable':
                        data.features.stakeable = currentBlock.getFieldValue('ENABLED') === 'TRUE';
                        break;
                    case 'feature_timelock':
                        data.features.timeLock = currentBlock.getFieldValue('ENABLED') === 'TRUE';
                        data.timeLockDays = parseInt(currentBlock.getFieldValue('DAYS')) || 30;
                        break;

                    // Seguridad
                    case 'access_control':
                        data.features.accessControl = currentBlock.getFieldValue('ENABLED') === 'TRUE';
                        break;
                    case 'security_transferlimit':
                        data.security.transferLimit = parseInt(currentBlock.getFieldValue('LIMIT')) || 0;
                        break;
                    case 'security_whitelist':
                        data.security.whitelistEnabled = currentBlock.getFieldValue('ENABLED') === 'TRUE';
                        break;
                    case 'security_freezeable':
                        data.security.freezeable = currentBlock.getFieldValue('ENABLED') === 'TRUE';
                        break;

                    // Econom√≠a
                    case 'economics_fee':
                        data.economics.transactionFee = parseFloat(currentBlock.getFieldValue('FEE')) || 0;
                        break;
                    case 'economics_burnrate':
                        data.economics.burnRate = parseFloat(currentBlock.getFieldValue('RATE')) || 0;
                        break;
                    case 'economics_staking':
                        data.economics.stakingReward = parseFloat(currentBlock.getFieldValue('REWARD')) || 0;
                        break;

                    // Informaci√≥n
                    case 'security_contact':
                        data.metadata.securityContact = currentBlock.getFieldValue('EMAIL');
                        break;
                    case 'license':
                        data.metadata.license = currentBlock.getFieldValue('LICENSE');
                        break;
                }
                currentBlock = currentBlock.getNextBlock();
            }

            return data;
        }

        // Validaci√≥n de pasos
        function validateCurrentStep() {
            switch (appState.currentStep) {
                case 1:
                    return validateWalletConnection();
                case 2:
                    return validateTokenData();
                case 3:
                    return true; // El paso 3 no requiere validaci√≥n adicional
                default:
                    return true;
            }
        }

        function validateWalletConnection() {
            if (!appState.walletConnected) {
                showToast('Por favor, conecta tu wallet primero', 'error');
                return false;
            }
            return true;
        }

        function validateTokenData() {
            // Leer datos de Blockly
            const blocklyData = readBlocklyData();
            if (!blocklyData) {
                showToast('Por favor, configura tu token usando los bloques', 'error');
                return false;
            }

            let isValid = true;

            // Validar nombre del token
            const tokenName = blocklyData.name.trim();
            if (!tokenName) {
                showToast('El nombre del token es requerido', 'error');
                isValid = false;
            } else if (tokenName.length < 3) {
                showToast('El nombre debe tener al menos 3 caracteres', 'error');
                isValid = false;
            } else {
                appState.tokenData.name = tokenName;
            }

            // Validar s√≠mbolo del token
            const tokenSymbol = blocklyData.symbol.trim().toUpperCase();
            if (!tokenSymbol) {
                showToast('El s√≠mbolo del token es requerido', 'error');
                isValid = false;
            } else if (tokenSymbol.length > 12) {
                showToast('El s√≠mbolo no puede tener m√°s de 12 caracteres', 'error');
                isValid = false;
            } else if (!/^[A-Z0-9]+$/.test(tokenSymbol)) {
                showToast('El s√≠mbolo solo puede contener letras may√∫sculas y n√∫meros', 'error');
                isValid = false;
            } else {
                appState.tokenData.symbol = tokenSymbol;
            }

            // Validar cantidad inicial
            const initialSupply = blocklyData.supply;
            if (!initialSupply || initialSupply <= 0) {
                showToast('La cantidad inicial debe ser mayor a 0', 'error');
                isValid = false;
            } else {
                appState.tokenData.initialSupply = initialSupply;
            }

            // Actualizar todos los datos de Blockly en appState
            if (isValid) {
                appState.tokenData = { ...appState.tokenData, ...blocklyData };
                appState.tokenData.adminAddress = appState.walletAddress;
            }

            return isValid;
        }

        function updateTokenSummary() {
            // Leer datos actuales de Blockly
            const blocklyData = readBlocklyData();
            if (!blocklyData) return;

            // Actualizar el appState con los datos de Blockly
            appState.tokenData = { ...appState.tokenData, ...blocklyData };

            // Actualizar elementos del resumen
            if (elements.summaryType) {
                const typeLabels = { 'FUNGIBLE': 'Fungible', 'NON_FUNGIBLE': 'No Fungible', 'STABLECOIN': 'Stablecoin' };
                elements.summaryType.textContent = typeLabels[blocklyData.tokenType] || blocklyData.tokenType;
            }
            if (elements.summaryName) elements.summaryName.textContent = blocklyData.name || '-';
            if (elements.summarySymbol) elements.summarySymbol.textContent = blocklyData.symbol || '-';
            if (elements.summarySupply) elements.summarySupply.textContent = blocklyData.supply ? blocklyData.supply.toLocaleString() : '-';

            // Mostrar caracter√≠sticas habilitadas
            if (elements.summaryFeatures) {
                const enabledFeatures = [];
                if (blocklyData.features.mintable) enabledFeatures.push('Mintable');
                if (blocklyData.features.burnable) enabledFeatures.push('Burnable');
                if (blocklyData.features.pausable) enabledFeatures.push('Pausable');
                if (blocklyData.features.upgradeable) enabledFeatures.push('Upgradeable');
                if (blocklyData.features.accessControl) enabledFeatures.push('Control de Acceso');

                elements.summaryFeatures.textContent = enabledFeatures.length > 0 ? enabledFeatures.join(', ') : 'Ninguna';
            }

            if (elements.summaryLicense) elements.summaryLicense.textContent = blocklyData.license || '-';
            if (elements.summaryAdmin) elements.summaryAdmin.textContent = appState.walletAddress ? appState.walletAddress.substring(0, 8) + '...' + appState.walletAddress.substring(appState.walletAddress.length - 8) : '-';
        }

        // Funciones de utilidad
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function hideError(elementId) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
            }
        }

        function showToast(message, type = 'info') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                color: white;
                font-weight: 500;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;

            if (type === 'success') {
                toast.style.background = '#10b981';
            } else if (type === 'error') {
                toast.style.background = '#dc2626';
            } else {
                toast.style.background = '#6366f1';
            }

            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        // Funciones de conexi√≥n de wallet
        async function connectWallet(walletType) {
            try {
                showToast('Conectando wallet...', 'info');

                let address;

                if (walletType === 'Freighter') {
                    if (!window.freighterApi) {
                        // Redirigir a la p√°gina de instalaci√≥n de Freighter
                        window.open('https://freighter.app/', '_blank');
                        showToast('Freighter no est√° instalado. Abriendo p√°gina de instalaci√≥n...', 'info');
                        return;
                    }

                    address = await window.freighterApi.getPublicKey();
                    appState.walletType = 'Freighter';
                } else if (walletType === 'Albedo') {
                    if (!(window.albedo && window.albedo.publicKey)) {
                        window.open('https://albedo.link/', '_blank');
                        showToast('Albedo no est√° instalado/disponible. Abriendo p√°gina...', 'info');
                        return;
                    }
                    const res = await window.albedo.publicKey({
                        // Albedo funciona sin extensi√≥n, solicitar clave p√∫blica
                        intent: 'public_key'
                    });
                    address = res.pubkey;
                    appState.walletType = 'Albedo';
                } else if (walletType === 'xBull') {
                    if (!window.xBullApi) {
                        // Redirigir a la p√°gina de instalaci√≥n de xBull
                        window.open('https://xbull.app/', '_blank');
                        showToast('xBull no est√° instalado. Abriendo p√°gina de instalaci√≥n...', 'info');
                        return;
                    }
                    // Implementar conexi√≥n con xBull cuando est√© disponible
                    throw new Error('xBull wallet no est√° disponible en este momento');
                } else if (walletType === 'Rabet') {
                    if (!window.rabetApi) {
                        // Redirigir a la p√°gina de instalaci√≥n de Rabet
                        window.open('https://rabet.io/', '_blank');
                        showToast('Rabet no est√° instalado. Abriendo p√°gina de instalaci√≥n...', 'info');
                        return;
                    }
                    // Implementar conexi√≥n con Rabet cuando est√© disponible
                    throw new Error('Rabet wallet no est√° disponible en este momento');
                } else {
                    throw new Error(`${walletType} wallet no est√° disponible en este momento`);
                }

                appState.walletConnected = true;
                appState.walletAddress = address;

                showToast('Wallet conectado exitosamente', 'success');

                // Navegar autom√°ticamente al siguiente paso con transici√≥n suave
                setTimeout(() => {
                    nextStep();
                }, 800);

            } catch (error) {
                console.error('Error conectando wallet:', error);
                showToast(`Error conectando wallet: ${error.message}`, 'error');
            }
        }

        // Funci√≥n de despliegue mejorada con pipeline
        async function deployToken() {
            try {
                // Validar antes de empezar
                if (!validateSmartContract()) {
                    showToast('‚ùå Valida el contrato antes de desplegarlo', 'error');
                    return;
                }

                // Ocultar summary y mostrar pipeline
                const contractSummary = document.getElementById('contractSummary');
                const deploymentPipeline = document.getElementById('deploymentPipeline');

                if (contractSummary) contractSummary.style.display = 'none';
                if (deploymentPipeline) deploymentPipeline.style.display = 'block';

                elements.nextBtn.disabled = true;
                elements.prevBtn.disabled = true;

                await updatePipelineStep('pipelineValidation', 'active', 'Validando configuraci√≥n del contrato...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                await updatePipelineStep('pipelineValidation', 'completed', 'Configuraci√≥n validada correctamente');

                // Paso 1: Compilaci√≥n del Smart Contract
                await updatePipelineStep('pipelineCompilation', 'active', 'Generando c√≥digo Rust del smart contract...');

                const blocklyData = readBlocklyData();
                const rustCode = generateAdvancedRustCode(blocklyData);

                console.log('üîß Compilando Smart Contract:');
                console.log('   Nombre:', blocklyData.name);
                console.log('   Caracter√≠sticas:', Object.keys(blocklyData.features).filter(f => blocklyData.features[f]));

                // Simular tiempo de compilaci√≥n
                await new Promise(resolve => setTimeout(resolve, 2000));
                await updatePipelineStep('pipelineCompilation', 'completed', 'Smart contract compilado exitosamente');
                appState.contractCompiled = true;

                // Paso 2: Build WASM
                await updatePipelineStep('pipelineWasm', 'active', 'Compilando a WebAssembly optimizado...');

                // Simular compilaci√≥n WASM
                await new Promise(resolve => setTimeout(resolve, 2500));
                await updatePipelineStep('pipelineWasm', 'completed', 'WASM optimizado generado');

                // Paso 3: Despliegue a la red
                await updatePipelineStep('pipelineDeployment', 'active', 'Desplegando a la red Stellar...');

                console.log('üöÄ Datos del Smart Contract para despliegue:');
                console.log('   code:', blocklyData.symbol);
                console.log('   amount:', blocklyData.supply);
                console.log('   userAddress:', appState.walletAddress);
                console.log('   features:', blocklyData.features);
                console.log('   security:', blocklyData.security);
                console.log('   economics:', blocklyData.economics);

                const response = await fetch('/api/build-smart-contract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        // Datos b√°sicos del token
                        code: blocklyData.symbol,
                        amount: blocklyData.supply,
                        userAddress: appState.walletAddress,

                        // Datos del smart contract
                        contractData: {
                            name: blocklyData.name,
                            symbol: blocklyData.symbol,
                            decimals: blocklyData.decimals || 2,
                            supply: blocklyData.supply,
                            features: blocklyData.features,
                            security: blocklyData.security,
                            economics: blocklyData.economics,
                            metadata: blocklyData.metadata,
                            rustCode: rustCode
                        }
                    }),
                });

                let result;
                if (response.ok) {
                    result = await response.json();
                } else {
                    // Fallback al endpoint original si el nuevo no existe a√∫n
                    console.log('‚ö†Ô∏è Endpoint de smart contract no disponible, usando fallback...');
                    const fallbackResponse = await fetch('/api/build-transaction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            code: blocklyData.symbol,
                            amount: blocklyData.supply,
                            userAddress: appState.walletAddress,
                            tokenData: blocklyData
                        }),
                    });

                    if (!fallbackResponse.ok) {
                        const errorText = await fallbackResponse.text();
                        throw new Error(`Error del servidor: ${errorText}`);
                    }

                    result = await fallbackResponse.json();
                }

                if (!result.success) {
                    throw new Error(result.details || 'Error desconocido del servidor');
                }

                // Paso 4: Verificar si se despleg√≥ autom√°ticamente o compil√≥ solamente
                const isDeployed = result.deployment.status === 'deployed';
                const stepMessage = isDeployed ?
                    'Smart contract desplegado exitosamente' :
                    'Smart contract compilado - Deployment manual disponible';

                await updatePipelineStep('pipelineDeployment', 'active', stepMessage);

                console.log('üéâ Smart contract:', result.smartContract.contractName);
                console.log('üì¶ WASM size:', result.wasmSize, 'bytes');
                console.log('üìÅ WASM path:', result.smartContract.wasmPath);

                if (isDeployed) {
                    console.log('üöÄ Direcci√≥n del contrato:', result.smartContract.contractAddress);
                } else {
                    console.log('‚ö†Ô∏è Deployment manual requerido');
                }

                // Finalizar proceso seg√∫n el estado del deployment
                const finalMessage = isDeployed ?
                    'Finalizando deployment...' :
                    'Finalizando compilaci√≥n...';

                await updatePipelineStep('pipelineDeployment', 'active', finalMessage);

                // Crear resultado con informaci√≥n real del deployment
                const processResult = {
                    hash: isDeployed ?
                        result.smartContract.contractAddress :
                        'compiled_' + result.contractId.slice(0, 16),
                    successful: true,
                    result_code: isDeployed ? 'DEPLOYMENT_SUCCESS' : 'COMPILATION_SUCCESS',
                    contract_id: result.contractId,
                    contract_address: result.smartContract.contractAddress,
                    deployed: isDeployed,
                    deployment_instructions: result.deployment.deploymentInstructions
                };

                const logMessage = isDeployed ?
                    `‚úÖ Smart Contract desplegado exitosamente: ${processResult.hash}` :
                    `‚úÖ Smart Contract compilado exitosamente: ${processResult.hash}`;

                console.log(logMessage);

                // Completar el pipeline
                const completionMessage = isDeployed ?
                    'Smart Contract desplegado exitosamente' :
                    'Smart Contract compilado exitosamente';

                await updatePipelineStep('pipelineDeployment', 'completed', completionMessage);

                // Mostrar resultado final
                setTimeout(() => {
                    showDeploymentSuccess(result, processResult, blocklyData);
                }, 1000);

            } catch (error) {
                console.error('‚ùå Error desplegando Smart Contract:', error);

                // Marcar paso actual como error
                const activeStep = document.querySelector('.pipeline-step.active');
                if (activeStep) {
                    const stepId = activeStep.id;
                    await updatePipelineStep(stepId, 'error', `Error: ${error.message}`);
                }

                showToast(`‚ùå Error desplegando contrato: ${error.message}`, 'error');

                // Re-habilitar botones
                elements.nextBtn.disabled = false;
                elements.prevBtn.disabled = false;
            }
        }

        // Funci√≥n para mostrar las instrucciones de deployment
        function showDeploymentInstructions(instructions) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            let stepsHtml = '';
            if (instructions.setupSteps && Array.isArray(instructions.setupSteps)) {
                stepsHtml = instructions.setupSteps.map((step, index) =>
                    `<div style="margin: 0.5rem 0;">
                        <strong>${index + 1}.</strong> 
                        <code style="background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-family: monospace;">${step}</code>
                    </div>`
                ).join('');
            }

            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 1rem 0; color: #1f2937;">üìã Instrucciones de Deployment</h3>
                    <p style="margin: 0 0 1rem 0; color: #6b7280;">Para desplegar tu smart contract, ejecuta estos comandos en orden:</p>
                    
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0;">
                        ${stepsHtml}
                    </div>
                    
                    <div style="background: #eff6ff; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0;">
                        <p style="margin: 0; color: #1e40af; font-size: 0.9rem;">
                            <strong>‚ÑπÔ∏è Explicaci√≥n de los comandos:</strong><br>
                            1. <strong>generate</strong>: Crea una nueva identity para firmar transacciones<br>
                            2. <strong>fund</strong>: Solicita XLM gratuitos para la testnet<br>
                            3. <strong>deploy</strong>: Despliega el smart contract a la red
                        </p>
                    </div>
                    
                    <p style="margin: 1rem 0 0 0; color: #6b7280; font-size: 0.9rem;">
                        <strong>Instalaci√≥n de Stellar CLI:</strong> 
                        <a href="${instructions.setupGuide || 'https://developers.stellar.org/docs/build/smart-contracts/getting-started/setup'}" target="_blank" style="color: #3b82f6;">Ver gu√≠a oficial</a>
                        <br><br>
                        <strong>Alternativa:</strong> 
                        <a href="${instructions.stellarLaboratory || 'https://laboratory.stellar.org/'}" target="_blank" style="color: #3b82f6;">Usar Stellar Laboratory</a>
                    </p>
                    
                    <button onclick="this.parentElement.parentElement.remove()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; margin-top: 1rem; font-weight: 600;">Entendido</button>
                </div>
            `;

            document.body.appendChild(modal);

            // Cerrar al hacer click fuera del modal
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Funci√≥n para mostrar el resultado exitoso del despliegue
        function showDeploymentSuccess(result, submitResult, contractData) {
            const deploymentPipeline = document.getElementById('deploymentPipeline');
            const deploymentResult = document.getElementById('deploymentResult');

            if (deploymentPipeline) deploymentPipeline.style.display = 'none';
            if (deploymentResult) {
                deploymentResult.classList.remove('hidden');

                const features = Object.keys(contractData.features || {})
                    .filter(f => contractData.features[f])
                    .map(f => {
                        const names = {
                            'mintable': 'Mintable',
                            'burnable': 'Burnable',
                            'pausable': 'Pausable',
                            'upgradeable': 'Upgradeable',
                            'governance': 'Governance',
                            'stakeable': 'Stakeable',
                            'timeLock': 'Time Lock',
                            'accessControl': 'Control de Acceso'
                        };
                        return names[f] || f;
                    }).join(', ');

                elements.resultContent.innerHTML = `
                    <div style="text-align: center; max-width: 600px; margin: 0 auto;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üéâ</div>
                        <h2 style="color: #10b981; margin-bottom: 1rem;">${submitResult.deployed ? '¬°Smart Contract Desplegado Exitosamente!' : '¬°Smart Contract Compilado Exitosamente!'}</h2>
                        
                        <div style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; text-align: left;">
                            <h3 style="margin: 0 0 1rem 0; color: #059669;">üìÑ Detalles del Contrato</h3>
                            <div style="display: grid; gap: 0.75rem;">
                                <div><strong>Nombre:</strong> ${contractData.name}</div>
                                <div><strong>S√≠mbolo:</strong> ${result.smartContract?.tokenSymbol || contractData.symbol}</div>
                                <div><strong>Contrato ID:</strong> ${result.smartContract?.contractId || 'Generado'}</div>
                                ${submitResult.deployed ? `<div><strong>Direcci√≥n del Contrato:</strong> <code style="font-size: 0.8rem; background: #dcfce7; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">${submitResult.contract_address}</code></div>` : ''}
                                <div><strong>WASM Size:</strong> ${result.wasmSize ? `${Math.round(result.wasmSize / 1024)} KB` : 'N/A'}</div>
                                <div><strong>Template:</strong> ${result.smartContract?.templateUsed || 'Avanzado'}</div>
                                <div><strong>Suministro Inicial:</strong> ${(contractData.supply || 0).toLocaleString()}</div>
                                <div><strong>Caracter√≠sticas:</strong> ${features || 'Smart Contract B√°sico'}</div>
                                <div><strong>${submitResult.deployed ? 'Hash de Deployment' : 'Hash de Compilaci√≥n'}:</strong> <code style="font-size: 0.8rem; background: #dcfce7; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">${submitResult.hash}</code></div>
                                <div><strong>Estado:</strong> <span style="color: ${submitResult.deployed ? '#059669' : '#d97706'}; font-weight: 600;">${submitResult.deployed ? '‚úÖ Desplegado en Testnet' : '‚ö†Ô∏è Requiere Deployment Manual'}</span></div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <a href="https://github.com/stellar/soroban-cli" 
                               target="_blank" 
                               style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: #6366f1; color: white; padding: 1rem; text-decoration: none; border-radius: 0.75rem; font-weight: 600; transition: transform 0.2s;">
                                üõ†Ô∏è Soroban CLI
                            </a>
                            <a href="https://soroban.stellar.org/" 
                               target="_blank" 
                               style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: #10b981; color: white; padding: 1rem; text-decoration: none; border-radius: 0.75rem; font-weight: 600; transition: transform 0.2s;">
                                üìö Docs Soroban
                            </a>
                            ${!submitResult.deployed ? `<button onclick="showDeploymentInstructions(${JSON.stringify(result.deployment?.deploymentInstructions || {}).replace(/"/g, '&quot;')})" 
                                    style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: #f59e0b; color: white; padding: 1rem; border: none; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: transform 0.2s;">
                                üìã Ver Instrucciones
                            </button>` : ''}
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 2rem;">
                            <button onclick="window.location.reload()" 
                                    style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: #6b7280; color: white; padding: 1rem; border: none; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: transform 0.2s;">
                                üîÑ Crear Otro Contrato
                            </button>
                        </div>
                        
                        <div style="background: #eff6ff; border-radius: 0.75rem; padding: 1rem; font-size: 0.9rem; color: #1e40af;">
                            <strong>üí° Pr√≥ximos pasos:</strong><br>
                            ‚Ä¢ Guarda la direcci√≥n del emisor para futuras interacciones<br>
                            ‚Ä¢ Configura tu wallet para ver el nuevo token<br>
                            ‚Ä¢ Comparte el contrato con tu comunidad
                        </div>
                    </div>
                `;
            }

            showToast('üéâ ¬°Smart Contract desplegado exitosamente!', 'success');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Botones de navegaci√≥n
            elements.nextBtn.addEventListener('click', nextStep);
            elements.prevBtn.addEventListener('click', prevStep);

            // Botones de conexi√≥n de wallet
            document.getElementById('connectFreighter').addEventListener('click', () => connectWallet('Freighter'));
            document.getElementById('connectXbull').addEventListener('click', () => connectWallet('xBull'));
            document.getElementById('connectAlbedo').addEventListener('click', () => connectWallet('Albedo'));
            document.getElementById('connectRabet').addEventListener('click', () => connectWallet('Rabet'));

            // Botones de preview y validaci√≥n
            const refreshPreviewBtn = document.getElementById('refreshPreview');
            if (refreshPreviewBtn) {
                refreshPreviewBtn.addEventListener('click', updateCodePreview);
            }

            const validateContractBtn = document.getElementById('validateContract');
            if (validateContractBtn) {
                validateContractBtn.addEventListener('click', () => {
                    const isValid = validateSmartContract();
                    if (isValid) {
                        showToast('‚úÖ Contrato validado correctamente', 'success');
                    } else {
                        showToast('‚ùå Se encontraron errores en el contrato', 'error');
                    }
                });
            }

            const viewFullCodeBtn = document.getElementById('viewFullCode');
            if (viewFullCodeBtn) {
                viewFullCodeBtn.addEventListener('click', () => {
                    const blocklyData = readBlocklyData();
                    if (blocklyData && blocklyData.name) {
                        const fullCode = generateAdvancedRustCode(blocklyData);

                        // Crear modal para mostrar c√≥digo completo
                        const modal = document.createElement('div');
                        modal.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0,0,0,0.8);
                            z-index: 1000;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            padding: 2rem;
                        `;

                        modal.innerHTML = `
                            <div style="background: white; border-radius: 1rem; padding: 2rem; max-width: 80%; max-height: 80%; overflow: auto;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h3>üìÑ C√≥digo Completo del Smart Contract</h3>
                                    <button id="closeCodeModal" style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">‚úï Cerrar</button>
                                </div>
                                <pre style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; overflow: auto; font-size: 0.875rem; line-height: 1.5;">${fullCode}</pre>
                                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                                    <button id="downloadCode" style="background: #6366f1; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;">üì• Descargar</button>
                                    <button id="copyCode" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;">üìã Copiar</button>
                                </div>
                            </div>
                        `;

                        document.body.appendChild(modal);

                        // Event listeners del modal
                        document.getElementById('closeCodeModal').addEventListener('click', () => {
                            modal.remove();
                        });

                        document.getElementById('downloadCode').addEventListener('click', () => {
                            const blob = new Blob([fullCode], { type: 'text/rust' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `${blocklyData.symbol || 'token'}_contract.rs`;
                            a.click();
                            URL.revokeObjectURL(url);
                            showToast('üì• C√≥digo descargado', 'success');
                        });

                        document.getElementById('copyCode').addEventListener('click', async () => {
                            try {
                                await navigator.clipboard.writeText(fullCode);
                                showToast('üìã C√≥digo copiado al portapapeles', 'success');
                            } catch (err) {
                                showToast('‚ùå Error al copiar c√≥digo', 'error');
                            }
                        });

                        // Cerrar modal al hacer clic fuera
                        modal.addEventListener('click', (e) => {
                            if (e.target === modal) {
                                modal.remove();
                            }
                        });
                    } else {
                        showToast('‚ö†Ô∏è Configura los bloques primero', 'error');
                    }
                });
            }

            // Efectos de hover para las opciones de wallet
            document.querySelectorAll('.wallet-option').forEach(option => {
                option.addEventListener('mouseenter', function () {
                    this.style.transform = 'translateY(-6px) scale(1.05)';
                });

                option.addEventListener('mouseleave', function () {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });

            // Inicializar stepper
            updateStepper();
        });

    </script>
</body>

</html>