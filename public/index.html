<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tralalero Contracts - Crea tu Smart Contract con bloques</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Schabo+Condensed:wght@400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="main-container">
        <!-- Grid Pattern Background -->
        <div id="gridBackground" class="grid-background"></div>

        <!-- Header -->
        <div class="header">
            <div class="logo-container">
                <video src="/tralala.mp4" alt="Tralalero Contracts Video Logo" class="logo" autoplay muted loop
                    playsinline></video>
                <h1 class="title">
                    <span class="title-line1">TRALALA</span>
                    <span class="title-line2">CONTRACTS</span>
                </h1>
            </div>
        </div>
        <!-- Stepper Container -->
        <div class="stepper-container">
            <!-- Stepper Progress -->
            <div class="stepper">
                <div class="stepper-line" id="stepperLine"></div>
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Conectar Wallet</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Seleccionar Plantilla</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Configurar con Bloques</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Revisar y Desplegar</div>
                </div>
                <div class="step" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-label">Resultados</div>
                </div>
            </div>

            <!-- Step Content -->
            <div class="step-content active" id="step1">
                <div class="wallets-container">
                    <div class="description-box">
                        <h2 class="wallets-title">Conecta tu billetera y empieza a construir tu smart contract</h2>
                    </div>
                    <div class="wallet-options">
                        <div class="wallet-option" id="connectFreighter">
                            <div class="wallet-icon">ü¶ä</div>
                            <div class="wallet-label">Freighter</div>
                        </div>
                        <div class="wallet-option" id="connectXbull">
                            <div class="wallet-icon">üêÇ</div>
                            <div class="wallet-label">xBull</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Template Selection -->
            <div class="step-content" id="step2">
                <div class="templates-container">
                    <div class="description-box">
                        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: #1f2937;">Elige una Plantilla para Comenzar</h2>
                        <p style="font-size: 1rem; color: #6b7280; margin: 0;">Selecciona un caso de uso com√∫n que se adapte a tu necesidad. Puedes personalizarlo completamente con bloques despu√©s.</p>
                    </div>
                    <div class="templates-grid">
                        <div class="template-card" id="templateBasic" data-template="basic">
                            <div class="template-icon">üí∞</div>
                            <div class="template-name">Token B√°sico</div>
                            <div class="template-desc">Un token fungible simple con funciones de transferencia</div>
                            <ul class="template-features">
                                <li>‚úì Crear y transferir tokens</li>
                                <li>‚úì Consultar saldo</li>
                                <li>‚úì Aprobar transferencias</li>
                            </ul>
                        </div>
                        <div class="template-card" id="templateRWA" data-template="rwa">
                            <div class="template-icon">üè¢</div>
                            <div class="template-name">RWA (Activos Reales)</div>
                            <div class="template-desc">Token respaldado por activos del mundo real</div>
                            <ul class="template-features">
                                <li>‚úì Custodia de activos</li>
                                <li>‚úì Cumplimiento regulatorio</li>
                                <li>‚úì Redenci√≥n de activos</li>
                            </ul>
                        </div>
                        <div class="template-card" id="templateDeFi" data-template="defi">
                            <div class="template-icon">üîÑ</div>
                            <div class="template-name">DeFi (Finanzas Descentralizadas)</div>
                            <div class="template-desc">Token con features avanzadas para aplicaciones DeFi</div>
                            <ul class="template-features">
                                <li>‚úì Mint y Burn</li>
                                <li>‚úì Pausable</li>
                                <li>‚úì Control de acceso</li>
                                <li>‚úì L√≠mites de transferencia</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Smart Contract Configuration -->
            <div class="step-content" id="step3">
                <div class="blockly-container">
                    <div class="description-box">
                        <h2 class="wallets-title">¬°Arrastra y conecta los bloques!</h2>
                        <p class="wallets-title">Usa los bloques de la izquierda para modelar tu smart contract. <br />
                            Arrastra el bloque "üîÆ Mi Smart Contract" y conecta los bloques de
                            propiedades/estado/funciones.</p>
                    </div>
                    <div id="blocklyDiv"></div>
                </div>
            </div>

            <!-- Step 4: Smart Contract Configuration -->
            <div class="step-content" id="step4">
                <div class="smart-contract-container">
                    <div class="description-box">
                        <h2 class="wallets-title">‚öôÔ∏è Configuraci√≥n Avanzada del Smart Contract</h2>
                        <p class="wallets-title">Arrastra m√°s bloques para a√±adir funcionalidades y construir tu
                            contrato.</p>
                    </div>

                    <!-- Preview del C√≥digo -->
                    <div class="code-preview-section">
                        <div class="preview-header">
                            <h3>üìã Vista Previa del C√≥digo</h3>
                            <div class="preview-actions">
                                <button class="btn btn-secondary" id="refreshPreview">üîÑ Actualizar</button>
                                <button class="btn btn-secondary" id="validateContract">‚úÖ Validar</button>
                                <button class="btn btn-secondary" id="viewFullCode">üëÅÔ∏è Ver C√≥digo Completo</button>
                            </div>
                        </div>
                        <div class="code-preview" id="codePreview">
                            <pre
                                id="contractPreview">// El c√≥digo se generar√° autom√°ticamente cuando configures los bloques...</pre>
                        </div>
                        <div class="validation-result hidden" id="validationResult">
                            <div id="validationMessage"></div>
                        </div>
                        <div class="validation-result hidden" id="preDeploymentValidation">
                            <div id="preDeploymentValidationMessage"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4.5: Compilaci√≥n en Progreso (Minimalista) -->
            <!-- NOT a step-content! Shown/hidden manually during deployment -->
            <div id="compilationStep" style="display: none;">
                <div style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    min-height: 600px;
                    padding: 2rem;
                    max-width: 600px;
                    margin: 0 auto;
                ">
                    <!-- T√≠tulo -->
                    <h2 style="
                        margin: 0 0 2rem 0;
                        color: #1f2937;
                        text-align: center;
                        font-size: 1.8rem;
                    ">‚öôÔ∏è Compilando tu Smart Contract</h2>

                    <!-- Stepper Vertical Minimalista -->
                    <div id="compilationSteps" style="
                        width: 100%;
                        max-width: 500px;
                        margin-bottom: 2rem;
                    "></div>

                    <!-- Barra de Progreso -->
                    <div style="
                        width: 100%;
                        margin-bottom: 1rem;
                    ">
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 0.5rem;
                        ">
                            <span id="compilationStatus" style="
                                font-size: 0.95rem;
                                color: #6b7280;
                                font-weight: 500;
                            ">Iniciando compilaci√≥n...</span>
                            <span id="compilationPercent" style="
                                font-weight: 700;
                                color: #6366f1;
                                font-size: 1.1rem;
                            ">0%</span>
                        </div>
                        <div style="
                            width: 100%;
                            height: 8px;
                            background: #e5e7eb;
                            border-radius: 4px;
                            overflow: hidden;
                            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
                        ">
                            <div id="compilationProgressBar" style="
                                width: 0%;
                                height: 100%;
                                background: linear-gradient(90deg, #6366f1, #8b5cf6);
                                border-radius: 4px;
                                transition: width 0.3s ease;
                            "></div>
                        </div>
                    </div>

                    <!-- Resultado Final (oculto inicialmente) -->
                    <div id="compilationResult" class="hidden" style="
                        width: 100%;
                        text-align: center;
                    ">
                        <div id="resultContent"></div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Review and Deploy -->
            <!-- NOT a step-content! Shown/hidden manually during deployment -->
            <div id="step4Content" style="display: none;">
                <div class="create-token-container">
                    <h2 class="step-title">üöÄ Revisa y exporta tu Smart Contract</h2>

                    <!-- Resumen del Contrato -->
                    <div class="contract-summary" id="contractSummary">
                        <h3>üìÑ Resumen del Contrato</h3>
                        <div class="summary-grid" id="summaryGrid">
                            <div class="summary-item">
                                <strong>Tipo:</strong> <span id="summaryType">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Nombre:</strong> <span id="summaryName">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>S√≠mbolo:</strong> <span id="summarySymbol">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Cantidad Inicial:</strong> <span id="summarySupply">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Caracter√≠sticas:</strong> <span id="summaryFeatures">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Licencia:</strong> <span id="summaryLicense">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Administrador:</strong> <span id="summaryAdmin">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Red:</strong> <span id="summaryNetwork">Stellar Testnet</span>
                            </div>
                        </div>
                    </div>

                    <!-- Progreso de Despliegue -->
                    <div class="deployment-pipeline" id="deploymentPipeline">
                        <div class="pipeline-step" id="pipelineValidation">
                            <div class="step-icon">üîç</div>
                            <div class="step-info">
                                <h4>Validaci√≥n</h4>
                                <p>Verificando configuraci√≥n del contrato...</p>
                            </div>
                            <div class="step-status pending">‚è≥</div>
                        </div>

                        <div class="pipeline-step" id="pipelineCompilation">
                            <div class="step-icon">‚öôÔ∏è</div>
                            <div class="step-info">
                                <h4>Compilaci√≥n</h4>
                                <p>Generando c√≥digo Rust del smart contract...</p>
                            </div>
                            <div class="step-status pending">‚è≥</div>
                        </div>

                        <div class="pipeline-step" id="pipelineWasm">
                            <div class="step-icon">üì¶</div>
                            <div class="step-info">
                                <h4>Build WASM</h4>
                                <p>Compilando a WebAssembly optimizado...</p>
                            </div>
                            <div class="step-status pending">‚è≥</div>
                        </div>

                        <div class="pipeline-step" id="pipelineDeployment">
                            <div class="step-icon">üì¶</div>
                            <div class="step-info">
                                <h4>Exportaci√≥n</h4>
                                <p>Preparando c√≥digo para descargar/copiar...</p>
                            </div>
                            <div class="step-status pending">‚è≥</div>
                        </div>
                    </div>

                    <!-- Estado de Despliegue -->
                    <div class="deployment-status hidden" id="deploymentStatus">
                        <div class="deployment-message" id="deploymentMessage">Preparando despliegue...</div>
                        <div class="deployment-progress">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                    </div>

                    <!-- Resultado del Despliegue -->
                    <div class="deployment-result hidden" id="deploymentResult">
                        <div class="result-content" id="resultContent"></div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Contract Summary (Before Deployment) -->
            <div class="step-content" id="step5">
                <div class="results-container">
                    <div class="description-box" style="text-align: center;">
                        <h2 class="step-title" style="color: #6366f1; font-size: 2rem; margin-bottom: 1rem;">üìã
                            Resumen del Contrato</h2>
                        <p style="font-size: 1.1rem; color: #6b7280;">Revisa los detalles antes de desplegar a Stellar Testnet
                        </p>
                    </div>

                    <div id="contractSummaryStep5" style="max-width: 800px; margin: 2rem auto;">
                        <!-- Contract summary will be injected here -->
                    </div>

                    <div id="deploymentResults" style="max-width: 800px; margin: 2rem auto; display: none;">
                        <!-- Success content will be shown after deployment -->
                    </div>

                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="stepper-navigation">
                <button class="btn btn-secondary" id="prevBtn" disabled>Anterior</button>
                <button class="btn btn-primary" id="nextBtn">Siguiente</button>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stellar/stellar-sdk@14.3.0/dist/stellar-sdk.min.js"></script>
    <script>
        // Verify SDK loaded correctly (v14.3.0 - Protocol 24 support)
        if (typeof StellarSdk !== 'undefined') {
            console.log('‚úÖ Stellar SDK loaded successfully!');
            console.log('üì¶ SDK Version:', StellarSdk.version || 'version property not found');
            console.log('üîç SDK Keys:', Object.keys(StellarSdk));
            console.log('üîß Has SorobanRpc:', !!StellarSdk.SorobanRpc);
            console.log('üîß Has SorobanRpc.Server:', !!StellarSdk.SorobanRpc?.Server);
            console.log('üîß Has rpc:', !!StellarSdk.rpc);
            console.log('üîß Has rpc.Server:', !!StellarSdk.rpc?.Server);
            console.log('üîß Has Horizon:', !!StellarSdk.Horizon);
            console.log('üîß Has Networks:', !!StellarSdk.Networks);
        } else {
            console.error('‚ùå STELLAR SDK NOT LOADED! Check Network tab for errors.');
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@stellar/freighter-api@1.7.0/build/index.min.js"></script>
    <script src="https://unpkg.com/albedo-sdk@^0.10.4/dist/albedo.min.js"></script>
    <script src="/wallet-adapter.js"></script>
    <script src="compilation-progress.js"></script>
    <script src="blockly-templates.js"></script>
    <script src="rust-generator.js"></script>
    <script src="contract-validator.js"></script>
    <script src="project-manager.js"></script>
    <script src="blocks-definitions.js"></script>
    <script>
        // Estado global de la aplicaci√≥n
        const appState = {
            currentStep: 1,
            totalSteps: 5, // 5 steps: 1=Connect, 2=Template, 3=Blockly, 4=Deploy, 5=Results
            walletConnected: false,
            walletAddress: null,
            walletType: null,
            selectedTemplate: null,
            contractCompiled: false,
            contractValidated: false,
            tokenData: {
                // Configuraci√≥n b√°sica
                tokenType: 'SMART_CONTRACT',
                contractType: 'TOKEN',
                name: '',
                symbol: '',
                supply: 0,
                decimals: 2,
                adminAddress: '',

                // Caracter√≠sticas avanzadas
                features: {
                    mintable: false,
                    burnable: false,
                    pausable: false,
                    upgradeable: false,
                    accessControl: false,
                    governance: false,
                    stakeable: false,
                    timeLock: false,
                    multiSig: false
                },

                // Configuraci√≥n de seguridad
                security: {
                    transferLimit: 0,
                    dailyLimit: 0,
                    whitelistEnabled: false,
                    freezeable: false,
                    recoverableKeys: false
                },

                // Informaci√≥n del contrato
                metadata: {
                    securityContact: '',
                    license: 'MIT',
                    version: '1.0.0',
                    description: '',
                    website: '',
                    logoUrl: ''
                },

                // Configuraci√≥n avanzada
                economics: {
                    transactionFee: 0,
                    burnRate: 0,
                    stakingReward: 0,
                    inflationRate: 0
                },

                // Backward compatibility
                initialSupply: 0
            }
        };

        // Variable global para el workspace de Blockly
        let blocklyWorkspace = null;

        // Elementos del DOM
        const elements = {
            stepper: document.querySelector('.stepper'),
            stepperLine: document.getElementById('stepperLine'),
            steps: document.querySelectorAll('.step'),
            stepContents: document.querySelectorAll('.step-content'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),

            // Summary elements
            tokenSummary: document.getElementById('tokenSummary'),
            summaryType: document.getElementById('summaryType'),
            summaryName: document.getElementById('summaryName'),
            summarySymbol: document.getElementById('summarySymbol'),
            summarySupply: document.getElementById('summarySupply'),
            summaryFeatures: document.getElementById('summaryFeatures'),
            summaryLicense: document.getElementById('summaryLicense'),
            summaryAdmin: document.getElementById('summaryAdmin'),

            // Deployment elements
            deploymentStatus: document.getElementById('deploymentStatus'),
            deploymentMessage: document.getElementById('deploymentMessage'),
            deploymentResult: document.getElementById('deploymentResult'),
            resultContent: document.getElementById('resultContent')
        };

        // Funciones del stepper
        function updateStepper() {
            // Actualizar pasos
            elements.steps.forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed');

                if (stepNumber === appState.currentStep) {
                    step.classList.add('active');
                } else if (stepNumber < appState.currentStep) {
                    step.classList.add('completed');
                }
            });

            // Actualizar contenido de pasos con transici√≥n suave
            elements.stepContents.forEach((content, index) => {
                content.classList.remove('active');
                if (index + 1 === appState.currentStep) {
                    // Peque√±o delay para permitir que la transici√≥n anterior termine
                    setTimeout(() => {
                        content.classList.add('active');
                    }, 50);
                }
            });

            // Actualizar l√≠nea de progreso con transici√≥n suave
            const progress = ((appState.currentStep - 1) / (appState.totalSteps - 1)) * 100;
            elements.stepperLine.style.transition = 'width 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            elements.stepperLine.style.width = `${progress}%`;

            // Actualizar botones
            elements.prevBtn.disabled = appState.currentStep === 1;

            if (appState.currentStep === appState.totalSteps) {
                elements.nextBtn.textContent = 'Crear Token';
            } else {
                elements.nextBtn.textContent = 'Siguiente';
            }

            // Actualizar contenido din√°mico seg√∫n el paso
            updateStepContent();
        }

        function goToStep(stepNumber) {
            if (stepNumber >= 1 && stepNumber <= appState.totalSteps) {
                appState.currentStep = stepNumber;
                updateStepper();
            }
        }

        function nextStep() {
            if (validateCurrentStep()) {
                if (appState.currentStep < appState.totalSteps) {
                    goToStep(appState.currentStep + 1);
                } else {
                    deployToken();
                }
            }
        }

        function prevStep() {
            if (appState.currentStep > 1) {
                goToStep(appState.currentStep - 1);
            }
        }

        function updateStepContent() {
            switch (appState.currentStep) {
                case 2:
                    // Agregar event listeners a las tarjetas de plantillas
                    addTemplateListeners();
                    break;
                case 3:
                    // Inicializar Blockly cuando se llega al paso 3
                    if (!blocklyWorkspace) {
                        initializeBlockly();
                    } else {
                        // Forzar re-render si ya existe
                        blocklyWorkspace.render();
                    }
                    break;
                case 4:
                    // Configuraci√≥n avanzada de smart contracts
                    if (!blocklyWorkspace) {
                        initializeBlockly();
                    } else {
                        blocklyWorkspace.render();
                    }
                    // Actualizar preview despu√©s de asegurar que Blockly est√© listo
                    setTimeout(() => updateCodePreview(), 100);
                    updateTokenSummary();
                    updateDeploymentPipeline();
                    break;
            }
        }

        function addTemplateListeners() {
            const templateCards = document.querySelectorAll('.template-card');
            templateCards.forEach(card => {
                card.addEventListener('click', function () {
                    // Remover selecci√≥n anterior
                    templateCards.forEach(c => c.classList.remove('selected'));
                    // Agregar selecci√≥n a la tarjeta actual
                    this.classList.add('selected');

                    const template = this.getAttribute('data-template');
                    appState.selectedTemplate = template;
                    console.log('üìã Plantilla seleccionada:', template);
                    applyTemplate(template);
                });
            });
        }

        function applyTemplate(template) {
            console.log('üé® Aplicando plantilla:', template);

            // Guardar la plantilla en appState
            appState.selectedTemplate = template;

            // Switch Blockly template dynamically
            if (typeof window.switchTemplate === 'function') {
                console.log('üîÑ Switching Blockly template to:', template);
                window.switchTemplate(template);
            } else {
                console.warn('‚ö†Ô∏è switchTemplate function not available yet');
            }

            // Mostrar mensaje
            showToast(`‚úÖ Plantilla "${template.toUpperCase()}" seleccionada`, 'success');
        }

        // Funci√≥n para cambiar din√°micamente los bloques por defecto seg√∫n la plantilla
        window.switchTemplate = function(templateName) {
            console.log(`üîÑ Switching Blockly blocks to template: ${templateName}`);
            appState.selectedTemplate = templateName;
            createDefaultBlocks();
        };

        // Funci√≥n para actualizar el preview del c√≥digo
        function updateCodePreview() {
            const contractPreview = document.getElementById('contractPreview');
            if (!contractPreview) return;

            // Validar que el workspace est√© inicializado
            if (!blocklyWorkspace) {
                contractPreview.textContent = '// Blockly a√∫n se est√° inicializando...';
                console.warn('‚ö†Ô∏è Blockly workspace no est√° disponible');
                return;
            }

            try {
                // Primero intentar generar desde bloques con el nuevo generador
                const contractBlock = blocklyWorkspace.getBlocksByType('contract_settings', false)[0];
                if (contractBlock) {
                    try {
                        const generatedCode = rustGen.generateContract(contractBlock);
                        contractPreview.textContent = generatedCode;
                        console.log('‚úÖ C√≥digo generado desde bloques correctamente');
                        return;
                    } catch (blockError) {
                        console.warn('‚ö†Ô∏è Error generando desde bloques, usando fallback:', blockError);
                    }
                }

                // Fallback: usar m√©todo anterior
                const blocklyData = readBlocklyData();
                if (!blocklyData || !blocklyData.name) {
                    contractPreview.textContent = '// Configura el nombre de tu contrato para ver el preview...\n// Arrastra bloques desde la izquierda';
                    return;
                }

                const rustCode = generateAdvancedRustCode(blocklyData);
                contractPreview.textContent = rustCode;
                console.log('‚úÖ Preview actualizado con m√©todo fallback');
            } catch (error) {
                console.error('‚ùå Error actualizando preview:', error);
                contractPreview.textContent = `// Error generando preview:\n// ${error.message}`;
            }
        }

        // Funci√≥n para generar c√≥digo Rust avanzado
        function generateAdvancedRustCode(data) {
            const features = [];
            const dataFeatures = data.features || {};
            const dataSecurity = data.security || {};
            const dataEconomics = data.economics || {};

            if (dataFeatures.mintable) features.push('Mintable');
            if (dataFeatures.burnable) features.push('Burnable');
            if (dataFeatures.pausable) features.push('Pausable');
            if (dataFeatures.upgradeable) features.push('Upgradeable');
            if (dataFeatures.governance) features.push('Governance');
            if (dataFeatures.stakeable) features.push('Stakeable');
            if (dataFeatures.timeLock) features.push('TimeLock');
            if (dataFeatures.accessControl) features.push('AccessControl');

            return `// Smart Contract: ${data.name || 'Mi Token'}
// Generado autom√°ticamente por Tralalero Contracts
#![no_std]

use soroban_sdk::{
    contract, contractimpl, Address, Env, String, Symbol, Map,
    token::{self, Interface as TokenInterface},
    auth::{Context, CustomAccountInterface},
    ${dataFeatures.governance ? 'governance::GovernanceInterface,' : ''}
    ${dataFeatures.stakeable ? 'staking::StakingInterface,' : ''}
};

// Constantes del contrato
const TOKEN_NAME: &str = "${data.name || 'Mi Token'}";
const TOKEN_SYMBOL: &str = "${data.symbol || 'TOKEN'}";
const DECIMALS: u32 = ${data.decimals || 2};
const INITIAL_SUPPLY: i128 = ${data.supply || 1000};

// Claves de almacenamiento
const ADMIN: Symbol = symbol_short!("ADMIN");
const PAUSED: Symbol = symbol_short!("PAUSED");
const TOTAL_SUPPLY: Symbol = symbol_short!("TOTAL_SUP");
${dataSecurity.transferLimit ? `const TRANSFER_LIMIT: Symbol = symbol_short!("TRANS_LIM");` : ''}
${dataFeatures.stakeable ? `const STAKING_POOL: Symbol = symbol_short!("STAKING");` : ''}

#[contract]
pub struct TokenContract;

#[contractimpl]
impl TokenContract {
    
    /// Inicializa el contrato con configuraci√≥n personalizada
    pub fn initialize(env: Env, admin: Address) {
        if env.storage().instance().has(&ADMIN) {
            panic!("Contract already initialized");
        }

        env.storage().instance().set(&ADMIN, &admin);
        env.storage().instance().set(&TOTAL_SUPPLY, &INITIAL_SUPPLY);
        ${dataFeatures.pausable ? 'env.storage().instance().set(&PAUSED, &false);' : ''}
        ${dataSecurity.transferLimit ? `env.storage().instance().set(&TRANSFER_LIMIT, &${dataSecurity.transferLimit});` : ''}

        // Mint inicial al admin
        if INITIAL_SUPPLY > 0 {
            token::Client::new(&env, &env.current_contract_address())
                .mint(&admin, &INITIAL_SUPPLY);
        }
    }

    /// Metadata del token
    pub fn name(env: Env) -> String {
        String::from_str(&env, TOKEN_NAME)
    }

    pub fn symbol(env: Env) -> String {
        String::from_str(&env, TOKEN_SYMBOL)
    }

    pub fn decimals(env: Env) -> u32 {
        DECIMALS
    }

    ${dataFeatures.mintable ? `
    /// Mint nuevos tokens (solo admin)
    pub fn mint(env: Env, to: Address, amount: i128) {
        Self::check_admin(&env);
        ${dataFeatures.pausable ? 'Self::check_not_paused(&env);' : ''}

        token::Client::new(&env, &env.current_contract_address())
            .mint(&to, &amount);
    }` : ''}

    ${dataFeatures.burnable ? `
    /// Burn tokens
    pub fn burn(env: Env, from: Address, amount: i128) {
        from.require_auth();
        ${dataFeatures.pausable ? 'Self::check_not_paused(&env);' : ''}

        token::Client::new(&env, &env.current_contract_address())
            .burn(&from, &amount);
    }` : ''}

    ${dataFeatures.pausable ? `
    /// Pausar el contrato (solo admin)
    pub fn pause(env: Env) {
        Self::check_admin(&env);
        env.storage().instance().set(&PAUSED, &true);
    }

    /// Despausar el contrato (solo admin)
    pub fn unpause(env: Env) {
        Self::check_admin(&env);
        env.storage().instance().set(&PAUSED, &false);
    }` : ''}

    ${dataFeatures.stakeable ? `
    /// Hacer staking de tokens
    pub fn stake(env: Env, from: Address, amount: i128) {
        from.require_auth();
        Self::check_not_paused(&env);

        // L√≥gica de staking...
        // TODO: Implementar pool de staking
    }` : ''}

    /// Funciones auxiliares
    fn check_admin(env: &Env) {
        let admin: Address = env.storage().instance().get(&ADMIN).unwrap();
        admin.require_auth();
    }

    ${dataFeatures.pausable ? `
    fn check_not_paused(env: &Env) {
        let paused: bool = env.storage().instance().get(&PAUSED).unwrap_or(false);
        if paused {
            panic!("Contract is paused");
        }
    }` : ''}
}

// Caracter√≠sticas habilitadas: ${features.join(', ') || 'Ninguna'}
// L√≠mite de transferencia: ${dataSecurity.transferLimit || 'Sin l√≠mite'}
// Recompensa de staking: ${dataEconomics.stakingReward || 0}% anual
// Fee de transacci√≥n: ${dataEconomics.transactionFee || 0}%
// Burn rate: ${dataEconomics.burnRate || 0}%`;
        }

        // Funci√≥n para validar el contrato
        function validateSmartContract() {
            const validationResult = document.getElementById('validationResult');
            const validationMessage = document.getElementById('validationMessage');

            if (!validationResult || !validationMessage) return false;

            if (!blocklyWorkspace) {
                validationMessage.innerHTML = `
                    <div style="color: #dc2626; font-weight: bold;">‚ùå Blockly no est√° inicializado</div>
                `;
                validationResult.classList.remove('hidden');
                validationResult.style.backgroundColor = '#fef2f2';
                validationResult.style.borderColor = '#dc2626';
                appState.contractValidated = false;
                return false;
            }

            // Usar el validador profesional
            const report = validator.validate(blocklyWorkspace);

            // Mostrar resultados
            validationResult.classList.remove('hidden');
            validationMessage.innerHTML = validator.toHTML();

            if (!report.isValid) {
                validationResult.style.backgroundColor = '#fef2f2';
                validationResult.style.borderColor = '#dc2626';
                appState.contractValidated = false;
                return false;
            } else if (report.warningCount > 0) {
                validationResult.style.backgroundColor = '#fffbeb';
                validationResult.style.borderColor = '#d97706';
                appState.contractValidated = true;
                return true;
            } else {
                validationResult.style.backgroundColor = '#f0fdf4';
                validationResult.style.borderColor = '#059669';
                appState.contractValidated = true;
                return true;
            }
        }

        // Funci√≥n para actualizar el pipeline de despliegue
        function updateDeploymentPipeline() {
            const pipeline = document.getElementById('deploymentPipeline');
            if (!pipeline) return;

            // Resetear estados
            const steps = pipeline.querySelectorAll('.pipeline-step');
            steps.forEach(step => {
                const status = step.querySelector('.step-status');
                status.className = 'step-status pending';
                status.textContent = '‚è≥';
            });

            // Marcar validaci√≥n como completada si est√° validado
            if (appState.contractValidated) {
                const validationStep = document.getElementById('pipelineValidation');
                if (validationStep) {
                    const status = validationStep.querySelector('.step-status');
                    status.className = 'step-status completed';
                    status.textContent = '‚úÖ';
                }
            }
        }

        // Funci√≥n para actualizar un paso espec√≠fico del pipeline
        async function updatePipelineStep(stepId, status, message) {
            const step = document.getElementById(stepId);
            if (!step) return;

            const stepStatus = step.querySelector('.step-status');
            const stepInfo = step.querySelector('.step-info p');

            // Remover clases anteriores
            step.className = 'pipeline-step';
            stepStatus.className = 'step-status';

            // A√±adir nueva clase y actualizar contenido
            step.classList.add(status);
            stepStatus.classList.add(status);

            switch (status) {
                case 'active':
                    stepStatus.textContent = 'üîÑ';
                    step.style.animation = 'pulse 1.5s infinite';
                    break;
                case 'completed':
                    stepStatus.textContent = '‚úÖ';
                    step.style.animation = 'none';
                    break;
                case 'error':
                    stepStatus.textContent = '‚ùå';
                    step.style.animation = 'none';
                    break;
                default:
                    stepStatus.textContent = '‚è≥';
                    step.style.animation = 'none';
            }

            if (message && stepInfo) {
                stepInfo.textContent = message;
            }

            // Peque√±a animaci√≥n para mostrar progreso
            if (status === 'completed') {
                step.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    step.style.transform = 'scale(1)';
                }, 300);
            }
        }

        // Funciones de Blockly
        function initializeBlockly() {
            if (typeof Blockly === 'undefined') {
                console.error('Blockly no est√° cargado');
                return;
            }

            // Agregar bloque de settings para compatibilidad con c√≥digo existente
            if (!Blockly.Blocks['contract_settings']) {
                Blockly.Blocks['contract_settings'] = {
                    init: function () {
                        this.appendDummyInput()
                            .appendField("üîÆ Mi Smart Contract");
                        this.appendStatementInput("SETTINGS")
                            .setCheck(null);
                        this.setColour("#8E24AA");
                        this.setTooltip("Bloque principal del contrato");
                    }
                };
            }

            // Crear workspace de Blockly con todas las categor√≠as
            blocklyWorkspace = Blockly.inject('blocklyDiv', {
                toolbox: `
                    <xml>
                        <category name="üöÄ Empezar" colour="#8E24AA">
                            <block type="contract_init"></block>
                            <block type="contract_metadata"></block>
                        </category>

                        <category name="üé® Propiedades" colour="#1E88E5">
                            <block type="contract_name"></block>
                            <block type="contract_version"></block>
                            <block type="contract_owner"></block>
                            <block type="admin_address"></block>
                            <block type="contract_description"></block>
                        </category>

                        <category name="üì¶ Estado" colour="#5E35B1">
                            <block type="state_variable"></block>
                            <block type="state_map"></block>
                            <block type="state_event"></block>
                            <block type="event_parameter"></block>
                        </category>

                        <category name="‚öôÔ∏è Funciones" colour="#FF8F00">
                            <block type="function_declaration"></block>
                            <block type="function_parameter"></block>
                            <block type="function_return"></block>
                        </category>

                        <category name="üß† L√≥gica" colour="#E91E63">
                            <block type="if_statement"></block>
                            <block type="comparison_operator"></block>
                            <block type="logical_operator"></block>
                            <block type="loop_while"></block>
                            <block type="loop_for"></block>
                        </category>

                        <category name="üî¢ Operaciones" colour="#4CAF50">
                            <block type="arithmetic_operation"></block>
                            <block type="variable_assignment"></block>
                            <block type="increment_decrement"></block>
                            <block type="number_literal"></block>
                            <block type="string_literal"></block>
                            <block type="boolean_literal"></block>
                        </category>

                        <category name="‚≠ê Stellar" colour="#FFC107">
                            <block type="stellar_transfer"></block>
                            <block type="stellar_payment"></block>
                            <block type="stellar_trust_line"></block>
                            <block type="stellar_require_auth"></block>
                            <block type="stellar_context"></block>
                        </category>

                        <category name="üí∞ Token" colour="#7B1FA2">
                            <block type="token_symbol"></block>
                            <block type="token_supply"></block>
                            <block type="token_decimals"></block>
                            <block type="token_init"></block>
                            <block type="token_mint"></block>
                            <block type="token_burn"></block>
                            <block type="token_transfer"></block>
                            <block type="token_balance"></block>
                            <block type="token_allowance"></block>
                        </category>

                        <category name="üè¢ RWA" colour="#C62828">
                            <block type="rwa_asset"></block>
                            <block type="rwa_custody"></block>
                            <block type="rwa_settlement"></block>
                            <block type="rwa_compliance"></block>
                            <block type="rwa_redemption"></block>
                        </category>

                        <category name="üîê Seguridad" colour="#D32F2F">
                            <block type="require_condition"></block>
                            <block type="access_control"></block>
                            <block type="role_based_check"></block>
                            <block type="reentrancy_guard"></block>
                            <block type="pause_functionality"></block>
                        </category>
                    </xml>
                `,
                scrollbars: true,
                trashcan: true,
                zoom: {
                    controls: true,
                    wheel: true,
                    startScale: 1.0,
                    maxScale: 3,
                    minScale: 0.3,
                    scaleSpeed: 1.2
                },
                theme: Blockly.Themes.Modern
            });

            // Agregar listeners para actualizar preview en tiempo real
            blocklyWorkspace.addChangeListener(function (event) {
                // Solo actualizar en step 3
                if (appState.currentStep === 3) {
                    // Usar debounce para evitar actualizaciones demasiado frecuentes
                    clearTimeout(window.previewUpdateTimeout);
                    window.previewUpdateTimeout = setTimeout(() => {
                        updateCodePreview();
                    }, 300);
                }
            });

            console.log('‚úÖ Blockly inicializado correctamente');

            // Crear bloques por defecto
            createDefaultBlocks();
        }

        function createDefaultBlocks() {
            if (!blocklyWorkspace) return;

            console.log(`üîÑ Creating default blocks for template: ${appState.selectedTemplate || 'basic'}`);

            // Limpiar workspace
            blocklyWorkspace.clear();

            try {
                // Crear el bloque principal del contrato
                const contractBlock = blocklyWorkspace.newBlock('contract_settings');
                if (!contractBlock) {
                    console.error('‚ùå No se pudo crear el bloque de contrato');
                    return;
                }
                contractBlock.initSvg();
                contractBlock.render();
                contractBlock.moveBy(50, 50);

                // Crear bloques b√°sicos sugeridos seg√∫n la plantilla
                const blocks = [];
                const template = appState.selectedTemplate || 'basic';

                if (template === 'rwa') {
                    // Bloques para RWA
                    // Primero agregar el bloque de nombre del contrato
                    const nameBlock = blocklyWorkspace.newBlock('contract_name');
                    if (nameBlock) {
                        nameBlock.initSvg();
                        nameBlock.render();
                        nameBlock.setFieldValue('RWAContract', 'NAME');
                        blocks.push(nameBlock);
                        console.log('‚úÖ Contract name block created');
                    }

                    // Agregar bloque de administrador
                    const adminBlock = blocklyWorkspace.newBlock('admin_address');
                    if (adminBlock) {
                        adminBlock.initSvg();
                        adminBlock.render();
                        adminBlock.setFieldValue('GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWHF', 'ADDRESS');
                        blocks.push(adminBlock);
                        console.log('‚úÖ Admin address block created');
                    }

                    const rwaAsset = blocklyWorkspace.newBlock('rwa_asset');
                    if (rwaAsset) {
                        rwaAsset.initSvg();
                        rwaAsset.render();
                        blocks.push(rwaAsset);
                        console.log('‚úÖ RWA asset block created');
                    }

                    const rwaCustody = blocklyWorkspace.newBlock('rwa_custody');
                    if (rwaCustody) {
                        rwaCustody.initSvg();
                        rwaCustody.render();
                        blocks.push(rwaCustody);
                        console.log('‚úÖ RWA custody block created');
                    }

                    const rwaSettlement = blocklyWorkspace.newBlock('rwa_settlement');
                    if (rwaSettlement) {
                        rwaSettlement.initSvg();
                        rwaSettlement.render();
                        blocks.push(rwaSettlement);
                        console.log('‚úÖ RWA settlement block created');
                    }

                } else if (template === 'defi') {
                    // Bloques para DeFi
                    const nameBlock = blocklyWorkspace.newBlock('contract_name');
                    if (nameBlock) {
                        nameBlock.initSvg();
                        nameBlock.render();
                        nameBlock.setFieldValue('DefiToken', 'NAME');
                        blocks.push(nameBlock);
                    }

                    const stateVarBlock = blocklyWorkspace.newBlock('state_variable');
                    if (stateVarBlock) {
                        stateVarBlock.initSvg();
                        stateVarBlock.render();
                        stateVarBlock.setFieldValue('totalSupply', 'VAR_NAME');
                        stateVarBlock.setFieldValue('I128', 'VAR_TYPE');
                        stateVarBlock.setFieldValue('0', 'INIT_VALUE');
                        blocks.push(stateVarBlock);
                    }

                    const mintFn = blocklyWorkspace.newBlock('function_declaration');
                    if (mintFn) {
                        mintFn.initSvg();
                        mintFn.render();
                        mintFn.setFieldValue('mint', 'FN_NAME');
                        mintFn.setFieldValue('VOID', 'RET_TYPE');
                        blocks.push(mintFn);
                    }

                    const burnFn = blocklyWorkspace.newBlock('function_declaration');
                    if (burnFn) {
                        burnFn.initSvg();
                        burnFn.render();
                        burnFn.setFieldValue('burn', 'FN_NAME');
                        burnFn.setFieldValue('VOID', 'RET_TYPE');
                        blocks.push(burnFn);
                    }

                } else {
                    // Bloques b√°sicos por defecto
                    // Bloque de nombre del contrato
                    const nameBlock = blocklyWorkspace.newBlock('contract_name');
                    if (nameBlock) {
                        nameBlock.initSvg();
                        nameBlock.render();
                        nameBlock.setFieldValue('MiContrato', 'NAME');
                        blocks.push(nameBlock);
                    }

                    // Bloque de versi√≥n
                    const versionBlock = blocklyWorkspace.newBlock('contract_version');
                    if (versionBlock) {
                        versionBlock.initSvg();
                        versionBlock.render();
                        versionBlock.setFieldValue('1.0.0', 'VERSION');
                        blocks.push(versionBlock);
                    }

                    // Bloque de administrador
                    const adminBlock = blocklyWorkspace.newBlock('admin_address');
                    if (adminBlock) {
                        adminBlock.initSvg();
                        adminBlock.render();
                        adminBlock.setFieldValue('G...', 'ADDRESS');
                        blocks.push(adminBlock);
                    }

                    // Bloque de variable de estado
                    const stateVarBlock = blocklyWorkspace.newBlock('state_variable');
                    if (stateVarBlock) {
                        stateVarBlock.initSvg();
                        stateVarBlock.render();
                        stateVarBlock.setFieldValue('totalSupply', 'VAR_NAME');
                        stateVarBlock.setFieldValue('I128', 'VAR_TYPE');
                        stateVarBlock.setFieldValue('0', 'INIT_VALUE');
                        blocks.push(stateVarBlock);
                    }

                    // Bloque de funci√≥n
                    const fnBlock = blocklyWorkspace.newBlock('function_declaration');
                    if (fnBlock) {
                        fnBlock.initSvg();
                        fnBlock.render();
                        fnBlock.setFieldValue('transfer', 'FN_NAME');
                        fnBlock.setFieldValue('VOID', 'RET_TYPE');
                        blocks.push(fnBlock);
                    }
                }

                // Conectar todos los bloques de forma secuencial
                setTimeout(() => {
                    try {
                        console.log('üîó Conectando bloques por defecto...');

                        // Conectar el primer bloque al contrato
                        const settingsInput = contractBlock.getInput('SETTINGS');
                        if (settingsInput && settingsInput.connection && blocks[0] && blocks[0].previousConnection) {
                            settingsInput.connection.connect(blocks[0].previousConnection);
                        }

                        // Conectar los bloques en cadena
                        for (let i = 0; i < blocks.length - 1; i++) {
                            const currentBlock = blocks[i];
                            const nextBlock = blocks[i + 1];

                            if (currentBlock && currentBlock.nextConnection &&
                                nextBlock && nextBlock.previousConnection) {
                                currentBlock.nextConnection.connect(nextBlock.previousConnection);
                            }
                        }

                        // Renderizar despu√©s de conectar
                        blocklyWorkspace.render();
                        console.log('‚úÖ Bloques por defecto creados y conectados');

                    } catch (error) {
                        console.error('‚ùå Error conectando bloques:', error);
                    }
                }, 500);

            } catch (error) {
                console.error('‚ùå Error creando bloques:', error);
            }
        }

        function readBlocklyData() {
            if (!blocklyWorkspace) {
                console.error('Blockly workspace no est√° inicializado');
                return null;
            }

            const contractBlock = blocklyWorkspace.getBlocksByType('contract_settings', false)[0];
            if (!contractBlock) {
                console.error('No se encontr√≥ bloque de contrato');
                return null;
            }

            const data = {
                name: '',
                symbol: 'TOKEN',
                supply: 1000,
                decimals: 2,
                version: '0.1.0',
                admin: appState.walletAddress || '',
                state: [],
                functions: [],
                // Asegurar que siempre existan features, security, economics y metadata
                features: {
                    mintable: false,
                    burnable: false,
                    pausable: false,
                    upgradeable: false,
                    accessControl: false,
                    governance: false,
                    stakeable: false,
                    timeLock: false,
                    multiSig: false
                },
                security: {
                    transferLimit: 0,
                    dailyLimit: 0,
                    whitelistEnabled: false,
                    freezeable: false,
                    recoverableKeys: false
                },
                economics: {
                    transactionFee: 0,
                    burnRate: 0,
                    stakingReward: 0,
                    inflationRate: 0
                },
                metadata: {
                    license: 'MIT',
                    description: '',
                    website: '',
                    logoUrl: ''
                }
            };

            let currentBlock = contractBlock.getInputTargetBlock('SETTINGS');

            while (currentBlock) {
                switch (currentBlock.type) {

                    case 'contract_name':
                        data.name = currentBlock.getFieldValue('NAME');
                        break;
                    case 'contract_version':
                        data.version = currentBlock.getFieldValue('VERSION');
                        break;
                    case 'admin_address':
                        data.admin = currentBlock.getFieldValue('ADDRESS');
                        break;
                    case 'token_symbol':
                        data.symbol = currentBlock.getFieldValue('SYMBOL');
                        break;
                    case 'token_supply':
                        data.supply = parseInt(currentBlock.getFieldValue('SUPPLY')) || 1000;
                        break;
                    case 'token_decimals':
                        data.decimals = parseInt(currentBlock.getFieldValue('DECIMALS')) || 2;
                        break;
                    case 'state_var':
                    case 'state_variable':
                        data.state = data.state || [];
                        data.state.push({
                            name: currentBlock.getFieldValue('VAR_NAME'),
                            type: currentBlock.getFieldValue('VAR_TYPE')
                        });
                        break;
                    case 'function_def':
                    case 'function_declaration':
                        data.functions = data.functions || [];
                        data.functions.push({
                            name: currentBlock.getFieldValue('FN_NAME'),
                            returns: currentBlock.getFieldValue('RET_TYPE')
                        });
                        break;
                }
                currentBlock = currentBlock.getNextBlock();
            }

            return data;
        }

        // Validaci√≥n de pasos
        function validateCurrentStep() {
            switch (appState.currentStep) {
                case 1:
                    return validateWalletConnection();
                case 2:
                    return validateTemplateSelection();
                case 3:
                    return validateTokenData();
                case 4:
                    return true; // El paso 4 no requiere validaci√≥n adicional
                default:
                    return true;
            }
        }

        function validateTemplateSelection() {
            if (!appState.selectedTemplate) {
                showToast('Por favor, selecciona una plantilla para continuar', 'error');
                return false;
            }
            return true;
        }

        function validateWalletConnection() {
            if (!appState.walletConnected) {
                showToast('Por favor, conecta tu wallet primero', 'error');
                return false;
            }
            return true;
        }

        function validateTokenData() {
            // Validaci√≥n simple para smart contracts gen√©ricos
            if (!blocklyWorkspace) {
                showToast('Blockly a√∫n no se ha inicializado. Por favor espera...', 'error');
                return false;
            }

            const contractBlocks = blocklyWorkspace.getBlocksByType('contract_settings', false);

            if (contractBlocks.length === 0) {
                showToast('Por favor, configura tu contrato usando los bloques', 'error');
                return false;
            }

            const contractBlock = contractBlocks[0];
            let currentBlock = contractBlock.getInputTargetBlock('SETTINGS');
            let hasName = false;
            let contractName = '';

            while (currentBlock) {
                if (currentBlock.type === 'contract_name') {
                    contractName = currentBlock.getFieldValue('NAME');
                    if (contractName && contractName.trim() !== '') {
                        hasName = true;
                    }
                }
                currentBlock = currentBlock.getNextBlock();
            }

            if (!hasName) {
                showToast('El nombre del contrato es requerido', 'error');
                return false;
            }

            // Actualizar appState con datos b√°sicos del contrato
            appState.tokenData = appState.tokenData || {};
            appState.tokenData.name = contractName;
            appState.tokenData.adminAddress = appState.walletAddress;

            return true;
        }

        function updateTokenSummary() {
            // Leer datos actuales de Blockly
            const blocklyData = readBlocklyData();
            if (!blocklyData) return;

            // Actualizar el appState con los datos de Blockly
            appState.tokenData = { ...appState.tokenData, ...blocklyData };

            // Actualizar elementos del resumen
            if (elements.summaryType) {
                const typeLabels = { 'FUNGIBLE': 'Fungible', 'NON_FUNGIBLE': 'No Fungible', 'STABLECOIN': 'Stablecoin' };
                elements.summaryType.textContent = typeLabels[blocklyData.tokenType] || blocklyData.tokenType || 'Smart Contract';
            }
            if (elements.summaryName) elements.summaryName.textContent = blocklyData.name || '-';
            if (elements.summarySymbol) elements.summarySymbol.textContent = blocklyData.symbol || '-';
            if (elements.summarySupply) elements.summarySupply.textContent = blocklyData.supply ? blocklyData.supply.toLocaleString() : '-';

            // Mostrar caracter√≠sticas habilitadas (con verificaci√≥n segura)
            if (elements.summaryFeatures) {
                const enabledFeatures = [];
                const features = blocklyData.features || {};
                if (features.mintable) enabledFeatures.push('Mintable');
                if (features.burnable) enabledFeatures.push('Burnable');
                if (features.pausable) enabledFeatures.push('Pausable');
                if (features.upgradeable) enabledFeatures.push('Upgradeable');
                if (features.accessControl) enabledFeatures.push('Control de Acceso');

                elements.summaryFeatures.textContent = enabledFeatures.length > 0 ? enabledFeatures.join(', ') : 'Ninguna';
            }

            if (elements.summaryLicense) elements.summaryLicense.textContent = blocklyData.license || blocklyData.metadata?.license || '-';
            if (elements.summaryAdmin) elements.summaryAdmin.textContent = appState.walletAddress ? appState.walletAddress.substring(0, 8) + '...' + appState.walletAddress.substring(appState.walletAddress.length - 8) : '-';
        }

        // Funciones de utilidad
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function hideError(elementId) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
            }
        }

        function showToast(message, type = 'info') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                color: white;
                font-weight: 500;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;

            if (type === 'success') {
                toast.style.background = '#10b981';
            } else if (type === 'error') {
                toast.style.background = '#dc2626';
            } else {
                toast.style.background = '#6366f1';
            }

            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        // Funciones de conexi√≥n de wallet (usa WalletAdapter para no hardcodear Freighter)
        async function connectWallet(walletType) {
            try {
                showToast('Conectando wallet...', 'info');

                if (!window.WalletAdapter) {
                    throw new Error('WalletAdapter no est√° cargado en la p√°gina');
                }

                // Map UI labels to adapter ids
                const normalize = (label) => {
                    if (!label) return undefined;
                    const map = { 'Freighter': 'freighter', 'Albedo': 'albedo', 'xBull': 'xbull', 'Rabet': 'rabet' };
                    return map[label] || label.toLowerCase();
                };

                const id = normalize(walletType);

                // Try to connect to the requested wallet; fallback to first available
                let wallet;
                try {
                    wallet = await window.WalletAdapter.connect(id);
                } catch (err) {
                    // fallback: try connecting to first detected wallet
                    console.warn('No se pudo conectar al wallet solicitado, intentando el primero disponible:', err.message);
                    wallet = await window.WalletAdapter.connect();
                }

                const address = wallet?.publicKey;
                if (!address) throw new Error('No se obtuvo la clave p√∫blica de la wallet');

                appState.walletConnected = true;
                appState.walletAddress = address;
                appState.walletType = wallet.name || wallet.id || walletType;

                // Try to update balance using WalletAdapter helper
                if (window.WalletAdapter.getBalance) {
                    try {
                        const bal = await window.WalletAdapter.getBalance(address);
                        appState.currentBalance = bal || 0;
                    } catch (e) {
                        console.warn('No se pudo obtener balance via WalletAdapter:', e.message);
                    }
                }

                showToast('Wallet conectado exitosamente', 'success');

                // Navegar autom√°ticamente al siguiente paso con transici√≥n suave
                setTimeout(() => {
                    nextStep();
                }, 800);

            } catch (error) {
                console.error('Error conectando wallet:', error);
                showToast(`Error conectando wallet: ${error.message}`, 'error');
            }
        }

        // Funci√≥n de despliegue mejorada con pipeline
        async function deployToken() {
            try {
                // Validar antes de empezar
                if (!validateSmartContract()) {
                    showToast('‚ùå Valida el contrato antes de desplegarlo', 'error');
                    return;
                }

                // Navegar al paso de compilaci√≥n
                appState.currentStep = 4.5; // Nuevo paso de compilaci√≥n
                updateStepper();

                // Mostrar solo el compilationStep
                const allSteps = document.querySelectorAll('.step-content');
                allSteps.forEach(step => step.classList.remove('active'));
                const compilationStep = document.getElementById('compilationStep');
                if (compilationStep) compilationStep.classList.add('active');

                // Ocultar botones de navegaci√≥n
                elements.nextBtn.disabled = true;
                elements.prevBtn.disabled = true;

                const blocklyData = readBlocklyData();
                const rustCode = generateAdvancedRustCode(blocklyData);

                console.log('üîß Compilando Smart Contract:');
                console.log('   Nombre:', blocklyData.name);
                console.log('   Caracter√≠sticas:', Object.keys(blocklyData.features).filter(f => blocklyData.features[f]));

                console.log('üöÄ Enviando Smart Contract al servidor:');
                console.log('   code:', blocklyData.symbol);
                console.log('   amount:', blocklyData.supply);
                console.log('   userAddress:', appState.walletAddress);
                console.log('   features:', blocklyData.features);

                const response = await fetch('/api/build-smart-contract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: blocklyData.symbol,
                        amount: blocklyData.supply,
                        userAddress: appState.walletAddress,
                        contractData: {
                            name: blocklyData.name,
                            symbol: blocklyData.symbol,
                            decimals: blocklyData.decimals || 2,
                            supply: blocklyData.supply,
                            features: blocklyData.features,
                            security: blocklyData.security,
                            economics: blocklyData.economics,
                            metadata: blocklyData.metadata,
                            rustCode: rustCode,
                            templateType: appState.selectedTemplate
                        }
                    }),
                });

                let result;
                if (response.ok) {
                    result = await response.json();

                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    console.log('‚úÖ BUILD RESPONSE RECEIVED');
                    console.log('üì¶ isPrecompiled:', result.isPrecompiled);
                    console.log('üì¶ compiled:', result.compiled);
                    console.log('üì¶ wasmBase64 exists:', !!result.wasmBase64);
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                    // For precompiled contracts, deploy immediately
                    if (result.isPrecompiled || result.compiled) {
                        console.log('üöÄ Precompiled contract detected, deploying immediately...');

                        // Simulate progress bar (instant)
                        const progressBar = document.getElementById('compilationProgressBar');
                        const percentElement = document.getElementById('compilationPercent');
                        if (progressBar) progressBar.style.width = '100%';
                        if (percentElement) percentElement.textContent = '100%';

                        // Deploy to Stellar
                        console.log('üöÄ Calling deployment...');
                        const deploymentData = await deployToStellar(result.wasmBase64, blocklyData);

                        console.log('‚úÖ Deployment complete:', deploymentData);

                        // Show success screen
                        console.log('üé® Calling showDeploymentSuccess...');
                        console.log('   result (compilation):', result);
                        console.log('   deploymentData:', deploymentData);
                        console.log('   blocklyData:', blocklyData);

                        // showDeploymentSuccess expects (result, submitResult, contractData)
                        showDeploymentSuccess(result, deploymentData, blocklyData);
                        console.log('‚úÖ showDeploymentSuccess returned');
                        return;
                    }

                    // Legacy: Iniciar monitoreo de progreso para contratos din√°micos
                    if (result.contractId && result.progressUrl) {
                        console.log('üìä Iniciando monitoreo de progreso para:', result.contractId);
                        window.compilationProgressMonitor.start(result.contractId);

                        // Esperar a que se complete la compilaci√≥n
                        const compilationComplete = await waitForCompilation(result.contractId);

                        if (compilationComplete) {
                            // Mostrar resultado con datos del smart contract
                            window.compilationProgressMonitor.showResult({
                                name: blocklyData.name,
                                symbol: blocklyData.symbol,
                                supply: blocklyData.supply,
                                decimals: blocklyData.decimals || 2,
                                features: blocklyData.features || {}
                            });
                        }
                    }
                } else {
                    const errorData = await response.json();
                    showToast(`‚ùå Error: ${errorData.details || 'Error desconocido'}`, 'error');
                    elements.nextBtn.disabled = false;
                    elements.prevBtn.disabled = false;
                    return;
                }

            } catch (error) {
                console.error('‚ùå Error compilando Smart Contract:', error);
                showToast(`‚ùå Error: ${error.message}`, 'error');

                // Re-habilitar botones
                elements.nextBtn.disabled = false;
                elements.prevBtn.disabled = false;
            }
        }

        // Funci√≥n auxiliar: esperar a que termine la compilaci√≥n
        function waitForCompilation(contractId) {
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    fetch(`/api/compilation-progress/${contractId}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'completed' || data.progress >= 100) {
                                clearInterval(checkInterval);
                                resolve(true);
                            }
                        })
                        .catch(err => {
                            console.error('Error checking compilation:', err);
                        });
                }, 1000);

                // Timeout despu√©s de 10 minutos
                setTimeout(() => {
                    clearInterval(checkInterval);
                    resolve(false);
                }, 600000);
            });
        }

        // Funci√≥n para mostrar las instrucciones de deployment
        function showDeploymentInstructions(instructions) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            let stepsHtml = '';
            if (instructions.setupSteps && Array.isArray(instructions.setupSteps)) {
                stepsHtml = instructions.setupSteps.map((step, index) =>
                    `<div style="margin: 0.5rem 0;">
                        <strong>${index + 1}.</strong> 
                        <code style="background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-family: monospace;">${step}</code>
                    </div>`
                ).join('');
            }

            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 1rem 0; color: #1f2937;">üìã Instrucciones de Deployment</h3>
                    <p style="margin: 0 0 1rem 0; color: #6b7280;">Para desplegar tu smart contract, ejecuta estos comandos en orden:</p>
                    
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0;">
                        ${stepsHtml}
                    </div>
                    
                    <div style="background: #eff6ff; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0;">
                        <p style="margin: 0; color: #1e40af; font-size: 0.9rem;">
                            <strong>‚ÑπÔ∏è Explicaci√≥n de los comandos:</strong><br>
                            1. <strong>generate</strong>: Crea una nueva identity para firmar transacciones<br>
                            2. <strong>fund</strong>: Solicita XLM gratuitos para la testnet<br>
                            3. <strong>deploy</strong>: Despliega el smart contract a la red
                        </p>
                    </div>
                    
                    <p style="margin: 1rem 0 0 0; color: #6b7280; font-size: 0.9rem;">
                        <strong>Instalaci√≥n de Stellar CLI:</strong> 
                        <a href="${instructions.setupGuide || 'https://developers.stellar.org/docs/build/smart-contracts/getting-started/setup'}" target="_blank" style="color: #3b82f6;">Ver gu√≠a oficial</a>
                        <br><br>
                        <strong>Alternativa:</strong> 
                        <a href="${instructions.stellarLaboratory || 'https://laboratory.stellar.org/'}" target="_blank" style="color: #3b82f6;">Usar Stellar Laboratory</a>
                    </p>
                    
                    <button onclick="this.parentElement.parentElement.remove()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; margin-top: 1rem; font-weight: 600;">Entendido</button>
                </div>
            `;

            document.body.appendChild(modal);

            // Cerrar al hacer click fuera del modal
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Funci√≥n para deployar a Stellar Testnet
        async function deployToStellar(wasmBase64, contractData) {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üöÄ STELLAR DEPLOYMENT - BEST PRACTICES MODE');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üì¶ WASM Size:', (wasmBase64.length * 0.75 / 1024).toFixed(2), 'KB');
            console.log('üìã Contract Data:', JSON.stringify(contractData, null, 2));
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            // Verify Freighter is available
            if (!window.freighterApi) {
                throw new Error('Freighter wallet no est√° instalada. Inst√°lala desde freighter.app');
            }

            // Get user's public key
            const userAddress = await window.freighterApi.getPublicKey();
            console.log('üë§ User Address:', userAddress);

            // Initialize Stellar SDK components
            const StellarSdk = window.StellarSdk;

            // Compatibility layer: v14.x uses 'rpc', v12.x uses 'SorobanRpc'
            const SorobanRpc = StellarSdk.rpc || StellarSdk.SorobanRpc;
            if (!SorobanRpc || !SorobanRpc.Server) {
                throw new Error('‚ùå SorobanRpc.Server not available in this SDK version. Check console for SDK structure.');
            }
            console.log('‚úÖ Using SorobanRpc from:', StellarSdk.rpc ? 'StellarSdk.rpc' : 'StellarSdk.SorobanRpc');

            const server = new SorobanRpc.Server('https://soroban-testnet.stellar.org');
            const networkPassphrase = StellarSdk.Networks.TESTNET;

            try {
                // ========================================
                // HELPER: Transaction Polling (Soroban RPC Only)
                // ========================================
                async function pollTransactionWithFallback(txHash, transactionName) {
                    console.log(`‚è±Ô∏è Waiting for ${transactionName} confirmation...`);
                    console.log('üìã Using direct JSON-RPC call (bypasses SDK XDR parsing bug)');

                    const maxAttempts = 60; // 60 attempts √ó 1000ms = 60 seconds max
                    let attempts = 0;

                    while (attempts < maxAttempts) {
                        attempts++;
                        console.log(`   üîç Polling attempt ${attempts}/${maxAttempts}...`);

                        try {
                            // WORKAROUND: Call Soroban RPC directly with fetch to avoid SDK XDR parsing
                            // This bypasses the "Bad union switch: 4" error
                            const response = await fetch('https://soroban-testnet.stellar.org', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    jsonrpc: '2.0',
                                    id: 1,
                                    method: 'getTransaction',
                                    params: { hash: txHash }
                                })
                            });

                            const jsonResponse = await response.json();

                            // Check for RPC errors
                            if (jsonResponse.error) {
                                const errorCode = jsonResponse.error.code;
                                const errorMessage = jsonResponse.error.message;

                                // -32602 = transaction not found (normal during polling)
                                if (errorCode === -32602 || errorMessage?.includes('not found')) {
                                    console.log(`      Status: NOT_FOUND (transaction still pending)`);
                                } else {
                                    console.warn(`      ‚ö†Ô∏è RPC error: ${errorMessage}`);
                                }
                            } else if (jsonResponse.result) {
                                const status = jsonResponse.result.status;
                                console.log(`      Status: ${status}`);

                                if (status === 'SUCCESS') {
                                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                                    console.log(`‚úÖ ${transactionName} CONFIRMED!`);
                                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                                    console.log('   Status:', status);
                                    console.log('   Ledger:', jsonResponse.result.ledger);
                                    console.log('   Latest Ledger:', jsonResponse.result.latestLedger);
                                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                                    // Return in SDK-compatible format
                                    return {
                                        status: status,
                                        hash: txHash,
                                        ledger: jsonResponse.result.ledger,
                                        latestLedger: jsonResponse.result.latestLedger,
                                        resultMetaXdr: jsonResponse.result.resultMetaXdr,
                                        resultXdr: jsonResponse.result.resultXdr
                                    };
                                }

                                if (status === 'FAILED') {
                                    console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                                    console.error(`‚ùå ${transactionName} FAILED`);
                                    console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                                    console.error('   Status:', status);
                                    console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                                    throw new Error(`${transactionName} transaction failed on blockchain`);
                                }

                                // Status is pending/not found - continue polling
                                console.log(`      Status: ${status} (still processing)`);
                            }

                        } catch (error) {
                            // Log non-fetch errors
                            if (error.message !== 'Failed to fetch') {
                                console.warn(`      ‚ö†Ô∏è Polling error: ${error.message}`);
                            }
                        }

                        // Wait 1 second before next attempt (Stellar Testnet can be slow)
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }

                    // Timeout - transaction not confirmed in time
                    console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    console.error('‚ùå TRANSACTION POLLING TIMEOUT');
                    console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    console.error(`‚ùå ${transactionName} transaction timed out after ${maxAttempts} seconds`);
                    console.error('');
                    console.error('üîç POSSIBLE CAUSES:');
                    console.error('   1. Transaction still pending - Stellar Testnet may be VERY slow');
                    console.error('   2. Transaction was rejected (check Stellar Expert)');
                    console.error('   3. Network congestion or outage');
                    console.error('');
                    console.error('üîó MANUAL VERIFICATION:');
                    console.error('   Stellar Expert:', `https://stellar.expert/explorer/testnet/tx/${txHash}`);
                    console.error('   If transaction shows as SUCCESS on Stellar Expert, it worked!');
                    console.error('   You can continue manually with the CREATE transaction.');
                    console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                    throw new Error(`${transactionName} transaction polling timed out after ${maxAttempts}s. Check Stellar Expert: https://stellar.expert/explorer/testnet/tx/${txHash}`);
                }

                // ========================================
                // STEP 1: UPLOAD WASM
                // ========================================
                console.log('\nüì§ STEP 1: UPLOADING WASM TO STELLAR');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                // Get XDR from backend
                const uploadResponse = await fetch('/api/deploy-contract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        wasmBase64,
                        userAddress,
                        contractData
                    })
                });

                if (!uploadResponse.ok) {
                    throw new Error(`Backend error: ${uploadResponse.statusText}`);
                }

                const deployResult = await uploadResponse.json();

                if (!deployResult.success) {
                    throw new Error(deployResult.error || 'Backend deployment failed');
                }

                console.log('‚úÖ Received UPLOAD XDR from backend');
                console.log('   Has UPLOAD XDR:', !!deployResult.uploadTransactionXDR);
                console.log('   WASM ID:', deployResult.wasmId);
                console.log('   Expected Contract ID:', deployResult.contractId);

                // Sign UPLOAD transaction with Freighter
                console.log('\n‚úçÔ∏è Signing UPLOAD transaction with Freighter...');

                const uploadSignedXdr = await window.freighterApi.signTransaction(
                    deployResult.uploadTransactionXDR,
                    { networkPassphrase }
                );

                console.log('‚úÖ UPLOAD transaction signed');
                console.log('   Signed XDR:', uploadSignedXdr.substring(0, 50) + '...');

                // Parse signed XDR
                const uploadTx = new StellarSdk.Transaction(uploadSignedXdr, networkPassphrase);

                // Send transaction
                console.log('\nüì° Sending UPLOAD transaction to Stellar...');

                const uploadSendResponse = await server.sendTransaction(uploadTx);

                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üìä UPLOAD SEND RESPONSE');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('   Status:', uploadSendResponse.status);
                console.log('   Hash:', uploadSendResponse.hash);
                console.log('   Latest Ledger:', uploadSendResponse.latestLedger);
                console.log('   Error XDR:', uploadSendResponse.errorResultXdr || 'N/A');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                // BEST PRACTICE: Verificar status antes de polling
                if (uploadSendResponse.status === 'ERROR') {
                    console.error('‚ùå UPLOAD transaction rejected by network');
                    console.error('   Error XDR:', uploadSendResponse.errorResultXdr);
                    throw new Error(`UPLOAD transaction rejected: ${uploadSendResponse.errorResultXdr}`);
                }

                if (uploadSendResponse.status === 'DUPLICATE') {
                    console.warn('‚ö†Ô∏è UPLOAD transaction is duplicate');
                    console.warn('   This might be a retry - continuing anyway...');
                }

                if (uploadSendResponse.status === 'TRY_AGAIN_LATER') {
                    console.warn('‚ö†Ô∏è Network busy - you should retry');
                    throw new Error('Network busy, please try again in a few seconds');
                }

                // Poll for confirmation usando el m√©todo oficial
                const uploadResult = await pollTransactionWithFallback(
                    uploadSendResponse.hash,
                    'UPLOAD'
                );

                console.log('‚úÖ UPLOAD completed successfully');
                console.log('   Hash:', uploadResult.hash || uploadSendResponse.hash);
                console.log('   Source:', uploadResult.source || 'soroban-rpc');

                // ========================================
                // STEP 2: PREPARE CREATE CONTRACT TRANSACTION
                // ========================================
                console.log('\nüîß STEP 2: PREPARING CREATE CONTRACT TRANSACTION');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('   WASM is now on blockchain - preparing CREATE transaction locally');

                // BEST PRACTICE: Prepare CREATE transaction directly on frontend using Stellar SDK
                // Now that WASM exists on blockchain, we can prepare the CREATE transaction

                // First, get fresh account data (sequence number has changed after UPLOAD)
                console.log('üìä Loading fresh account data from Stellar...');
                const horizonServer = new StellarSdk.Horizon.Server('https://horizon-testnet.stellar.org');
                const sourceAccount = await horizonServer.loadAccount(userAddress);
                console.log('‚úÖ Account loaded, sequence:', sourceAccount.sequence);

                // Build CREATE CONTRACT transaction
                console.log('üî® Building CREATE CONTRACT transaction...');

                // Convert hex string to Uint8Array (browser-compatible, no Buffer needed)
                const hexToBytes = (hex) => {
                    const bytes = new Uint8Array(hex.length / 2);
                    for (let i = 0; i < hex.length; i += 2) {
                        bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
                    }
                    return bytes;
                };

                const wasmHashBytes = hexToBytes(deployResult.wasmId);
                console.log('   WASM hash bytes:', wasmHashBytes.length, 'bytes');

                const createTransaction = new StellarSdk.TransactionBuilder(sourceAccount, {
                    fee: StellarSdk.BASE_FEE, // Will be adjusted by prepareTransaction
                    networkPassphrase: networkPassphrase,
                })
                    .addOperation(
                        StellarSdk.Operation.createCustomContract({
                            address: new StellarSdk.Address(userAddress),
                            wasmHash: wasmHashBytes,
                        })
                    )
                    .setTimeout(300) // 5 minutes
                    .build();

                console.log('‚úÖ CREATE transaction built (unprepared)');
                console.log('   Initial fee:', createTransaction.fee, 'stroops');

                // Prepare transaction with Soroban RPC (adds footprint, calculates real fee)
                console.log('üîß Preparing CREATE transaction with Soroban RPC...');
                console.log('   This simulates the transaction and adds storage footprint');

                let preparedCreateTx;
                try {
                    preparedCreateTx = await server.prepareTransaction(createTransaction);
                    console.log('‚úÖ CREATE transaction prepared successfully!');
                    console.log('   Adjusted fee:', preparedCreateTx.fee, 'stroops');
                    console.log('   Fee in XLM:', (parseInt(preparedCreateTx.fee) / 10000000).toFixed(7));
                } catch (prepError) {
                    console.error('‚ùå Error preparing CREATE transaction:', prepError);
                    console.error('   This means WASM might not be uploaded yet, or network issue');
                    throw new Error(`Failed to prepare CREATE transaction: ${prepError.message}`);
                }

                // ========================================
                // STEP 3: SIGN AND SEND CREATE TRANSACTION
                // ========================================
                console.log('\nüì§ STEP 3: CREATING CONTRACT INSTANCE');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                // Sign CREATE transaction with Freighter
                console.log('‚úçÔ∏è Signing CREATE transaction with Freighter...');

                const createXDR = preparedCreateTx.toXDR();
                console.log('   CREATE XDR length:', createXDR.length);

                const createSignedXdr = await window.freighterApi.signTransaction(
                    createXDR,
                    { networkPassphrase }
                );

                console.log('‚úÖ CREATE transaction signed');

                // Parse signed XDR
                const createTx = new StellarSdk.Transaction(createSignedXdr, networkPassphrase);

                // Send transaction
                console.log('\nüì° Sending CREATE transaction to Stellar...');

                const createSendResponse = await server.sendTransaction(createTx);

                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üìä CREATE SEND RESPONSE');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('   Status:', createSendResponse.status);
                console.log('   Hash:', createSendResponse.hash);
                console.log('   Latest Ledger:', createSendResponse.latestLedger);
                console.log('   Error XDR:', createSendResponse.errorResultXdr || 'N/A');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                // Verificar status
                if (createSendResponse.status === 'ERROR') {
                    console.error('‚ùå CREATE transaction rejected by network');
                    throw new Error(`CREATE transaction rejected: ${createSendResponse.errorResultXdr}`);
                }

                // Poll for confirmation
                const createResult = await pollTransactionWithFallback(
                    createSendResponse.hash,
                    'CREATE'
                );

                console.log('‚úÖ CREATE completed successfully');

                // ========================================
                // STEP 3: EXTRACT CONTRACT ID
                // ========================================
                console.log('\nüîç STEP 3: EXTRACTING CONTRACT ID');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                let realContractId = null; // Will be extracted from XDR

                // IMPORTANT: Extract contract ID from CREATE transaction response XDR
                console.log('üîç Checking CREATE result for contract ID...');
                console.log('   Has createResult:', !!createResult);
                console.log('   Has resultMetaXdr:', !!createResult?.resultMetaXdr);

                if (createResult && createResult.resultMetaXdr) {
                    try {
                        console.log('üìã Parsing transaction meta XDR...');
                        const meta = StellarSdk.xdr.TransactionMeta.fromXDR(
                            createResult.resultMetaXdr,
                            'base64'
                        );

                        console.log('‚úÖ Transaction meta XDR parsed successfully');
                        console.log('   Meta version:', meta.switch());

                        // Extract contract ID from the meta (v3 and v4 have sorobanMeta)
                        const metaVersion = meta.switch();
                        let sorobanMeta = null;

                        if (metaVersion === 3) {
                            console.log('   Meta is v3 (Soroban transaction)');
                            sorobanMeta = meta.v3().sorobanMeta();
                        } else if (metaVersion === 4) {
                            console.log('   Meta is v4 (Soroban transaction - Protocol 24+)');
                            // Meta v4 has the same structure as v3 for sorobanMeta
                            sorobanMeta = meta.v4().sorobanMeta();
                        } else {
                            console.warn('‚ö†Ô∏è Unexpected meta version:', metaVersion);
                        }

                        if (sorobanMeta) {
                            console.log('   ‚úÖ Soroban meta found');
                            const returnValue = sorobanMeta.returnValue();

                            if (returnValue) {
                                console.log('   ‚úÖ Return value found, extracting address...');

                                // Extract address using SDK's Address class and encode to StrKey format
                                const addressObj = StellarSdk.Address.fromScVal(returnValue);

                                // CRITICAL: Use StrKey.encodeContract to get proper C... format (not hex!)
                                const contractIdBytes = addressObj.toBuffer();
                                realContractId = StellarSdk.StrKey.encodeContract(contractIdBytes);

                                console.log('‚úÖ EXTRACTED REAL CONTRACT ID FROM BLOCKCHAIN:');
                                console.log('   Contract ID:', realContractId);
                                console.log('   Format: StrKey (C + base32 encoding)');
                                console.log('   Length:', realContractId.length, 'chars');
                            } else {
                                console.warn('‚ö†Ô∏è Return value is null/undefined');
                            }
                        } else {
                            console.warn('‚ö†Ô∏è Soroban meta is null/undefined');
                        }
                    } catch (extractError) {
                        console.error('‚ùå FAILED TO EXTRACT CONTRACT ID FROM XDR');
                        console.error('   Error:', extractError.message);
                        console.error('   Stack:', extractError.stack);
                    }
                }

                // Fallback: if extraction failed, use backend's expected ID (may be wrong format)
                if (!realContractId || realContractId === 'PENDING_EXTRACTION_FROM_BLOCKCHAIN') {
                    console.warn('‚ö†Ô∏è Could not extract contract ID from XDR response');
                    console.warn('   This should not happen - check transaction meta structure');
                    realContractId = deployResult.contractId; // Last resort fallback
                }

                // ========================================
                // STEP 4: VERIFY CONTRACT EXISTS ON STELLAR
                // ========================================
                console.log('\nüîç STEP 4: VERIFYING CONTRACT ON STELLAR TESTNET');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                let contractVerified = false;
                try {
                    // Try to get contract code to verify it exists
                    const contractCodeResponse = await server.getContractData(
                        realContractId,
                        StellarSdk.xdr.ScVal.scvLedgerKeyContractInstance()
                    );

                    if (contractCodeResponse) {
                        console.log('‚úÖ CONTRACT VERIFIED ON STELLAR TESTNET!');
                        console.log('   Contract exists and is accessible');
                        console.log('   Latest Ledger:', contractCodeResponse.latestLedger);
                        contractVerified = true;
                    }
                } catch (verifyError) {
                    console.warn('‚ö†Ô∏è Could not verify contract immediately:', verifyError.message);
                    console.warn('   This is normal - contract may need a few seconds to be indexed');
                    console.warn('   Contract ID is still valid, verify manually on Stellar Expert');
                    // Don't fail - contract was deployed successfully even if not indexed yet
                    contractVerified = false;
                }

                // ========================================
                // SUCCESS!
                // ========================================
                console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üéâ DEPLOYMENT SUCCESSFUL!');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('   Contract ID:', realContractId);
                console.log('   Contract Verified:', contractVerified ? '‚úÖ YES' : '‚è≥ PENDING INDEXING');
                console.log('   UPLOAD TX:', uploadResult.hash || uploadSendResponse.hash);
                console.log('   CREATE TX:', createResult.hash || createSendResponse.hash);
                console.log('   Network: Stellar Testnet');
                console.log('   Deployment Type: REAL (not simulated)');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üîó VERIFICATION LINKS:');
                console.log('   Contract:', `https://stellar.expert/explorer/testnet/contract/${realContractId}`);
                console.log('   UPLOAD TX:', `https://stellar.expert/explorer/testnet/tx/${uploadSendResponse.hash}`);
                console.log('   CREATE TX:', `https://stellar.expert/explorer/testnet/tx/${createSendResponse.hash}`);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üí∞ FEES PAID (from your Freighter wallet):');
                console.log('   UPLOAD TX: ~0.1-1 XLM (actual fee shown in Freighter)');
                console.log('   CREATE TX: ~0.5 XLM (actual fee shown in Freighter)');
                console.log('   Total: ~0.6-1.5 XLM deducted from your account');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                return {
                    success: true,
                    contractId: realContractId,
                    transactionHash: createSendResponse.hash,
                    hash: createSendResponse.hash,
                    uploadHash: uploadSendResponse.hash,
                    createHash: createSendResponse.hash,
                    contract_address: realContractId,
                    network: 'testnet',
                    deployed: true,
                    realDeployment: true,
                    verified: contractVerified,
                    explorerUrl: `https://stellar.expert/explorer/testnet/contract/${realContractId}`
                };

            } catch (error) {
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.error('‚ùå DEPLOYMENT FAILED');
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.error('   Error:', error.message);
                console.error('   Stack:', error.stack);
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                throw error;
            }
        }

        // Funci√≥n para avanzar al Paso 5 y mostrar resultados del deployment
        function showDeploymentSuccess(result, submitResult, contractData) {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üé® ADVANCING TO STEP 5: DEPLOYMENT RESULTS');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('   result:', result);
            console.log('   submitResult:', submitResult);
            console.log('   contractData:', contractData);

            // CRITICAL: Hide compilation progress UI (if it was shown)
            const compilationStep = document.getElementById('compilationStep');
            const step4Content = document.getElementById('step4Content');
            if (compilationStep) {
                compilationStep.style.display = 'none';
                console.log('‚úÖ compilationStep hidden');
            }
            if (step4Content) {
                step4Content.style.display = 'none';
                console.log('‚úÖ step4Content hidden');
            }

            // Verify Contract ID format before displaying
            console.log('üîç Verifying Contract ID format...');
            console.log('   Current contractId:', submitResult.contractId);
            console.log('   Length:', submitResult.contractId?.length);
            console.log('   Starts with C:', submitResult.contractId?.startsWith('C'));

            // Check if Contract ID is in hex format (invalid) instead of StrKey format
            if (submitResult.contractId && submitResult.contractId.length === 57) {
                // Hex format: C + 56 hex chars (invalid for Stellar)
                console.warn('‚ö†Ô∏è CONTRACT ID APPEARS TO BE IN HEX FORMAT!');
                console.warn('   This format is NOT valid for Stellar Explorer');
                console.warn('   Expected: StrKey format (C + base32, ~56-63 chars)');
                console.warn('   Got:', submitResult.contractId);
            } else if (submitResult.contractId && submitResult.contractId.length >= 56 && submitResult.contractId.length <= 63) {
                console.log('‚úÖ Contract ID appears to be in StrKey format');
            } else {
                console.error('‚ùå Contract ID has unexpected format/length');
            }

            // Advance to Step 5
            goToStep(5);

            // Get the results container in Step 5
            const resultsContainer = document.getElementById('deploymentResults');

            if (!resultsContainer) {
                console.error('‚ùå deploymentResults container not found!');
                return;
            }

            console.log('‚úÖ Found deploymentResults container, injecting content...');

            // Prepare features list
            const features = Object.keys(contractData.features || {})
                .filter(f => contractData.features[f])
                .map(f => {
                    const names = {
                        'mintable': 'Mintable',
                        'burnable': 'Burnable',
                        'pausable': 'Pausable',
                        'upgradeable': 'Upgradeable',
                        'governance': 'Governance',
                        'stakeable': 'Stakeable',
                        'timeLock': 'Time Lock',
                        'accessControl': 'Control de Acceso'
                    };
                    return names[f] || f;
                }).join(', ');

            // Inject the deployment results HTML
            resultsContainer.innerHTML = `
                        <!-- Contract Details Card -->
                        <div class="result-card success">
                            <h3>üìÑ Detalles del Contrato</h3>
                            <div class="result-item">
                                <strong>Nombre:</strong>
                                <span class="result-item-value">${contractData.name || 'N/A'}</span>
                            </div>
                            <div class="result-item">
                                <strong>S√≠mbolo:</strong>
                                <span class="result-item-value">${contractData.symbol || 'N/A'}</span>
                            </div>
                            <div class="result-item">
                                <strong>Suministro Inicial:</strong>
                                <span class="result-item-value">${(contractData.supply || 0).toLocaleString()}</span>
                            </div>
                            <div class="result-item">
                                <strong>Decimales:</strong>
                                <span class="result-item-value">${contractData.decimals || 0}</span>
                            </div>
                            <div class="result-item">
                                <strong>Caracter√≠sticas:</strong>
                                <span class="result-item-value">${features || 'Smart Contract B√°sico'}</span>
                            </div>
                        </div>

                        <!-- Contract ID Section -->
                        <div class="contract-id-section">
                            <div class="contract-id-label">üîó Contract ID</div>
                            <code class="contract-id-code">${submitResult.contractId || submitResult.contract_address || 'Extracting...'}</code>
                            <a href="${submitResult.explorerUrl || ''}" target="_blank" class="explorer-link">
                                üîç Ver Contrato en Stellar Explorer
                                <span class="explorer-arrow">‚Üó</span>
                            </a>
                        </div>

                        <!-- Transaction Hashes -->
                        <div class="result-card info">
                            <h3>üìã Transaction Hashes</h3>
                            ${submitResult.uploadHash ? `
                                <div class="result-item">
                                    <strong>UPLOAD TX:</strong>
                                    <span class="result-item-value">
                                        <a href="https://stellar.expert/explorer/testnet/tx/${submitResult.uploadHash}" target="_blank" class="transaction-link">${submitResult.uploadHash}</a>
                                    </span>
                                </div>
                            ` : ''}
                            <div class="result-item">
                                <strong>CREATE TX:</strong>
                                <span class="result-item-value">
                                    <a href="https://stellar.expert/explorer/testnet/tx/${submitResult.hash || submitResult.createHash}" target="_blank" class="transaction-link">${submitResult.hash || submitResult.createHash || 'N/A'}</a>
                                </span>
                            </div>
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #bfdbfe;">
                                <strong>Estado:</strong>
                                <span class="status-badge success" style="float: right;">‚úÖ Desplegado en Stellar Testnet</span>
                            </div>
                        </div>

                        <!-- Resources -->
                        <div class="resources-grid">
                            <a href="https://github.com/stellar/soroban-cli" target="_blank" class="resource-link">
                                üõ†Ô∏è Soroban CLI
                            </a>
                            <a href="https://soroban.stellar.org/" target="_blank" class="resource-link success">
                                üìö Docs Soroban
                            </a>
                        </div>
                `;

            console.log('‚úÖ Deployment results injected into Step 5');
            console.log('‚úÖ DEPLOYMENT SUCCESS COMPLETE');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        }

        // Funciones para gesti√≥n de proyectos
        function saveCurrentProject() {
            try {
                const projectName = prompt('Nombre del proyecto:', 'Mi Contrato');
                if (!projectName) return;

                projectManager.saveProject(projectName, blocklyWorkspace);
                showToast(`‚úÖ Proyecto '${projectName}' guardado`, 'success');
            } catch (error) {
                showToast(`‚ùå Error guardando proyecto: ${error.message}`, 'error');
            }
        }

        function showProjectsModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 1rem; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: #1f2937;">üìÅ Mis Proyectos</h3>
                        <button onclick="this.closest('div').parentElement.remove()"
                                style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                            Cerrar
                        </button>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        ${projectManager.getProjectsListHTML()}
                    </div>

                    <div style="padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                        <p style="margin: 0 0 0.5rem 0; font-size: 0.85rem; color: #6b7280;">
                            Storage usado: ${(projectManager.getStorageInfo().storageUsed / 1024).toFixed(2)} KB / ${(projectManager.getStorageInfo().storageLimit / 1024 / 1024).toFixed(1)} MB
                        </p>
                        <button onclick="projectManager.clearAll(); location.reload();"
                                style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.85rem;">
                            üóëÔ∏è Borrar todos los proyectos
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Botones de navegaci√≥n
            elements.nextBtn.addEventListener('click', nextStep);
            elements.prevBtn.addEventListener('click', prevStep);

            // Botones de conexi√≥n de wallet
            document.getElementById('connectFreighter').addEventListener('click', () => connectWallet('Freighter'));
            document.getElementById('connectXbull').addEventListener('click', () => connectWallet('xBull'));
            document.getElementById('connectAlbedo').addEventListener('click', () => connectWallet('Albedo'));
            document.getElementById('connectRabet').addEventListener('click', () => connectWallet('Rabet'));

            // Botones de preview y validaci√≥n
            const refreshPreviewBtn = document.getElementById('refreshPreview');
            if (refreshPreviewBtn) {
                refreshPreviewBtn.addEventListener('click', updateCodePreview);
            }

            const validateContractBtn = document.getElementById('validateContract');
            if (validateContractBtn) {
                validateContractBtn.addEventListener('click', () => {
                    const isValid = validateSmartContract();
                    if (isValid) {
                        showToast('‚úÖ Contrato validado correctamente', 'success');
                    } else {
                        showToast('‚ùå Se encontraron errores en el contrato', 'error');
                    }
                });
            }

            const viewFullCodeBtn = document.getElementById('viewFullCode');
            if (viewFullCodeBtn) {
                viewFullCodeBtn.addEventListener('click', () => {
                    const blocklyData = readBlocklyData();
                    if (blocklyData && blocklyData.name) {
                        const fullCode = generateAdvancedRustCode(blocklyData);

                        // Crear modal para mostrar c√≥digo completo
                        const modal = document.createElement('div');
                        modal.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0,0,0,0.8);
                            z-index: 1000;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            padding: 2rem;
                        `;

                        modal.innerHTML = `
                            <div style="background: white; border-radius: 1rem; padding: 2rem; max-width: 80%; max-height: 80%; overflow: auto;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h3>üìÑ C√≥digo Completo del Smart Contract</h3>
                                    <button id="closeCodeModal" style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">‚úï Cerrar</button>
                                </div>
                                <pre style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; overflow: auto; font-size: 0.875rem; line-height: 1.5;">${fullCode}</pre>
                                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                                    <button id="downloadCode" style="background: #6366f1; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;">üì• Descargar</button>
                                    <button id="copyCode" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;">üìã Copiar</button>
                                </div>
                            </div>
                        `;

                        document.body.appendChild(modal);

                        // Event listeners del modal
                        document.getElementById('closeCodeModal').addEventListener('click', () => {
                            modal.remove();
                        });

                        document.getElementById('downloadCode').addEventListener('click', () => {
                            const blob = new Blob([fullCode], { type: 'text/rust' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `${blocklyData.symbol || 'token'}_contract.rs`;
                            a.click();
                            URL.revokeObjectURL(url);
                            showToast('üì• C√≥digo descargado', 'success');
                        });

                        document.getElementById('copyCode').addEventListener('click', async () => {
                            try {
                                await navigator.clipboard.writeText(fullCode);
                                showToast('üìã C√≥digo copiado al portapapeles', 'success');
                            } catch (err) {
                                showToast('‚ùå Error al copiar c√≥digo', 'error');
                            }
                        });

                        // Cerrar modal al hacer clic fuera
                        modal.addEventListener('click', (e) => {
                            if (e.target === modal) {
                                modal.remove();
                            }
                        });
                    } else {
                        showToast('‚ö†Ô∏è Configura los bloques primero', 'error');
                    }
                });
            }

            // Efectos de hover para las opciones de wallet
            document.querySelectorAll('.wallet-option').forEach(option => {
                option.addEventListener('mouseenter', function () {
                    this.style.transform = 'translateY(-6px) scale(1.05)';
                });

                option.addEventListener('mouseleave', function () {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });

            // Inicializar stepper
            updateStepper();
        });

    </script>
</body>

</html>