<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tralalero Contracts - Crea tu Smart Contract con bloques</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Schabo+Condensed:wght@400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="main-container">
        <!-- Grid Pattern Background -->
        <div id="gridBackground" class="grid-background"></div>

        <!-- Header -->
        <div class="header">
            <div class="logo-container">
                <video src="/tralala.mp4" alt="Tralalero Contracts Video Logo" class="logo" autoplay muted loop
                    playsinline></video>
                <h1 class="title">
                    <span class="title-line1">TRALALA</span>
                    <span class="title-line2">CONTRACTS</span>
                </h1>
            </div>
        </div>
        <!-- Stepper Container -->
        <div class="stepper-container">
            <!-- Stepper Progress -->
            <div class="stepper">
                <div class="stepper-line" id="stepperLine"></div>
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Conectar Wallet</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Seleccionar Plantilla</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Configurar con Bloques</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Revisar y Desplegar</div>
                </div>
            </div>

            <!-- Step Content -->
            <div class="step-content active" id="step1">
                <div class="wallets-container">
                    <div class="description-box">
                        <h2 class="wallets-title">Conecta tu billetera y empieza a construir tu smart contract</h2>
                    </div>
                    <div class="wallet-options">
                        <div class="wallet-option" id="connectFreighter">
                            <div class="wallet-icon">ü¶ä</div>
                            <div class="wallet-label">Freighter</div>
                        </div>
                        <div class="wallet-option" id="connectXbull">
                            <div class="wallet-icon">üêÇ</div>
                            <div class="wallet-label">xBull</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Template Selection -->
            <div class="step-content" id="step2">
                <div class="templates-container">
                    <div class="description-box">
                        <h2 class="wallets-title">Elige una plantilla para comenzar</h2>
                        <p class="wallets-title">Selecciona un caso de uso com√∫n que se adapte a tu necesidad. Puedes personalizarlo completamente con bloques.</p>
                    </div>
                    <div class="templates-grid">
                        <div class="template-card" id="templateBasic" data-template="basic">
                            <div class="template-icon">üí∞</div>
                            <div class="template-name">Token B√°sico</div>
                            <div class="template-desc">Un token fungible simple con funciones de transferencia</div>
                            <ul class="template-features">
                                <li>‚úì Crear y transferir tokens</li>
                                <li>‚úì Consultar saldo</li>
                                <li>‚úì Aprobar transferencias</li>
                            </ul>
                        </div>
                        <div class="template-card" id="templateRWA" data-template="rwa">
                            <div class="template-icon">üè¢</div>
                            <div class="template-name">RWA (Activos Reales)</div>
                            <div class="template-desc">Token respaldado por activos del mundo real</div>
                            <ul class="template-features">
                                <li>‚úì Custodia de activos</li>
                                <li>‚úì Cumplimiento regulatorio</li>
                                <li>‚úì Redenci√≥n de activos</li>
                            </ul>
                        </div>
                        <div class="template-card" id="templateDeFi" data-template="defi">
                            <div class="template-icon">üîÑ</div>
                            <div class="template-name">DeFi (Finanzas Descentralizadas)</div>
                            <div class="template-desc">Token con features avanzadas para aplicaciones DeFi</div>
                            <ul class="template-features">
                                <li>‚úì Mint y Burn</li>
                                <li>‚úì Pausable</li>
                                <li>‚úì Control de acceso</li>
                                <li>‚úì L√≠mites de transferencia</li>
                            </ul>
                        </div>
                    </div>
                    <div style="margin-top: 2rem; text-align: center; color: #6b7280;">
                        <p>O crea un contrato personalizado desde cero ‚Üí</p>
                    </div>
                </div>
            </div>

            <!-- Step 3: Smart Contract Configuration -->
            <div class="step-content" id="step3">
                <div class="blockly-container">
                    <div class="description-box">
                        <h2 class="wallets-title">¬°Arrastra y conecta los bloques!</h2>
                        <p class="wallets-title">Usa los bloques de la izquierda para modelar tu smart contract. <br />
                            Arrastra el bloque "üîÆ Mi Smart Contract" y conecta los bloques de
                            propiedades/estado/funciones.</p>
                    </div>
                    <div id="blocklyDiv"></div>
                </div>
            </div>

            <!-- Step 4: Smart Contract Configuration -->
            <div class="step-content" id="step4">
                <div class="smart-contract-container">
                    <div class="description-box">
                        <h2 class="wallets-title">‚öôÔ∏è Configuraci√≥n Avanzada del Smart Contract</h2>
                        <p class="wallets-title">Arrastra m√°s bloques para a√±adir funcionalidades y construir tu contrato.</p>
                    </div>

                    <!-- Preview del C√≥digo -->
                    <div class="code-preview-section">
                        <div class="preview-header">
                            <h3>üìã Vista Previa del C√≥digo</h3>
                            <div class="preview-actions">
                                <button class="btn btn-secondary" id="refreshPreview">üîÑ Actualizar</button>
                                <button class="btn btn-secondary" id="validateContract">‚úÖ Validar</button>
                                <button class="btn btn-secondary" id="viewFullCode">üëÅÔ∏è Ver C√≥digo Completo</button>
                            </div>
                        </div>
                        <div class="code-preview" id="codePreview">
                            <pre
                                id="contractPreview">// El c√≥digo se generar√° autom√°ticamente cuando configures los bloques...</pre>
                        </div>
                        <div class="validation-result hidden" id="validationResult">
                            <div id="validationMessage"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Review and Deploy -->
            <div class="step-content" id="step4">
                <div class="create-token-container">
                    <h2 class="step-title">üöÄ Revisa y exporta tu Smart Contract</h2>

                    <!-- Resumen del Contrato -->
                    <div class="contract-summary" id="contractSummary">
                        <h3>üìÑ Resumen del Contrato</h3>
                        <div class="summary-grid" id="summaryGrid">
                            <div class="summary-item">
                                <strong>Tipo:</strong> <span id="summaryType">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Nombre:</strong> <span id="summaryName">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>S√≠mbolo:</strong> <span id="summarySymbol">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Cantidad Inicial:</strong> <span id="summarySupply">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Caracter√≠sticas:</strong> <span id="summaryFeatures">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Licencia:</strong> <span id="summaryLicense">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Administrador:</strong> <span id="summaryAdmin">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Red:</strong> <span id="summaryNetwork">Stellar Testnet</span>
                            </div>
                        </div>
                    </div>

                    <!-- Progreso de Despliegue -->
                    <div class="deployment-pipeline" id="deploymentPipeline">
                        <div class="pipeline-step" id="pipelineValidation">
                            <div class="step-icon">üîç</div>
                            <div class="step-info">
                                <h4>Validaci√≥n</h4>
                                <p>Verificando configuraci√≥n del contrato...</p>
                            </div>
                            <div class="step-status pending">‚è≥</div>
                        </div>

                        <div class="pipeline-step" id="pipelineCompilation">
                            <div class="step-icon">‚öôÔ∏è</div>
                            <div class="step-info">
                                <h4>Compilaci√≥n</h4>
                                <p>Generando c√≥digo Rust del smart contract...</p>
                            </div>
                            <div class="step-status pending">‚è≥</div>
                        </div>

                        <div class="pipeline-step" id="pipelineWasm">
                            <div class="step-icon">üì¶</div>
                            <div class="step-info">
                                <h4>Build WASM</h4>
                                <p>Compilando a WebAssembly optimizado...</p>
                            </div>
                            <div class="step-status pending">‚è≥</div>
                        </div>

                        <div class="pipeline-step" id="pipelineDeployment">
                            <div class="step-icon">üì¶</div>
                            <div class="step-info">
                                <h4>Exportaci√≥n</h4>
                                <p>Preparando c√≥digo para descargar/copiar...</p>
                            </div>
                            <div class="step-status pending">‚è≥</div>
                        </div>
                    </div>

                    <!-- Estado de Despliegue -->
                    <div class="deployment-status hidden" id="deploymentStatus">
                        <div class="deployment-message" id="deploymentMessage">Preparando despliegue...</div>
                        <div class="deployment-progress">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                    </div>

                    <!-- Resultado del Despliegue -->
                    <div class="deployment-result hidden" id="deploymentResult">
                        <div class="result-content" id="resultContent"></div>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="stepper-navigation">
                <button class="btn btn-secondary" id="prevBtn" disabled>Anterior</button>
                <button class="btn btn-primary" id="nextBtn">Siguiente</button>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stellar/stellar-sdk@11.3.0/dist/stellar-sdk.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stellar/freighter-api@1.7.0/build/index.min.js"></script>
    <script src="https://unpkg.com/albedo-sdk@^0.10.4/dist/albedo.min.js"></script>
    <script src="blockly-templates.js"></script>
    <script src="rust-generator.js"></script>
    <script src="contract-validator.js"></script>
    <script src="project-manager.js"></script>
    <script src="blocks-definitions.js"></script>
    <script>
        // Estado global de la aplicaci√≥n
        const appState = {
            currentStep: 1,
            totalSteps: 4,
            walletConnected: false,
            walletAddress: null,
            walletType: null,
            selectedTemplate: null,
            contractCompiled: false,
            contractValidated: false,
            tokenData: {
                // Configuraci√≥n b√°sica
                tokenType: 'SMART_CONTRACT',
                contractType: 'TOKEN',
                name: '',
                symbol: '',
                supply: 0,
                decimals: 2,
                adminAddress: '',

                // Caracter√≠sticas avanzadas
                features: {
                    mintable: false,
                    burnable: false,
                    pausable: false,
                    upgradeable: false,
                    accessControl: false,
                    governance: false,
                    stakeable: false,
                    timeLock: false,
                    multiSig: false
                },

                // Configuraci√≥n de seguridad
                security: {
                    transferLimit: 0,
                    dailyLimit: 0,
                    whitelistEnabled: false,
                    freezeable: false,
                    recoverableKeys: false
                },

                // Informaci√≥n del contrato
                metadata: {
                    securityContact: '',
                    license: 'MIT',
                    version: '1.0.0',
                    description: '',
                    website: '',
                    logoUrl: ''
                },

                // Configuraci√≥n avanzada
                economics: {
                    transactionFee: 0,
                    burnRate: 0,
                    stakingReward: 0,
                    inflationRate: 0
                },

                // Backward compatibility
                initialSupply: 0
            }
        };

        // Variable global para el workspace de Blockly
        let blocklyWorkspace = null;

        // Elementos del DOM
        const elements = {
            stepper: document.querySelector('.stepper'),
            stepperLine: document.getElementById('stepperLine'),
            steps: document.querySelectorAll('.step'),
            stepContents: document.querySelectorAll('.step-content'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),

            // Summary elements
            tokenSummary: document.getElementById('tokenSummary'),
            summaryType: document.getElementById('summaryType'),
            summaryName: document.getElementById('summaryName'),
            summarySymbol: document.getElementById('summarySymbol'),
            summarySupply: document.getElementById('summarySupply'),
            summaryFeatures: document.getElementById('summaryFeatures'),
            summaryLicense: document.getElementById('summaryLicense'),
            summaryAdmin: document.getElementById('summaryAdmin'),

            // Deployment elements
            deploymentStatus: document.getElementById('deploymentStatus'),
            deploymentMessage: document.getElementById('deploymentMessage'),
            deploymentResult: document.getElementById('deploymentResult'),
            resultContent: document.getElementById('resultContent')
        };

        // Funciones del stepper
        function updateStepper() {
            // Actualizar pasos
            elements.steps.forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed');

                if (stepNumber === appState.currentStep) {
                    step.classList.add('active');
                } else if (stepNumber < appState.currentStep) {
                    step.classList.add('completed');
                }
            });

            // Actualizar contenido de pasos con transici√≥n suave
            elements.stepContents.forEach((content, index) => {
                content.classList.remove('active');
                if (index + 1 === appState.currentStep) {
                    // Peque√±o delay para permitir que la transici√≥n anterior termine
                    setTimeout(() => {
                        content.classList.add('active');
                    }, 50);
                }
            });

            // Actualizar l√≠nea de progreso con transici√≥n suave
            const progress = ((appState.currentStep - 1) / (appState.totalSteps - 1)) * 100;
            elements.stepperLine.style.transition = 'width 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            elements.stepperLine.style.width = `${progress}%`;

            // Actualizar botones
            elements.prevBtn.disabled = appState.currentStep === 1;

            if (appState.currentStep === appState.totalSteps) {
                elements.nextBtn.textContent = 'Crear Token';
            } else {
                elements.nextBtn.textContent = 'Siguiente';
            }

            // Actualizar contenido din√°mico seg√∫n el paso
            updateStepContent();
        }

        function goToStep(stepNumber) {
            if (stepNumber >= 1 && stepNumber <= appState.totalSteps) {
                appState.currentStep = stepNumber;
                updateStepper();
            }
        }

        function nextStep() {
            if (validateCurrentStep()) {
                if (appState.currentStep < appState.totalSteps) {
                    goToStep(appState.currentStep + 1);
                } else {
                    deployToken();
                }
            }
        }

        function prevStep() {
            if (appState.currentStep > 1) {
                goToStep(appState.currentStep - 1);
            }
        }

        function updateStepContent() {
            switch (appState.currentStep) {
                case 2:
                    // Agregar event listeners a las tarjetas de plantillas
                    addTemplateListeners();
                    break;
                case 3:
                    // Inicializar Blockly cuando se llega al paso 3
                    if (!blocklyWorkspace) {
                        initializeBlockly();
                    } else {
                        // Forzar re-render si ya existe
                        blocklyWorkspace.render();
                    }
                    break;
                case 4:
                    // Configuraci√≥n avanzada de smart contracts
                    if (!blocklyWorkspace) {
                        initializeBlockly();
                    } else {
                        blocklyWorkspace.render();
                    }
                    // Actualizar preview despu√©s de asegurar que Blockly est√© listo
                    setTimeout(() => updateCodePreview(), 100);
                    updateTokenSummary();
                    updateDeploymentPipeline();
                    break;
            }
        }

        function addTemplateListeners() {
            const templateCards = document.querySelectorAll('.template-card');
            templateCards.forEach(card => {
                card.addEventListener('click', function() {
                    // Remover selecci√≥n anterior
                    templateCards.forEach(c => c.classList.remove('selected'));
                    // Agregar selecci√≥n a la tarjeta actual
                    this.classList.add('selected');

                    const template = this.getAttribute('data-template');
                    appState.selectedTemplate = template;
                    console.log('üìã Plantilla seleccionada:', template);
                    applyTemplate(template);
                });
            });
        }

        function applyTemplate(template) {
            // Las plantillas se aplicar√°n cuando se inicialice Blockly en el paso 3
            console.log('üé® Aplicando plantilla:', template);

            // Guardar la plantilla en appState para usarla cuando se inicialice Blockly
            appState.selectedTemplate = template;

            // Mostrar mensaje
            showToast(`‚úÖ Plantilla "${template.toUpperCase()}" seleccionada`, 'success');
        }

        // Funci√≥n para actualizar el preview del c√≥digo
        function updateCodePreview() {
            const contractPreview = document.getElementById('contractPreview');
            if (!contractPreview) return;

            // Validar que el workspace est√© inicializado
            if (!blocklyWorkspace) {
                contractPreview.textContent = '// Blockly a√∫n se est√° inicializando...';
                console.warn('‚ö†Ô∏è Blockly workspace no est√° disponible');
                return;
            }

            try {
                // Primero intentar generar desde bloques con el nuevo generador
                const contractBlock = blocklyWorkspace.getBlocksByType('contract_settings', false)[0];
                if (contractBlock) {
                    try {
                        const generatedCode = rustGen.generateContract(contractBlock);
                        contractPreview.textContent = generatedCode;
                        console.log('‚úÖ C√≥digo generado desde bloques correctamente');
                        return;
                    } catch (blockError) {
                        console.warn('‚ö†Ô∏è Error generando desde bloques, usando fallback:', blockError);
                    }
                }

                // Fallback: usar m√©todo anterior
                const blocklyData = readBlocklyData();
                if (!blocklyData || !blocklyData.name) {
                    contractPreview.textContent = '// Configura el nombre de tu contrato para ver el preview...\n// Arrastra bloques desde la izquierda';
                    return;
                }

                const rustCode = generateAdvancedRustCode(blocklyData);
                contractPreview.textContent = rustCode;
                console.log('‚úÖ Preview actualizado con m√©todo fallback');
            } catch (error) {
                console.error('‚ùå Error actualizando preview:', error);
                contractPreview.textContent = `// Error generando preview:\n// ${error.message}`;
            }
        }

        // Funci√≥n para generar c√≥digo Rust avanzado
        function generateAdvancedRustCode(data) {
            const features = [];
            const dataFeatures = data.features || {};
            const dataSecurity = data.security || {};
            const dataEconomics = data.economics || {};

            if (dataFeatures.mintable) features.push('Mintable');
            if (dataFeatures.burnable) features.push('Burnable');
            if (dataFeatures.pausable) features.push('Pausable');
            if (dataFeatures.upgradeable) features.push('Upgradeable');
            if (dataFeatures.governance) features.push('Governance');
            if (dataFeatures.stakeable) features.push('Stakeable');
            if (dataFeatures.timeLock) features.push('TimeLock');
            if (dataFeatures.accessControl) features.push('AccessControl');

            return `// Smart Contract: ${data.name || 'Mi Token'}
// Generado autom√°ticamente por Tralalero Contracts
#![no_std]

use soroban_sdk::{
    contract, contractimpl, Address, Env, String, Symbol, Map,
    token::{self, Interface as TokenInterface},
    auth::{Context, CustomAccountInterface},
    ${dataFeatures.governance ? 'governance::GovernanceInterface,' : ''}
    ${dataFeatures.stakeable ? 'staking::StakingInterface,' : ''}
};

// Constantes del contrato
const TOKEN_NAME: &str = "${data.name || 'Mi Token'}";
const TOKEN_SYMBOL: &str = "${data.symbol || 'TOKEN'}";
const DECIMALS: u32 = ${data.decimals || 2};
const INITIAL_SUPPLY: i128 = ${data.supply || 1000};

// Claves de almacenamiento
const ADMIN: Symbol = symbol_short!("ADMIN");
const PAUSED: Symbol = symbol_short!("PAUSED");
const TOTAL_SUPPLY: Symbol = symbol_short!("TOTAL_SUP");
${dataSecurity.transferLimit ? `const TRANSFER_LIMIT: Symbol = symbol_short!("TRANS_LIM");` : ''}
${dataFeatures.stakeable ? `const STAKING_POOL: Symbol = symbol_short!("STAKING");` : ''}

#[contract]
pub struct TokenContract;

#[contractimpl]
impl TokenContract {
    
    /// Inicializa el contrato con configuraci√≥n personalizada
    pub fn initialize(env: Env, admin: Address) {
        if env.storage().instance().has(&ADMIN) {
            panic!("Contract already initialized");
        }

        env.storage().instance().set(&ADMIN, &admin);
        env.storage().instance().set(&TOTAL_SUPPLY, &INITIAL_SUPPLY);
        ${dataFeatures.pausable ? 'env.storage().instance().set(&PAUSED, &false);' : ''}
        ${dataSecurity.transferLimit ? `env.storage().instance().set(&TRANSFER_LIMIT, &${dataSecurity.transferLimit});` : ''}

        // Mint inicial al admin
        if INITIAL_SUPPLY > 0 {
            token::Client::new(&env, &env.current_contract_address())
                .mint(&admin, &INITIAL_SUPPLY);
        }
    }

    /// Metadata del token
    pub fn name(env: Env) -> String {
        String::from_str(&env, TOKEN_NAME)
    }

    pub fn symbol(env: Env) -> String {
        String::from_str(&env, TOKEN_SYMBOL)
    }

    pub fn decimals(env: Env) -> u32 {
        DECIMALS
    }

    ${dataFeatures.mintable ? `
    /// Mint nuevos tokens (solo admin)
    pub fn mint(env: Env, to: Address, amount: i128) {
        Self::check_admin(&env);
        ${dataFeatures.pausable ? 'Self::check_not_paused(&env);' : ''}

        token::Client::new(&env, &env.current_contract_address())
            .mint(&to, &amount);
    }` : ''}

    ${dataFeatures.burnable ? `
    /// Burn tokens
    pub fn burn(env: Env, from: Address, amount: i128) {
        from.require_auth();
        ${dataFeatures.pausable ? 'Self::check_not_paused(&env);' : ''}

        token::Client::new(&env, &env.current_contract_address())
            .burn(&from, &amount);
    }` : ''}

    ${dataFeatures.pausable ? `
    /// Pausar el contrato (solo admin)
    pub fn pause(env: Env) {
        Self::check_admin(&env);
        env.storage().instance().set(&PAUSED, &true);
    }

    /// Despausar el contrato (solo admin)
    pub fn unpause(env: Env) {
        Self::check_admin(&env);
        env.storage().instance().set(&PAUSED, &false);
    }` : ''}

    ${dataFeatures.stakeable ? `
    /// Hacer staking de tokens
    pub fn stake(env: Env, from: Address, amount: i128) {
        from.require_auth();
        Self::check_not_paused(&env);

        // L√≥gica de staking...
        // TODO: Implementar pool de staking
    }` : ''}

    /// Funciones auxiliares
    fn check_admin(env: &Env) {
        let admin: Address = env.storage().instance().get(&ADMIN).unwrap();
        admin.require_auth();
    }

    ${dataFeatures.pausable ? `
    fn check_not_paused(env: &Env) {
        let paused: bool = env.storage().instance().get(&PAUSED).unwrap_or(false);
        if paused {
            panic!("Contract is paused");
        }
    }` : ''}
}

// Caracter√≠sticas habilitadas: ${features.join(', ') || 'Ninguna'}
// L√≠mite de transferencia: ${dataSecurity.transferLimit || 'Sin l√≠mite'}
// Recompensa de staking: ${dataEconomics.stakingReward || 0}% anual
// Fee de transacci√≥n: ${dataEconomics.transactionFee || 0}%
// Burn rate: ${dataEconomics.burnRate || 0}%`;
        }

        // Funci√≥n para validar el contrato
        function validateSmartContract() {
            const validationResult = document.getElementById('validationResult');
            const validationMessage = document.getElementById('validationMessage');

            if (!validationResult || !validationMessage) return false;

            if (!blocklyWorkspace) {
                validationMessage.innerHTML = `
                    <div style="color: #dc2626; font-weight: bold;">‚ùå Blockly no est√° inicializado</div>
                `;
                validationResult.classList.remove('hidden');
                validationResult.style.backgroundColor = '#fef2f2';
                validationResult.style.borderColor = '#dc2626';
                appState.contractValidated = false;
                return false;
            }

            // Usar el validador profesional
            const report = validator.validate(blocklyWorkspace);

            // Mostrar resultados
            validationResult.classList.remove('hidden');
            validationMessage.innerHTML = validator.toHTML();

            if (!report.isValid) {
                validationResult.style.backgroundColor = '#fef2f2';
                validationResult.style.borderColor = '#dc2626';
                appState.contractValidated = false;
                return false;
            } else if (report.warningCount > 0) {
                validationResult.style.backgroundColor = '#fffbeb';
                validationResult.style.borderColor = '#d97706';
                appState.contractValidated = true;
                return true;
            } else {
                validationResult.style.backgroundColor = '#f0fdf4';
                validationResult.style.borderColor = '#059669';
                appState.contractValidated = true;
                return true;
            }
        }

        // Funci√≥n para actualizar el pipeline de despliegue
        function updateDeploymentPipeline() {
            const pipeline = document.getElementById('deploymentPipeline');
            if (!pipeline) return;

            // Resetear estados
            const steps = pipeline.querySelectorAll('.pipeline-step');
            steps.forEach(step => {
                const status = step.querySelector('.step-status');
                status.className = 'step-status pending';
                status.textContent = '‚è≥';
            });

            // Marcar validaci√≥n como completada si est√° validado
            if (appState.contractValidated) {
                const validationStep = document.getElementById('pipelineValidation');
                if (validationStep) {
                    const status = validationStep.querySelector('.step-status');
                    status.className = 'step-status completed';
                    status.textContent = '‚úÖ';
                }
            }
        }

        // Funci√≥n para actualizar un paso espec√≠fico del pipeline
        async function updatePipelineStep(stepId, status, message) {
            const step = document.getElementById(stepId);
            if (!step) return;

            const stepStatus = step.querySelector('.step-status');
            const stepInfo = step.querySelector('.step-info p');

            // Remover clases anteriores
            step.className = 'pipeline-step';
            stepStatus.className = 'step-status';

            // A√±adir nueva clase y actualizar contenido
            step.classList.add(status);
            stepStatus.classList.add(status);

            switch (status) {
                case 'active':
                    stepStatus.textContent = 'üîÑ';
                    step.style.animation = 'pulse 1.5s infinite';
                    break;
                case 'completed':
                    stepStatus.textContent = '‚úÖ';
                    step.style.animation = 'none';
                    break;
                case 'error':
                    stepStatus.textContent = '‚ùå';
                    step.style.animation = 'none';
                    break;
                default:
                    stepStatus.textContent = '‚è≥';
                    step.style.animation = 'none';
            }

            if (message && stepInfo) {
                stepInfo.textContent = message;
            }

            // Peque√±a animaci√≥n para mostrar progreso
            if (status === 'completed') {
                step.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    step.style.transform = 'scale(1)';
                }, 300);
            }
        }

        // Funciones de Blockly
        function initializeBlockly() {
            if (typeof Blockly === 'undefined') {
                console.error('Blockly no est√° cargado');
                return;
            }

            // Agregar bloque de settings para compatibilidad con c√≥digo existente
            if (!Blockly.Blocks['contract_settings']) {
                Blockly.Blocks['contract_settings'] = {
                    init: function() {
                        this.appendDummyInput()
                            .appendField("üîÆ Mi Smart Contract");
                        this.appendStatementInput("SETTINGS")
                            .setCheck(null);
                        this.setColour("#8E24AA");
                        this.setTooltip("Bloque principal del contrato");
                    }
                };
            }

            // Crear workspace de Blockly con todas las categor√≠as
            blocklyWorkspace = Blockly.inject('blocklyDiv', {
                toolbox: `
                    <xml>
                        <category name="üöÄ Empezar" colour="#8E24AA">
                            <block type="contract_init"></block>
                            <block type="contract_metadata"></block>
                        </category>

                        <category name="üé® Propiedades" colour="#1E88E5">
                            <block type="contract_name"></block>
                            <block type="contract_version"></block>
                            <block type="contract_owner"></block>
                            <block type="admin_address"></block>
                            <block type="contract_description"></block>
                        </category>

                        <category name="üì¶ Estado" colour="#5E35B1">
                            <block type="state_variable"></block>
                            <block type="state_map"></block>
                            <block type="state_event"></block>
                            <block type="event_parameter"></block>
                        </category>

                        <category name="‚öôÔ∏è Funciones" colour="#FF8F00">
                            <block type="function_declaration"></block>
                            <block type="function_parameter"></block>
                            <block type="function_return"></block>
                        </category>

                        <category name="üß† L√≥gica" colour="#E91E63">
                            <block type="if_statement"></block>
                            <block type="comparison_operator"></block>
                            <block type="logical_operator"></block>
                            <block type="loop_while"></block>
                            <block type="loop_for"></block>
                        </category>

                        <category name="üî¢ Operaciones" colour="#4CAF50">
                            <block type="arithmetic_operation"></block>
                            <block type="variable_assignment"></block>
                            <block type="increment_decrement"></block>
                            <block type="number_literal"></block>
                            <block type="string_literal"></block>
                            <block type="boolean_literal"></block>
                        </category>

                        <category name="‚≠ê Stellar" colour="#FFC107">
                            <block type="stellar_transfer"></block>
                            <block type="stellar_payment"></block>
                            <block type="stellar_trust_line"></block>
                            <block type="stellar_require_auth"></block>
                            <block type="stellar_context"></block>
                        </category>

                        <category name="üí∞ Token" colour="#7B1FA2">
                            <block type="token_symbol"></block>
                            <block type="token_supply"></block>
                            <block type="token_decimals"></block>
                            <block type="token_init"></block>
                            <block type="token_mint"></block>
                            <block type="token_burn"></block>
                            <block type="token_transfer"></block>
                            <block type="token_balance"></block>
                            <block type="token_allowance"></block>
                        </category>

                        <category name="üè¢ RWA" colour="#C62828">
                            <block type="rwa_asset"></block>
                            <block type="rwa_custody"></block>
                            <block type="rwa_settlement"></block>
                            <block type="rwa_compliance"></block>
                            <block type="rwa_redemption"></block>
                        </category>

                        <category name="üîê Seguridad" colour="#D32F2F">
                            <block type="require_condition"></block>
                            <block type="access_control"></block>
                            <block type="role_based_check"></block>
                            <block type="reentrancy_guard"></block>
                            <block type="pause_functionality"></block>
                        </category>
                    </xml>
                `,
                scrollbars: true,
                trashcan: true,
                zoom: {
                    controls: true,
                    wheel: true,
                    startScale: 1.0,
                    maxScale: 3,
                    minScale: 0.3,
                    scaleSpeed: 1.2
                },
                theme: Blockly.Themes.Modern
            });

            // Agregar listeners para actualizar preview en tiempo real
            blocklyWorkspace.addChangeListener(function(event) {
                // Solo actualizar en step 3
                if (appState.currentStep === 3) {
                    // Usar debounce para evitar actualizaciones demasiado frecuentes
                    clearTimeout(window.previewUpdateTimeout);
                    window.previewUpdateTimeout = setTimeout(() => {
                        updateCodePreview();
                    }, 300);
                }
            });

            console.log('‚úÖ Blockly inicializado correctamente');

            // Crear bloques por defecto
            createDefaultBlocks();
        }

        function createDefaultBlocks() {
            if (!blocklyWorkspace) return;

            // Limpiar workspace
            blocklyWorkspace.clear();

            try {
                // Crear el bloque principal del contrato
                const contractBlock = blocklyWorkspace.newBlock('contract_settings');
                if (!contractBlock) {
                    console.error('‚ùå No se pudo crear el bloque de contrato');
                    return;
                }
                contractBlock.initSvg();
                contractBlock.render();
                contractBlock.moveBy(50, 50);

                // Crear bloques b√°sicos sugeridos
                const blocks = [];

                // Bloque de nombre del contrato
                const nameBlock = blocklyWorkspace.newBlock('contract_name');
                if (nameBlock) {
                    nameBlock.initSvg();
                    nameBlock.render();
                    nameBlock.setFieldValue('MiContrato', 'NAME');
                    blocks.push(nameBlock);
                }

                // Bloque de versi√≥n
                const versionBlock = blocklyWorkspace.newBlock('contract_version');
                if (versionBlock) {
                    versionBlock.initSvg();
                    versionBlock.render();
                    versionBlock.setFieldValue('1.0.0', 'VERSION');
                    blocks.push(versionBlock);
                }

                // Bloque de administrador
                const adminBlock = blocklyWorkspace.newBlock('admin_address');
                if (adminBlock) {
                    adminBlock.initSvg();
                    adminBlock.render();
                    adminBlock.setFieldValue('G...', 'ADDRESS');
                    blocks.push(adminBlock);
                }

                // Bloque de variable de estado
                const stateVarBlock = blocklyWorkspace.newBlock('state_variable');
                if (stateVarBlock) {
                    stateVarBlock.initSvg();
                    stateVarBlock.render();
                    stateVarBlock.setFieldValue('totalSupply', 'VAR_NAME');
                    stateVarBlock.setFieldValue('I128', 'VAR_TYPE');
                    stateVarBlock.setFieldValue('0', 'INIT_VALUE');
                    blocks.push(stateVarBlock);
                }

                // Bloque de funci√≥n
                const fnBlock = blocklyWorkspace.newBlock('function_declaration');
                if (fnBlock) {
                    fnBlock.initSvg();
                    fnBlock.render();
                    fnBlock.setFieldValue('transfer', 'FN_NAME');
                    fnBlock.setFieldValue('VOID', 'RET_TYPE');
                    blocks.push(fnBlock);
                }

                // Conectar todos los bloques de forma secuencial
                setTimeout(() => {
                    try {
                        console.log('üîó Conectando bloques por defecto...');

                        // Conectar el primer bloque al contrato
                        const settingsInput = contractBlock.getInput('SETTINGS');
                        if (settingsInput && settingsInput.connection && blocks[0] && blocks[0].previousConnection) {
                            settingsInput.connection.connect(blocks[0].previousConnection);
                        }

                        // Conectar los bloques en cadena
                        for (let i = 0; i < blocks.length - 1; i++) {
                            const currentBlock = blocks[i];
                            const nextBlock = blocks[i + 1];

                            if (currentBlock && currentBlock.nextConnection &&
                                nextBlock && nextBlock.previousConnection) {
                                currentBlock.nextConnection.connect(nextBlock.previousConnection);
                            }
                        }

                        // Renderizar despu√©s de conectar
                        blocklyWorkspace.render();
                        console.log('‚úÖ Bloques por defecto creados y conectados');

                    } catch (error) {
                        console.error('‚ùå Error conectando bloques:', error);
                    }
                }, 500);

            } catch (error) {
                console.error('‚ùå Error creando bloques:', error);
            }
        }

        function readBlocklyData() {
            if (!blocklyWorkspace) {
                console.error('Blockly workspace no est√° inicializado');
                return null;
            }

            const contractBlock = blocklyWorkspace.getBlocksByType('contract_settings', false)[0];
            if (!contractBlock) {
                console.error('No se encontr√≥ bloque de contrato');
                return null;
            }

            const data = {
                name: '',
                symbol: 'TOKEN',
                supply: 1000,
                decimals: 2,
                version: '0.1.0',
                admin: appState.walletAddress || '',
                state: [],
                functions: [],
                // Asegurar que siempre existan features, security, economics y metadata
                features: {
                    mintable: false,
                    burnable: false,
                    pausable: false,
                    upgradeable: false,
                    accessControl: false,
                    governance: false,
                    stakeable: false,
                    timeLock: false,
                    multiSig: false
                },
                security: {
                    transferLimit: 0,
                    dailyLimit: 0,
                    whitelistEnabled: false,
                    freezeable: false,
                    recoverableKeys: false
                },
                economics: {
                    transactionFee: 0,
                    burnRate: 0,
                    stakingReward: 0,
                    inflationRate: 0
                },
                metadata: {
                    license: 'MIT',
                    description: '',
                    website: '',
                    logoUrl: ''
                }
            };

            let currentBlock = contractBlock.getInputTargetBlock('SETTINGS');

            while (currentBlock) {
                switch (currentBlock.type) {

                    case 'contract_name':
                        data.name = currentBlock.getFieldValue('NAME');
                        break;
                    case 'contract_version':
                        data.version = currentBlock.getFieldValue('VERSION');
                        break;
                    case 'admin_address':
                        data.admin = currentBlock.getFieldValue('ADDRESS');
                        break;
                    case 'token_symbol':
                        data.symbol = currentBlock.getFieldValue('SYMBOL');
                        break;
                    case 'token_supply':
                        data.supply = parseInt(currentBlock.getFieldValue('SUPPLY')) || 1000;
                        break;
                    case 'token_decimals':
                        data.decimals = parseInt(currentBlock.getFieldValue('DECIMALS')) || 2;
                        break;
                    case 'state_var':
                    case 'state_variable':
                        data.state = data.state || [];
                        data.state.push({
                            name: currentBlock.getFieldValue('VAR_NAME'),
                            type: currentBlock.getFieldValue('VAR_TYPE')
                        });
                        break;
                    case 'function_def':
                    case 'function_declaration':
                        data.functions = data.functions || [];
                        data.functions.push({
                            name: currentBlock.getFieldValue('FN_NAME'),
                            returns: currentBlock.getFieldValue('RET_TYPE')
                        });
                        break;
                }
                currentBlock = currentBlock.getNextBlock();
            }

            return data;
        }

        // Validaci√≥n de pasos
        function validateCurrentStep() {
            switch (appState.currentStep) {
                case 1:
                    return validateWalletConnection();
                case 2:
                    return validateTemplateSelection();
                case 3:
                    return validateTokenData();
                case 4:
                    return true; // El paso 4 no requiere validaci√≥n adicional
                default:
                    return true;
            }
        }

        function validateTemplateSelection() {
            if (!appState.selectedTemplate) {
                showToast('Por favor, selecciona una plantilla para continuar', 'error');
                return false;
            }
            return true;
        }

        function validateWalletConnection() {
            if (!appState.walletConnected) {
                showToast('Por favor, conecta tu wallet primero', 'error');
                return false;
            }
            return true;
        }

        function validateTokenData() {
            // Validaci√≥n simple para smart contracts gen√©ricos
            if (!blocklyWorkspace) {
                showToast('Blockly a√∫n no se ha inicializado. Por favor espera...', 'error');
                return false;
            }

            const contractBlocks = blocklyWorkspace.getBlocksByType('contract_settings', false);

            if (contractBlocks.length === 0) {
                showToast('Por favor, configura tu contrato usando los bloques', 'error');
                return false;
            }

            const contractBlock = contractBlocks[0];
            let currentBlock = contractBlock.getInputTargetBlock('SETTINGS');
            let hasName = false;
            let contractName = '';

            while (currentBlock) {
                if (currentBlock.type === 'contract_name') {
                    contractName = currentBlock.getFieldValue('NAME');
                    if (contractName && contractName.trim() !== '') {
                        hasName = true;
                    }
                }
                currentBlock = currentBlock.getNextBlock();
            }

            if (!hasName) {
                showToast('El nombre del contrato es requerido', 'error');
                return false;
            }

            // Actualizar appState con datos b√°sicos del contrato
            appState.tokenData = appState.tokenData || {};
            appState.tokenData.name = contractName;
            appState.tokenData.adminAddress = appState.walletAddress;

            return true;
        }

        function updateTokenSummary() {
            // Leer datos actuales de Blockly
            const blocklyData = readBlocklyData();
            if (!blocklyData) return;

            // Actualizar el appState con los datos de Blockly
            appState.tokenData = { ...appState.tokenData, ...blocklyData };

            // Actualizar elementos del resumen
            if (elements.summaryType) {
                const typeLabels = { 'FUNGIBLE': 'Fungible', 'NON_FUNGIBLE': 'No Fungible', 'STABLECOIN': 'Stablecoin' };
                elements.summaryType.textContent = typeLabels[blocklyData.tokenType] || blocklyData.tokenType || 'Smart Contract';
            }
            if (elements.summaryName) elements.summaryName.textContent = blocklyData.name || '-';
            if (elements.summarySymbol) elements.summarySymbol.textContent = blocklyData.symbol || '-';
            if (elements.summarySupply) elements.summarySupply.textContent = blocklyData.supply ? blocklyData.supply.toLocaleString() : '-';

            // Mostrar caracter√≠sticas habilitadas (con verificaci√≥n segura)
            if (elements.summaryFeatures) {
                const enabledFeatures = [];
                const features = blocklyData.features || {};
                if (features.mintable) enabledFeatures.push('Mintable');
                if (features.burnable) enabledFeatures.push('Burnable');
                if (features.pausable) enabledFeatures.push('Pausable');
                if (features.upgradeable) enabledFeatures.push('Upgradeable');
                if (features.accessControl) enabledFeatures.push('Control de Acceso');

                elements.summaryFeatures.textContent = enabledFeatures.length > 0 ? enabledFeatures.join(', ') : 'Ninguna';
            }

            if (elements.summaryLicense) elements.summaryLicense.textContent = blocklyData.license || blocklyData.metadata?.license || '-';
            if (elements.summaryAdmin) elements.summaryAdmin.textContent = appState.walletAddress ? appState.walletAddress.substring(0, 8) + '...' + appState.walletAddress.substring(appState.walletAddress.length - 8) : '-';
        }

        // Funciones de utilidad
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function hideError(elementId) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
            }
        }

        function showToast(message, type = 'info') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                color: white;
                font-weight: 500;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;

            if (type === 'success') {
                toast.style.background = '#10b981';
            } else if (type === 'error') {
                toast.style.background = '#dc2626';
            } else {
                toast.style.background = '#6366f1';
            }

            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        // Funciones de conexi√≥n de wallet
        async function connectWallet(walletType) {
            try {
                showToast('Conectando wallet...', 'info');

                let address;

                if (walletType === 'Freighter') {
                    if (!window.freighterApi) {
                        // Redirigir a la p√°gina de instalaci√≥n de Freighter
                        window.open('https://freighter.app/', '_blank');
                        showToast('Freighter no est√° instalado. Abriendo p√°gina de instalaci√≥n...', 'info');
                        return;
                    }

                    address = await window.freighterApi.getPublicKey();
                    appState.walletType = 'Freighter';
                } else if (walletType === 'Albedo') {
                    if (!(window.albedo && window.albedo.publicKey)) {
                        window.open('https://albedo.link/', '_blank');
                        showToast('Albedo no est√° instalado/disponible. Abriendo p√°gina...', 'info');
                        return;
                    }
                    const res = await window.albedo.publicKey({
                        // Albedo funciona sin extensi√≥n, solicitar clave p√∫blica
                        intent: 'public_key'
                    });
                    address = res.pubkey;
                    appState.walletType = 'Albedo';
                } else if (walletType === 'xBull') {
                    if (!window.xBullApi) {
                        // Redirigir a la p√°gina de instalaci√≥n de xBull
                        window.open('https://xbull.app/', '_blank');
                        showToast('xBull no est√° instalado. Abriendo p√°gina de instalaci√≥n...', 'info');
                        return;
                    }
                    // Implementar conexi√≥n con xBull cuando est√© disponible
                    throw new Error('xBull wallet no est√° disponible en este momento');
                } else if (walletType === 'Rabet') {
                    if (!window.rabetApi) {
                        // Redirigir a la p√°gina de instalaci√≥n de Rabet
                        window.open('https://rabet.io/', '_blank');
                        showToast('Rabet no est√° instalado. Abriendo p√°gina de instalaci√≥n...', 'info');
                        return;
                    }
                    // Implementar conexi√≥n con Rabet cuando est√© disponible
                    throw new Error('Rabet wallet no est√° disponible en este momento');
                } else {
                    throw new Error(`${walletType} wallet no est√° disponible en este momento`);
                }

                appState.walletConnected = true;
                appState.walletAddress = address;

                showToast('Wallet conectado exitosamente', 'success');

                // Navegar autom√°ticamente al siguiente paso con transici√≥n suave
                setTimeout(() => {
                    nextStep();
                }, 800);

            } catch (error) {
                console.error('Error conectando wallet:', error);
                showToast(`Error conectando wallet: ${error.message}`, 'error');
            }
        }

        // Funci√≥n de despliegue mejorada con pipeline
        async function deployToken() {
            try {
                // Validar antes de empezar
                if (!validateSmartContract()) {
                    showToast('‚ùå Valida el contrato antes de desplegarlo', 'error');
                    return;
                }

                // Ocultar summary y mostrar pipeline
                const contractSummary = document.getElementById('contractSummary');
                const deploymentPipeline = document.getElementById('deploymentPipeline');

                if (contractSummary) contractSummary.style.display = 'none';
                if (deploymentPipeline) deploymentPipeline.style.display = 'block';

                elements.nextBtn.disabled = true;
                elements.prevBtn.disabled = true;

                await updatePipelineStep('pipelineValidation', 'active', 'Validando configuraci√≥n del contrato...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                await updatePipelineStep('pipelineValidation', 'completed', 'Configuraci√≥n validada correctamente');

                // Paso 1: Compilaci√≥n del Smart Contract
                await updatePipelineStep('pipelineCompilation', 'active', 'Generando c√≥digo Rust del smart contract...');

                const blocklyData = readBlocklyData();
                const rustCode = generateAdvancedRustCode(blocklyData);

                console.log('üîß Compilando Smart Contract:');
                console.log('   Nombre:', blocklyData.name);
                console.log('   Caracter√≠sticas:', Object.keys(blocklyData.features).filter(f => blocklyData.features[f]));

                // Simular tiempo de compilaci√≥n
                await new Promise(resolve => setTimeout(resolve, 2000));
                await updatePipelineStep('pipelineCompilation', 'completed', 'Smart contract compilado exitosamente');
                appState.contractCompiled = true;

                // Paso 2: Build WASM
                await updatePipelineStep('pipelineWasm', 'active', 'Compilando a WebAssembly optimizado...');

                // Simular compilaci√≥n WASM
                await new Promise(resolve => setTimeout(resolve, 2500));
                await updatePipelineStep('pipelineWasm', 'completed', 'WASM optimizado generado');

                // Paso 3: Despliegue a la red
                await updatePipelineStep('pipelineDeployment', 'active', 'Desplegando a la red Stellar...');

                console.log('üöÄ Datos del Smart Contract para despliegue:');
                console.log('   code:', blocklyData.symbol);
                console.log('   amount:', blocklyData.supply);
                console.log('   userAddress:', appState.walletAddress);
                console.log('   features:', blocklyData.features);
                console.log('   security:', blocklyData.security);
                console.log('   economics:', blocklyData.economics);

                const response = await fetch('/api/build-smart-contract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        // Datos b√°sicos del token
                        code: blocklyData.symbol,
                        amount: blocklyData.supply,
                        userAddress: appState.walletAddress,

                        // Datos del smart contract
                        contractData: {
                            name: blocklyData.name,
                            symbol: blocklyData.symbol,
                            decimals: blocklyData.decimals || 2,
                            supply: blocklyData.supply,
                            features: blocklyData.features,
                            security: blocklyData.security,
                            economics: blocklyData.economics,
                            metadata: blocklyData.metadata,
                            rustCode: rustCode
                        }
                    }),
                });

                let result;
                if (response.ok) {
                    result = await response.json();
                } else {
                    // Fallback al endpoint original si el nuevo no existe a√∫n
                    console.log('‚ö†Ô∏è Endpoint de smart contract no disponible, usando fallback...');
                    const fallbackResponse = await fetch('/api/build-transaction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            code: blocklyData.symbol,
                            amount: blocklyData.supply,
                            userAddress: appState.walletAddress,
                            tokenData: blocklyData
                        }),
                    });

                    if (!fallbackResponse.ok) {
                        const errorText = await fallbackResponse.text();
                        throw new Error(`Error del servidor: ${errorText}`);
                    }

                    result = await fallbackResponse.json();
                }

                if (!result.success) {
                    throw new Error(result.details || 'Error desconocido del servidor');
                }

                // Paso 4: Verificar si se despleg√≥ autom√°ticamente o compil√≥ solamente
                const isDeployed = result.deployment.status === 'deployed';
                const stepMessage = isDeployed ?
                    'Smart contract desplegado exitosamente' :
                    'Smart contract compilado - Deployment manual disponible';

                await updatePipelineStep('pipelineDeployment', 'active', stepMessage);

                console.log('üéâ Smart contract:', result.smartContract.contractName);
                console.log('üì¶ WASM size:', result.wasmSize, 'bytes');
                console.log('üìÅ WASM path:', result.smartContract.wasmPath);

                if (isDeployed) {
                    console.log('üöÄ Direcci√≥n del contrato:', result.smartContract.contractAddress);
                } else {
                    console.log('‚ö†Ô∏è Deployment manual requerido');
                }

                // Finalizar proceso seg√∫n el estado del deployment
                const finalMessage = isDeployed ?
                    'Finalizando deployment...' :
                    'Finalizando compilaci√≥n...';

                await updatePipelineStep('pipelineDeployment', 'active', finalMessage);

                // Crear resultado con informaci√≥n real del deployment
                const processResult = {
                    hash: isDeployed ?
                        result.smartContract.contractAddress :
                        'compiled_' + result.contractId.slice(0, 16),
                    successful: true,
                    result_code: isDeployed ? 'DEPLOYMENT_SUCCESS' : 'COMPILATION_SUCCESS',
                    contract_id: result.contractId,
                    contract_address: result.smartContract.contractAddress,
                    deployed: isDeployed,
                    deployment_instructions: result.deployment.deploymentInstructions
                };

                const logMessage = isDeployed ?
                    `‚úÖ Smart Contract desplegado exitosamente: ${processResult.hash}` :
                    `‚úÖ Smart Contract compilado exitosamente: ${processResult.hash}`;

                console.log(logMessage);

                // Completar el pipeline
                const completionMessage = isDeployed ?
                    'Smart Contract desplegado exitosamente' :
                    'Smart Contract compilado exitosamente';

                await updatePipelineStep('pipelineDeployment', 'completed', completionMessage);

                // Mostrar resultado final
                setTimeout(() => {
                    showDeploymentSuccess(result, processResult, blocklyData);
                }, 1000);

            } catch (error) {
                console.error('‚ùå Error desplegando Smart Contract:', error);

                // Marcar paso actual como error
                const activeStep = document.querySelector('.pipeline-step.active');
                if (activeStep) {
                    const stepId = activeStep.id;
                    await updatePipelineStep(stepId, 'error', `Error: ${error.message}`);
                }

                showToast(`‚ùå Error desplegando contrato: ${error.message}`, 'error');

                // Re-habilitar botones
                elements.nextBtn.disabled = false;
                elements.prevBtn.disabled = false;
            }
        }

        // Funci√≥n para mostrar las instrucciones de deployment
        function showDeploymentInstructions(instructions) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            let stepsHtml = '';
            if (instructions.setupSteps && Array.isArray(instructions.setupSteps)) {
                stepsHtml = instructions.setupSteps.map((step, index) =>
                    `<div style="margin: 0.5rem 0;">
                        <strong>${index + 1}.</strong> 
                        <code style="background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-family: monospace;">${step}</code>
                    </div>`
                ).join('');
            }

            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 1rem 0; color: #1f2937;">üìã Instrucciones de Deployment</h3>
                    <p style="margin: 0 0 1rem 0; color: #6b7280;">Para desplegar tu smart contract, ejecuta estos comandos en orden:</p>
                    
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0;">
                        ${stepsHtml}
                    </div>
                    
                    <div style="background: #eff6ff; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0;">
                        <p style="margin: 0; color: #1e40af; font-size: 0.9rem;">
                            <strong>‚ÑπÔ∏è Explicaci√≥n de los comandos:</strong><br>
                            1. <strong>generate</strong>: Crea una nueva identity para firmar transacciones<br>
                            2. <strong>fund</strong>: Solicita XLM gratuitos para la testnet<br>
                            3. <strong>deploy</strong>: Despliega el smart contract a la red
                        </p>
                    </div>
                    
                    <p style="margin: 1rem 0 0 0; color: #6b7280; font-size: 0.9rem;">
                        <strong>Instalaci√≥n de Stellar CLI:</strong> 
                        <a href="${instructions.setupGuide || 'https://developers.stellar.org/docs/build/smart-contracts/getting-started/setup'}" target="_blank" style="color: #3b82f6;">Ver gu√≠a oficial</a>
                        <br><br>
                        <strong>Alternativa:</strong> 
                        <a href="${instructions.stellarLaboratory || 'https://laboratory.stellar.org/'}" target="_blank" style="color: #3b82f6;">Usar Stellar Laboratory</a>
                    </p>
                    
                    <button onclick="this.parentElement.parentElement.remove()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; margin-top: 1rem; font-weight: 600;">Entendido</button>
                </div>
            `;

            document.body.appendChild(modal);

            // Cerrar al hacer click fuera del modal
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Funci√≥n para mostrar el resultado exitoso del despliegue
        function showDeploymentSuccess(result, submitResult, contractData) {
            const deploymentPipeline = document.getElementById('deploymentPipeline');
            const deploymentResult = document.getElementById('deploymentResult');

            if (deploymentPipeline) deploymentPipeline.style.display = 'none';
            if (deploymentResult) {
                deploymentResult.classList.remove('hidden');

                const features = Object.keys(contractData.features || {})
                    .filter(f => contractData.features[f])
                    .map(f => {
                        const names = {
                            'mintable': 'Mintable',
                            'burnable': 'Burnable',
                            'pausable': 'Pausable',
                            'upgradeable': 'Upgradeable',
                            'governance': 'Governance',
                            'stakeable': 'Stakeable',
                            'timeLock': 'Time Lock',
                            'accessControl': 'Control de Acceso'
                        };
                        return names[f] || f;
                    }).join(', ');

                elements.resultContent.innerHTML = `
                    <div style="text-align: center; max-width: 600px; margin: 0 auto;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üéâ</div>
                        <h2 style="color: #10b981; margin-bottom: 1rem;">${submitResult.deployed ? '¬°Smart Contract Desplegado Exitosamente!' : '¬°Smart Contract Compilado Exitosamente!'}</h2>
                        
                        <div style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; text-align: left;">
                            <h3 style="margin: 0 0 1rem 0; color: #059669;">üìÑ Detalles del Contrato</h3>
                            <div style="display: grid; gap: 0.75rem;">
                                <div><strong>Nombre:</strong> ${contractData.name}</div>
                                <div><strong>S√≠mbolo:</strong> ${result.smartContract?.tokenSymbol || contractData.symbol}</div>
                                <div><strong>Contrato ID:</strong> ${result.smartContract?.contractId || 'Generado'}</div>
                                ${submitResult.deployed ? `<div><strong>Direcci√≥n del Contrato:</strong> <code style="font-size: 0.8rem; background: #dcfce7; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">${submitResult.contract_address}</code></div>` : ''}
                                <div><strong>WASM Size:</strong> ${result.wasmSize ? `${Math.round(result.wasmSize / 1024)} KB` : 'N/A'}</div>
                                <div><strong>Template:</strong> ${result.smartContract?.templateUsed || 'Avanzado'}</div>
                                <div><strong>Suministro Inicial:</strong> ${(contractData.supply || 0).toLocaleString()}</div>
                                <div><strong>Caracter√≠sticas:</strong> ${features || 'Smart Contract B√°sico'}</div>
                                <div><strong>${submitResult.deployed ? 'Hash de Deployment' : 'Hash de Compilaci√≥n'}:</strong> <code style="font-size: 0.8rem; background: #dcfce7; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">${submitResult.hash}</code></div>
                                <div><strong>Estado:</strong> <span style="color: ${submitResult.deployed ? '#059669' : '#d97706'}; font-weight: 600;">${submitResult.deployed ? '‚úÖ Desplegado en Testnet' : '‚ö†Ô∏è Requiere Deployment Manual'}</span></div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <a href="https://github.com/stellar/soroban-cli" 
                               target="_blank" 
                               style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: #6366f1; color: white; padding: 1rem; text-decoration: none; border-radius: 0.75rem; font-weight: 600; transition: transform 0.2s;">
                                üõ†Ô∏è Soroban CLI
                            </a>
                            <a href="https://soroban.stellar.org/" 
                               target="_blank" 
                               style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: #10b981; color: white; padding: 1rem; text-decoration: none; border-radius: 0.75rem; font-weight: 600; transition: transform 0.2s;">
                                üìö Docs Soroban
                            </a>
                            ${!submitResult.deployed ? `<button onclick="showDeploymentInstructions(${JSON.stringify(result.deployment?.deploymentInstructions || {}).replace(/"/g, '&quot;')})" 
                                    style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: #f59e0b; color: white; padding: 1rem; border: none; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: transform 0.2s;">
                                üìã Ver Instrucciones
                            </button>` : ''}
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 2rem;">
                            <button onclick="window.location.reload()" 
                                    style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: #6b7280; color: white; padding: 1rem; border: none; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: transform 0.2s;">
                                üîÑ Crear Otro Contrato
                            </button>
                        </div>
                        
                        <div style="background: #eff6ff; border-radius: 0.75rem; padding: 1rem; font-size: 0.9rem; color: #1e40af;">
                            <strong>üí° Pr√≥ximos pasos:</strong><br>
                            ‚Ä¢ Guarda la direcci√≥n del emisor para futuras interacciones<br>
                            ‚Ä¢ Configura tu wallet para ver el nuevo token<br>
                            ‚Ä¢ Comparte el contrato con tu comunidad
                        </div>
                    </div>
                `;
            }

            showToast('üéâ ¬°Smart Contract desplegado exitosamente!', 'success');
        }

        // Funciones para gesti√≥n de proyectos
        function saveCurrentProject() {
            try {
                const projectName = prompt('Nombre del proyecto:', 'Mi Contrato');
                if (!projectName) return;

                projectManager.saveProject(projectName, blocklyWorkspace);
                showToast(`‚úÖ Proyecto '${projectName}' guardado`, 'success');
            } catch (error) {
                showToast(`‚ùå Error guardando proyecto: ${error.message}`, 'error');
            }
        }

        function showProjectsModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 1rem; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: #1f2937;">üìÅ Mis Proyectos</h3>
                        <button onclick="this.closest('div').parentElement.remove()"
                                style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                            Cerrar
                        </button>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        ${projectManager.getProjectsListHTML()}
                    </div>

                    <div style="padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                        <p style="margin: 0 0 0.5rem 0; font-size: 0.85rem; color: #6b7280;">
                            Storage usado: ${(projectManager.getStorageInfo().storageUsed / 1024).toFixed(2)} KB / ${(projectManager.getStorageInfo().storageLimit / 1024 / 1024).toFixed(1)} MB
                        </p>
                        <button onclick="projectManager.clearAll(); location.reload();"
                                style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.85rem;">
                            üóëÔ∏è Borrar todos los proyectos
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Botones de navegaci√≥n
            elements.nextBtn.addEventListener('click', nextStep);
            elements.prevBtn.addEventListener('click', prevStep);

            // Botones de conexi√≥n de wallet
            document.getElementById('connectFreighter').addEventListener('click', () => connectWallet('Freighter'));
            document.getElementById('connectXbull').addEventListener('click', () => connectWallet('xBull'));
            document.getElementById('connectAlbedo').addEventListener('click', () => connectWallet('Albedo'));
            document.getElementById('connectRabet').addEventListener('click', () => connectWallet('Rabet'));

            // Botones de preview y validaci√≥n
            const refreshPreviewBtn = document.getElementById('refreshPreview');
            if (refreshPreviewBtn) {
                refreshPreviewBtn.addEventListener('click', updateCodePreview);
            }

            const validateContractBtn = document.getElementById('validateContract');
            if (validateContractBtn) {
                validateContractBtn.addEventListener('click', () => {
                    const isValid = validateSmartContract();
                    if (isValid) {
                        showToast('‚úÖ Contrato validado correctamente', 'success');
                    } else {
                        showToast('‚ùå Se encontraron errores en el contrato', 'error');
                    }
                });
            }

            const viewFullCodeBtn = document.getElementById('viewFullCode');
            if (viewFullCodeBtn) {
                viewFullCodeBtn.addEventListener('click', () => {
                    const blocklyData = readBlocklyData();
                    if (blocklyData && blocklyData.name) {
                        const fullCode = generateAdvancedRustCode(blocklyData);

                        // Crear modal para mostrar c√≥digo completo
                        const modal = document.createElement('div');
                        modal.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0,0,0,0.8);
                            z-index: 1000;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            padding: 2rem;
                        `;

                        modal.innerHTML = `
                            <div style="background: white; border-radius: 1rem; padding: 2rem; max-width: 80%; max-height: 80%; overflow: auto;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h3>üìÑ C√≥digo Completo del Smart Contract</h3>
                                    <button id="closeCodeModal" style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">‚úï Cerrar</button>
                                </div>
                                <pre style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; overflow: auto; font-size: 0.875rem; line-height: 1.5;">${fullCode}</pre>
                                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                                    <button id="downloadCode" style="background: #6366f1; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;">üì• Descargar</button>
                                    <button id="copyCode" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;">üìã Copiar</button>
                                </div>
                            </div>
                        `;

                        document.body.appendChild(modal);

                        // Event listeners del modal
                        document.getElementById('closeCodeModal').addEventListener('click', () => {
                            modal.remove();
                        });

                        document.getElementById('downloadCode').addEventListener('click', () => {
                            const blob = new Blob([fullCode], { type: 'text/rust' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `${blocklyData.symbol || 'token'}_contract.rs`;
                            a.click();
                            URL.revokeObjectURL(url);
                            showToast('üì• C√≥digo descargado', 'success');
                        });

                        document.getElementById('copyCode').addEventListener('click', async () => {
                            try {
                                await navigator.clipboard.writeText(fullCode);
                                showToast('üìã C√≥digo copiado al portapapeles', 'success');
                            } catch (err) {
                                showToast('‚ùå Error al copiar c√≥digo', 'error');
                            }
                        });

                        // Cerrar modal al hacer clic fuera
                        modal.addEventListener('click', (e) => {
                            if (e.target === modal) {
                                modal.remove();
                            }
                        });
                    } else {
                        showToast('‚ö†Ô∏è Configura los bloques primero', 'error');
                    }
                });
            }

            // Efectos de hover para las opciones de wallet
            document.querySelectorAll('.wallet-option').forEach(option => {
                option.addEventListener('mouseenter', function () {
                    this.style.transform = 'translateY(-6px) scale(1.05)';
                });

                option.addEventListener('mouseleave', function () {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });

            // Inicializar stepper
            updateStepper();
        });

    </script>
</body>

</html>