<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tralalero Contracts - Create your Smart Contract with blocks</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Schabo+Condensed:wght@400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body style="">
    <div class="main-container">
        <div id="gridBackground" class="grid-background"></div>

        <div class="header" style="margin-bottom: 50px;">
            <div class="logo-container">
                <video style="z-index: 999;
    border-radius: 100%; margin-right: 30px;" src="/tralala.mp4" alt="Tralalero Contracts Video Logo" class="logo"
                    autoplay muted loop playsinline></video>
                <h1 class="title" style="z-index: 999;">
                    <span class="title-line1">TRALALA</span>
                    <span class="title-line2">CONTRACT</span>
                </h1>
            </div>
        </div>
        <div class="stepper-container"
            style="background-color: white; box-shadow: 0 0 10px 0 rgba(0, 0, 0, 0.5); padding: 50px; border-radius: 10px;">
            <div class="stepper">
                <div class="stepper-line" id="stepperLine"></div>
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Setup</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Code</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Preview</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Review</div>
                </div>
            </div>

            <div class="step-content active" id="step1">
                <div class="wallets-container">
                    <div class="description-box">
                        <h2 class="wallets-title">Setup: Connect your wallet</h2>
                    </div>

                    <!-- Wallet Connection Section -->
                    <div class="wallet-section" id="walletSection">
                        <h3>üîó Connect Your Wallet</h3>
                        <div class="wallet-options">
                            <div class="wallet-option" id="connectFreighter">
                                <div class="wallet-icon"><img src="Gemini_Generated_Image_9xaz2g9xaz2g9xaz (1).png"
                                        alt="Freighter" style="width: 40px; height: 40px; border-radius: 8px;"></div>
                                <div class="wallet-label">Freighter</div>
                            </div>
                            <div class="wallet-option" id="connectXbull">
                                <div class="wallet-icon">üêÇ</div>
                                <div class="wallet-label">xBull</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="step-content" id="step2">
                <div class="blockly-container">
                    <div class="description-box">
                        <h2 class="wallets-title">Drag and connect the blocks!</h2>
                        <p class="wallets-title">Use the blocks on the left to model your smart contract. <br />
                            Drag the "üîÆ My Smart Contract" block and connect the properties/state/function blocks.</p>
                    </div>
                    <div id="blocklyDiv"></div>
                </div>
            </div>

            <div class="step-content" id="step3">
                <div class="smart-contract-container">
                    <div class="description-box">
                        <h2 class="wallets-title">‚öôÔ∏è Advanced Smart Contract Configuration</h2>
                        <p class="wallets-title">Configure the advanced features of your smart contract. Drag more
                            blocks to add functionalities!</p>
                    </div>

                    <div class="code-preview-section">
                        <div class="preview-header">
                            <h3>üìã Code Preview</h3>

                        </div>
                        <div class="code-preview" id="codePreview">
                            <pre id="contractPreview"
                                style="text-align: left;">// The code will be generated automatically when you configure the blocks...</pre>
                        </div>
                        <div class="validation-result hidden" id="validationResult">
                            <div id="validationMessage"></div>
                        </div>
                    </div>

                    <div style="display: none;" class="blockly-advanced-container">
                        <div id="blocklyDiv"></div>
                    </div>
                </div>
            </div>

            <div class="step-content" id="step4">
                <div class="create-token-container">
                    <h2 class="step-title">üöÄ Review and export your Smart Contract</h2>

                    <div class="contract-summary" id="contractSummary">
                        <h3>üìÑ Contract Summary</h3>
                        <div class="summary-grid" id="summaryGrid">
                            <div class="summary-item">
                                <strong>Type:</strong> <span id="summaryType">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Name:</strong> <span id="summaryName">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Symbol:</strong> <span id="summarySymbol">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Initial Amount:</strong> <span id="summarySupply">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Features:</strong> <span id="summaryFeatures">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>License:</strong> <span id="summaryLicense">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Administrator:</strong> <span id="summaryAdmin">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Network:</strong> <span id="summaryNetwork">Stellar Testnet</span>
                            </div>
                        </div>
                    </div>

                    <div class="deployment-pipeline" id="deploymentPipeline">
                        <div class="pipeline-step" id="pipelineValidation">
                            <div class="step-icon">üîç</div>
                            <div class="step-info">
                                <h4>Validation</h4>
                                <p>Verifying contract configuration...</p>
                            </div>
                            <div class="step-status pending">‚è≥</div>
                        </div>

                        <div class="pipeline-step" id="pipelineCompilation">
                            <div class="step-icon">‚öôÔ∏è</div>
                            <div class="step-info">
                                <h4>Compilation</h4>
                                <p>Generating Rust smart contract code...</p>
                            </div>
                            <div class="step-status pending">‚è≥</div>
                        </div>

                        <div class="pipeline-step" id="pipelineWasm">
                            <div class="step-icon">üì¶</div>
                            <div class="step-info">
                                <h4>Build WASM</h4>
                                <p>Compiling to optimized WebAssembly...</p>
                            </div>
                            <div class="step-status pending">‚è≥</div>
                        </div>

                        <div class="pipeline-step" id="pipelineDeployment">
                            <div class="step-icon">üì¶</div>
                            <div class="step-info">
                                <h4>Export</h4>
                                <p>Preparing code to download/copy...</p>
                            </div>
                            <div class="step-status pending">‚è≥</div>
                        </div>
                    </div>

                    <div class="deployment-status hidden" id="deploymentStatus">
                        <div class="deployment-message" id="deploymentMessage">Preparing deployment...</div>
                        <div class="deployment-progress">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                    </div>

                    <div class="deployment-result hidden" id="deploymentResult">
                        <div class="result-content" id="resultContent"></div>
                    </div>
                </div>
            </div>

            <div class="stepper-navigation">
                <button class="btn btn-secondary" id="prevBtn" disabled>Previous</button>
                <button class="btn btn-primary" id="nextBtn">Next</button>
            </div>
        </div>

    </div>

    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stellar/stellar-sdk@11.3.0/dist/stellar-sdk.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stellar/freighter-api@1.7.0/build/index.min.js"></script>
    <script src="https://unpkg.com/albedo-sdk@^0.10.4/dist/albedo.min.js"></script>
    <script>
        // Estado global de la aplicaci√≥n
        const appState = {
            currentStep: 1,
            totalSteps: 4,
            walletConnected: false,
            walletAddress: null,
            walletType: null,
            contractCompiled: false,
            contractValidated: false,
            tokenData: {
                // Configuraci√≥n b√°sica
                tokenType: 'SMART_CONTRACT',
                contractType: 'TOKEN',
                name: '',
                symbol: '',
                supply: 0,
                decimals: 2,
                adminAddress: '',

                // Caracter√≠sticas avanzadas
                features: {
                    mintable: false,
                    burnable: false,
                    pausable: false,
                    upgradeable: false,
                    accessControl: false,
                    governance: false,
                    stakeable: false,
                    timeLock: false,
                    multiSig: false
                },

                // Configuraci√≥n de seguridad
                security: {
                    transferLimit: 0,
                    dailyLimit: 0,
                    whitelistEnabled: false,
                    freezeable: false,
                    recoverableKeys: false
                },

                // Informaci√≥n del contrato
                metadata: {
                    securityContact: '',
                    license: 'MIT',
                    version: '1.0.0',
                    description: '',
                    website: '',
                    logoUrl: ''
                },

                // Configuraci√≥n avanzada
                economics: {
                    transactionFee: 0,
                    burnRate: 0,
                    stakingReward: 0,
                    inflationRate: 0
                },

                // Backward compatibility
                initialSupply: 0
            }
        };

        // Variable global para el workspace de Blockly
        let blocklyWorkspace = null;

        // Elementos del DOM
        const elements = {
            stepper: document.querySelector('.stepper'),
            stepperLine: document.getElementById('stepperLine'),
            steps: document.querySelectorAll('.step'),
            stepContents: document.querySelectorAll('.step-content'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),

            // Summary elements
            tokenSummary: document.getElementById('tokenSummary'),
            summaryType: document.getElementById('summaryType'),
            summaryName: document.getElementById('summaryName'),
            summarySymbol: document.getElementById('summarySymbol'),
            summarySupply: document.getElementById('summarySupply'),
            summaryFeatures: document.getElementById('summaryFeatures'),
            summaryLicense: document.getElementById('summaryLicense'),
            summaryAdmin: document.getElementById('summaryAdmin'),

            // Deployment elements
            deploymentStatus: document.getElementById('deploymentStatus'),
            deploymentMessage: document.getElementById('deploymentMessage'),
            deploymentResult: document.getElementById('deploymentResult'),
            resultContent: document.getElementById('resultContent')
        };

        // Funciones del stepper
        function updateStepper() {
            // Actualizar pasos
            elements.steps.forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed');

                if (stepNumber === appState.currentStep) {
                    step.classList.add('active');
                } else if (stepNumber < appState.currentStep) {
                    step.classList.add('completed');
                }
            });

            // Actualizar contenido de pasos con transici√≥n suave
            elements.stepContents.forEach((content, index) => {
                content.classList.remove('active');
                if (index + 1 === appState.currentStep) {
                    // Peque√±o delay para permitir que la transici√≥n anterior termine
                    setTimeout(() => {
                        content.classList.add('active');
                    }, 50);
                }
            });

            // Actualizar l√≠nea de progreso con transici√≥n suave
            const progress = ((appState.currentStep - 1) / (appState.totalSteps - 1)) * 100;
            elements.stepperLine.style.transition = 'width 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            elements.stepperLine.style.width = `${progress}%`;

            // Actualizar botones
            elements.prevBtn.disabled = appState.currentStep === 1;

            if (appState.currentStep === appState.totalSteps) {
                elements.nextBtn.textContent = 'Create Smart Contract';
            } else {
                elements.nextBtn.textContent = 'Next';
            }

            // Actualizar contenido din√°mico seg√∫n el paso
            updateStepContent();
        }

        function goToStep(stepNumber) {
            if (stepNumber >= 1 && stepNumber <= appState.totalSteps) {
                appState.currentStep = stepNumber;
                updateStepper();
            }
        }

        function nextStep() {
            if (validateCurrentStep()) {
                if (appState.currentStep < appState.totalSteps) {
                    goToStep(appState.currentStep + 1);
                } else {
                    deployToken();
                }
            }
        }

        function prevStep() {
            if (appState.currentStep > 1) {
                goToStep(appState.currentStep - 1);
            }
        }

        function updateStepContent() {
            switch (appState.currentStep) {
                case 2:
                    // Inicializar Blockly cuando se llega al paso 2
                    if (!blocklyWorkspace) {
                        initializeBlockly();
                    }
                    break;
                case 3:
                    // Configuraci√≥n avanzada de smart contracts
                    if (!blocklyWorkspace) {
                        initializeBlockly();
                    }
                    updateCodePreview();
                    break;
                case 4:
                    updateTokenSummary();
                    updateDeploymentPipeline();
                    break;
            }
        }

        // Funci√≥n para actualizar el preview del c√≥digo
        function updateCodePreview() {
            const contractPreview = document.getElementById('contractPreview');
            if (!contractPreview) return;

            const blocklyData = readBlocklyData();
            if (!blocklyData || !blocklyData.name) {
                contractPreview.textContent = '// Configure the blocks to see the code preview...';
                return;
            }

            const rustCode = generateAdvancedRustCode(blocklyData);
            contractPreview.textContent = rustCode;
        }

        // Funci√≥n para generar c√≥digo Rust avanzado
        function generateAdvancedRustCode(data) {
            const features = [];

            // Verificar que data.features exista antes de acceder a sus propiedades
            if (data.features) {
                if (data.features.mintable) features.push('Mintable');
                if (data.features.burnable) features.push('Burnable');
                if (data.features.pausable) features.push('Pausable');
                if (data.features.upgradeable) features.push('Upgradeable');
                if (data.features.governance) features.push('Governance');
                if (data.features.stakeable) features.push('Stakeable');
                if (data.features.timeLock) features.push('TimeLock');
                if (data.features.accessControl) features.push('AccessControl');
            }

            return `// Smart Contract: ${data.name || 'MyToken'}
// Automatically generated by Tralalero Contracts
#![no_std]

use soroban_sdk::{
    contract, contractimpl, Address, Env, String, Symbol, Map,
    token::{self, Interface as TokenInterface},
    auth::{Context, CustomAccountInterface},
    ${data.features && data.features.governance ? 'governance::GovernanceInterface,' : ''}
    ${data.features && data.features.stakeable ? 'staking::StakingInterface,' : ''}
};

// Contract constants
const TOKEN_NAME: &str = "${data.name || 'My Token'}";
const TOKEN_SYMBOL: &str = "${data.symbol || 'TOKEN'}";
const DECIMALS: u32 = ${data.decimals || 2};
const INITIAL_SUPPLY: i128 = ${data.supply || 1000};

// Storage keys
const ADMIN: Symbol = symbol_short!("ADMIN");
const PAUSED: Symbol = symbol_short!("PAUSED");
const TOTAL_SUPPLY: Symbol = symbol_short!("TOTAL_SUP");
${data.security && data.security.transferLimit ? `const TRANSFER_LIMIT: Symbol = symbol_short!("TRANS_LIM");` : ''}
${data.features && data.features.stakeable ? `const STAKING_POOL: Symbol = symbol_short!("STAKING");` : ''}

#[contract]
pub struct TokenContract;

#[contractimpl]
impl TokenContract {
    
    /// Initializes the contract with custom settings
    pub fn initialize(env: Env, admin: Address) {
        if env.storage().instance().has(&ADMIN) {
            panic!("Contract already initialized");
        }
        
        env.storage().instance().set(&ADMIN, &admin);
        env.storage().instance().set(&TOTAL_SUPPLY, &INITIAL_SUPPLY);
        ${data.features && data.features.pausable ? 'env.storage().instance().set(&PAUSED, &false);' : ''}
        ${data.security && data.security.transferLimit ? `env.storage().instance().set(&TRANSFER_LIMIT, &${data.security.transferLimit});` : ''}
        
        // Initial mint to the admin
        if INITIAL_SUPPLY > 0 {
            token::Client::new(&env, &env.current_contract_address())
                .mint(&admin, &INITIAL_SUPPLY);
        }
    }

    /// Token metadata
    pub fn name(env: Env) -> String {
        String::from_str(&env, TOKEN_NAME)
    }
    
    pub fn symbol(env: Env) -> String {
        String::from_str(&env, TOKEN_SYMBOL)
    }
    
    pub fn decimals(env: Env) -> u32 {
        DECIMALS
    }

    ${data.features && data.features.mintable ? `
    /// Mint new tokens (admin only)
    pub fn mint(env: Env, to: Address, amount: i128) {
        Self::check_admin(&env);
        ${data.features && data.features.pausable ? 'Self::check_not_paused(&env);' : ''}
        
        token::Client::new(&env, &env.current_contract_address())
            .mint(&to, &amount);
    }` : ''}

    ${data.features && data.features.burnable ? `
    /// Burn tokens
    pub fn burn(env: Env, from: Address, amount: i128) {
        from.require_auth();
        ${data.features && data.features.pausable ? 'Self::check_not_paused(&env);' : ''}
        
        token::Client::new(&env, &env.current_contract_address())
            .burn(&from, &amount);
    }` : ''}

    ${data.features && data.features.pausable ? `
    /// Pause the contract (admin only)
    pub fn pause(env: Env) {
        Self::check_admin(&env);
        env.storage().instance().set(&PAUSED, &true);
    }
    
    /// Unpause the contract (admin only)
    pub fn unpause(env: Env) {
        Self::check_admin(&env);
        env.storage().instance().set(&PAUSED, &false);
    }` : ''}

    ${data.features && data.features.stakeable ? `
    /// Stake tokens
    pub fn stake(env: Env, from: Address, amount: i128) {
        from.require_auth();
        Self::check_not_paused(&env);
        
        // Staking logic...
        // TODO: Implement staking pool
    }` : ''}

    /// Helper functions
    fn check_admin(env: &Env) {
        let admin: Address = env.storage().instance().get(&ADMIN).unwrap();
        admin.require_auth();
    }

    ${data.features && data.features.pausable ? `
    fn check_not_paused(env: &Env) {
        let paused: bool = env.storage().instance().get(&PAUSED).unwrap_or(false);
        if paused {
            panic!("Contract is paused");
        }
    }` : ''}
}

// Enabled features: ${features.join(', ') || 'None'}
// Transfer limit: ${data.security && data.security.transferLimit || 'No limit'}
// Staking reward: ${data.economics && data.economics.stakingReward || 0}% yearly
// Transaction fee: ${data.economics && data.economics.transactionFee || 0}%
// Burn rate: ${data.economics && data.economics.burnRate || 0}%`;
        }

        // Funci√≥n para validar el contrato
        function validateSmartContract() {
            const validationResult = document.getElementById('validationResult');
            const validationMessage = document.getElementById('validationMessage');

            if (!validationResult || !validationMessage) return false;

            // Validaci√≥n b√°sica para smart contracts gen√©ricos
            const contractBlocks = blocklyWorkspace.getBlocksByType('contract_settings', false);
            const errors = [];
            const warnings = [];

            if (contractBlocks.length === 0) {
                errors.push('‚ùå Missing the main "My Smart Contract" block');
            } else {
                const contractBlock = contractBlocks[0];
                let currentBlock = contractBlock.getInputTargetBlock('SETTINGS');
                let hasName = false;

                while (currentBlock) {
                    if (currentBlock.type === 'contract_name') {
                        const name = currentBlock.getFieldValue('NAME');
                        if (name && name.trim() !== '') {
                            hasName = true;
                        }
                    }
                    currentBlock = currentBlock.getNextBlock();
                }

                if (!hasName) {
                    errors.push('‚ùå The contract name is required');
                }
            }

            // Mostrar resultados
            validationResult.classList.remove('hidden');

            if (errors.length > 0) {
                validationMessage.innerHTML = `
                    <div style="color: #dc2626; font-weight: bold;">‚ùå Errors found:</div>
                    ${errors.map(error => `<div style="margin: 0.5rem 0;">${error}</div>`).join('')}
                `;
                validationResult.style.backgroundColor = '#fef2f2';
                validationResult.style.borderColor = '#dc2626';
                appState.contractValidated = false;
                return false;
            } else {
                let message = '<div style="color: #059669; font-weight: bold;">‚úÖ Contract is valid!</div>';

                if (warnings.length > 0) {
                    message += `
                        <div style="color: #d97706; font-weight: bold; margin-top: 1rem;">‚ö†Ô∏è Warnings:</div>
                        ${warnings.map(warning => `<div style="margin: 0.5rem 0;">${warning}</div>`).join('')}
                    `;
                }

                validationMessage.innerHTML = message;
                validationResult.style.backgroundColor = warnings.length > 0 ? '#fffbeb' : '#f0fdf4';
                validationResult.style.borderColor = warnings.length > 0 ? '#d97706' : '#059669';
                appState.contractValidated = true;
                return true;
            }
        }

        // Funci√≥n para actualizar el pipeline de despliegue
        function updateDeploymentPipeline() {
            const pipeline = document.getElementById('deploymentPipeline');
            if (!pipeline) return;

            // Resetear estados
            const steps = pipeline.querySelectorAll('.pipeline-step');
            steps.forEach(step => {
                const status = step.querySelector('.step-status');
                status.className = 'step-status pending';
                status.textContent = '‚è≥';
            });

            // Marcar validaci√≥n como completada si est√° validado
            if (appState.contractValidated) {
                const validationStep = document.getElementById('pipelineValidation');
                if (validationStep) {
                    const status = validationStep.querySelector('.step-status');
                    status.className = 'step-status completed';
                    status.textContent = '‚úÖ';
                }
            }
        }

        // Funci√≥n para actualizar un paso espec√≠fico del pipeline
        async function updatePipelineStep(stepId, status, message) {
            const step = document.getElementById(stepId);
            if (!step) return;

            const stepStatus = step.querySelector('.step-status');
            const stepInfo = step.querySelector('.step-info p');

            // Remover clases anteriores
            step.className = 'pipeline-step';
            stepStatus.className = 'step-status';

            // A√±adir nueva clase y actualizar contenido
            step.classList.add(status);
            stepStatus.classList.add(status);

            switch (status) {
                case 'active':
                    stepStatus.textContent = 'üîÑ';
                    step.style.animation = 'pulse 1.5s infinite';
                    break;
                case 'completed':
                    stepStatus.textContent = '‚úÖ';
                    step.style.animation = 'none';
                    break;
                case 'error':
                    stepStatus.textContent = '‚ùå';
                    step.style.animation = 'none';
                    break;
                default:
                    stepStatus.textContent = '‚è≥';
                    step.style.animation = 'none';
            }

            if (message && stepInfo) {
                stepInfo.textContent = message;
            }

            // Peque√±a animaci√≥n para mostrar progreso
            if (status === 'completed') {
                step.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    step.style.transform = 'scale(1)';
                }, 300);
            }
        }

        // Funciones de Blockly
        function initializeBlockly() {
            if (typeof Blockly === 'undefined') {
                console.error('Blockly is not loaded');
                return;
            }

            // Definir bloques personalizados para Smart Contracts gen√©ricos
            Blockly.Blocks['contract_settings'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üîÆ My Smart Contract");
                    this.appendStatementInput("SETTINGS")
                        .setCheck(null);
                    this.setColour(290);
                    this.setTooltip("Main contract block");
                }
            };

            Blockly.Blocks['contract_name'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("Contract Name")
                        .appendField(new Blockly.FieldTextInput("MyContract"), "NAME");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(190);
                    this.setTooltip("Defines the name of your contract");
                }
            };

            Blockly.Blocks['contract_version'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("Version")
                        .appendField(new Blockly.FieldTextInput("0.1.0"), "VERSION");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(190);
                    this.setTooltip("Defines the version of your contract");
                }
            };

            Blockly.Blocks['admin_address'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üîë Administrator")
                        .appendField(new Blockly.FieldTextInput('G...'), "ADDRESS");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(230);
                    this.setTooltip("Defines the contract administrator");
                }
            };

            Blockly.Blocks['state_var'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üì¶ State Variable")
                        .appendField("name:")
                        .appendField(new Blockly.FieldTextInput("counter"), "VAR_NAME")
                        .appendField("type:")
                        .appendField(new Blockly.FieldDropdown([["i32", "I32"], ["i128", "I128"], ["bool", "BOOL"], ["String", "STRING"], ["Address", "ADDRESS"]]), "VAR_TYPE");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                    this.setTooltip("Defines a contract state variable");
                }
            };

            Blockly.Blocks['function_def'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("‚öôÔ∏è Function")
                        .appendField("name:")
                        .appendField(new Blockly.FieldTextInput("my_function"), "FN_NAME")
                        .appendField("returns:")
                        .appendField(new Blockly.FieldDropdown([["void", "VOID"], ["i32", "I32"], ["i128", "I128"], ["bool", "BOOL"], ["String", "STRING"], ["Address", "ADDRESS"]]), "RET_TYPE");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(120);
                    this.setTooltip("Defines a contract function");
                }
            };

            // Bloques de caracter√≠sticas del contrato
            Blockly.Blocks['feature_toggle'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("üî• Feature")
                        .appendField(new Blockly.FieldDropdown([
                            ["Mintable", "mintable"],
                            ["Burnable", "burnable"],
                            ["Pausable", "pausable"],
                            ["Upgradeable", "upgradeable"],
                            ["Governance", "governance"],
                            ["Stakeable", "stakeable"],
                            ["Time Lock", "timeLock"],
                            ["Access Control", "accessControl"]
                        ]), "FEATURE")
                        .appendField(new Blockly.FieldCheckbox("FALSE"), "ENABLED");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(290);
                    this.setTooltip("Enables or disables contract features");
                }
            };

            Blockly.Blocks['token_config'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("ü™ô Token Config")
                        .appendField("symbol:")
                        .appendField(new Blockly.FieldTextInput("TKN"), "SYMBOL")
                        .appendField("supply:")
                        .appendField(new Blockly.FieldNumber(1000, 0), "SUPPLY");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(260);
                    this.setTooltip("Configures the token associated with the contract");
                }
            };

            // Crear workspace de Blockly
            blocklyWorkspace = Blockly.inject('blocklyDiv', {
                toolbox: `
                    <xml>
                        <category name="üöÄ Get Started">
                            <block type="contract_settings"></block>
                        </category>
                        <category name="üé® Properties">
                            <block type="contract_name"></block>
                            <block type="contract_version"></block>
                            <block type="admin_address"></block>
                            <block type="token_config"></block>
                        </category>
                        <category name="üì¶ State">
                            <block type="state_var"></block>
                        </category>
                        <category name="‚öôÔ∏è Functions">
                            <block type="function_def"></block>
                        </category>
                        <category name="üî• Features">
                            <block type="feature_toggle"></block>
                        </category>
                    </xml>
                `,
                scrollbars: true,
                trashcan: true,
                zoom: {
                    controls: true,
                    wheel: true,
                    startScale: 1.0,
                    maxScale: 3,
                    minScale: 0.3,
                    scaleSpeed: 1.2
                },
                theme: Blockly.Themes.Modern
            });

            // Crear bloques por defecto
            createDefaultBlocks();
        }

        function createDefaultBlocks() {
            if (!blocklyWorkspace) return;

            // Limpiar workspace
            blocklyWorkspace.clear();

            try {
                // Crear el bloque principal del contrato
                const contractBlock = blocklyWorkspace.newBlock('contract_settings');
                if (!contractBlock) {
                    console.error('‚ùå Could not create contract block');
                    return;
                }
                contractBlock.initSvg();
                contractBlock.render();
                contractBlock.moveBy(50, 50);

                // Crear bloques b√°sicos necesarios
                const blocks = [];

                const nameBlock = blocklyWorkspace.newBlock('contract_name');
                if (nameBlock) {
                    nameBlock.initSvg();
                    nameBlock.render();
                    nameBlock.setFieldValue('MyContract', 'NAME');
                    blocks.push(nameBlock);
                }

                const versionBlock = blocklyWorkspace.newBlock('contract_version');
                if (versionBlock) {
                    versionBlock.initSvg();
                    versionBlock.render();
                    versionBlock.setFieldValue('0.1.0', 'VERSION');
                    blocks.push(versionBlock);
                }

                const adminBlock = blocklyWorkspace.newBlock('admin_address');
                if (adminBlock) {
                    adminBlock.initSvg();
                    adminBlock.render();
                    adminBlock.setFieldValue('G...', 'ADDRESS');
                    blocks.push(adminBlock);
                }

                const tokenConfigBlock = blocklyWorkspace.newBlock('token_config');
                if (tokenConfigBlock) {
                    tokenConfigBlock.initSvg();
                    tokenConfigBlock.render();
                    tokenConfigBlock.setFieldValue('TKN', 'SYMBOL');
                    tokenConfigBlock.setFieldValue(1000, 'SUPPLY');
                    blocks.push(tokenConfigBlock);
                }

                const stateVarBlock = blocklyWorkspace.newBlock('state_var');
                if (stateVarBlock) {
                    stateVarBlock.initSvg();
                    stateVarBlock.render();
                    stateVarBlock.setFieldValue('counter', 'VAR_NAME');
                    stateVarBlock.setFieldValue('I32', 'VAR_TYPE');
                    blocks.push(stateVarBlock);
                }

                const fnBlock = blocklyWorkspace.newBlock('function_def');
                if (fnBlock) {
                    fnBlock.initSvg();
                    fnBlock.render();
                    fnBlock.setFieldValue('increment', 'FN_NAME');
                    fnBlock.setFieldValue('VOID', 'RET_TYPE');
                    blocks.push(fnBlock);
                }

                // Conectar todos los bloques de forma secuencial
                setTimeout(() => {
                    try {
                        console.log('üîó Connecting blocks...');

                        // Conectar el primer bloque al contrato
                        const settingsInput = contractBlock.getInput('SETTINGS');
                        if (settingsInput && settingsInput.connection && blocks[0] && blocks[0].previousConnection) {
                            settingsInput.connection.connect(blocks[0].previousConnection);
                        }

                        // Conectar los bloques en cadena
                        for (let i = 0; i < blocks.length - 1; i++) {
                            const currentBlock = blocks[i];
                            const nextBlock = blocks[i + 1];

                            if (currentBlock && currentBlock.nextConnection &&
                                nextBlock && nextBlock.previousConnection) {
                                currentBlock.nextConnection.connect(nextBlock.previousConnection);
                            }
                        }

                        // Renderizar despu√©s de conectar
                        blocklyWorkspace.render();
                        console.log('üéâ Blocks created and connected');

                    } catch (error) {
                        console.error('‚ùå Error connecting blocks:', error);
                    }
                }, 500);

            } catch (error) {
                console.error('‚ùå Error creating blocks:', error);
            }
        }

        function readBlocklyData() {
            if (!blocklyWorkspace) {
                console.error('Blockly workspace is not initialized');
                return null;
            }

            const contractBlock = blocklyWorkspace.getBlocksByType('contract_settings', false)[0];
            if (!contractBlock) {
                console.error('Contract block not found');
                return null;
            }

            const data = {
                name: '',
                version: '0.1.0',
                admin: appState.walletAddress || '',
                state: [],
                functions: [],
                // Caracter√≠sticas por defecto para smart contracts
                features: {
                    mintable: false,
                    burnable: false,
                    pausable: false,
                    upgradeable: false,
                    governance: false,
                    stakeable: false,
                    timeLock: false,
                    accessControl: false
                },
                // Configuraci√≥n adicional
                security: {
                    transferLimit: 0,
                    dailyLimit: 0,
                    whitelistEnabled: false,
                    freezeable: false,
                    recoverableKeys: false
                },
                economics: {
                    transactionFee: 0,
                    burnRate: 0,
                    stakingReward: 0,
                    inflationRate: 0
                },
                metadata: {
                    license: 'MIT',
                    description: '',
                    website: '',
                    logoUrl: ''
                },
                // Propiedades de token para compatibilidad
                symbol: '',
                supply: 0,
                decimals: 2,
                tokenType: 'SMART_CONTRACT'
            };

            let currentBlock = contractBlock.getInputTargetBlock('SETTINGS');

            while (currentBlock) {
                switch (currentBlock.type) {

                    case 'contract_name':
                        data.name = currentBlock.getFieldValue('NAME');
                        break;
                    case 'contract_version':
                        data.version = currentBlock.getFieldValue('VERSION');
                        break;
                    case 'admin_address':
                        data.admin = currentBlock.getFieldValue('ADDRESS');
                        break;
                    case 'token_config':
                        data.symbol = currentBlock.getFieldValue('SYMBOL');
                        data.supply = currentBlock.getFieldValue('SUPPLY');
                        break;
                    case 'feature_toggle':
                        const featureName = currentBlock.getFieldValue('FEATURE');
                        const isEnabled = currentBlock.getFieldValue('ENABLED') === 'TRUE';
                        data.features[featureName] = isEnabled;
                        break;
                    case 'state_var':
                        data.state = data.state || [];
                        data.state.push({
                            name: currentBlock.getFieldValue('VAR_NAME'),
                            type: currentBlock.getFieldValue('VAR_TYPE')
                        });
                        break;
                    case 'function_def':
                        data.functions = data.functions || [];
                        data.functions.push({
                            name: currentBlock.getFieldValue('FN_NAME'),
                            returns: currentBlock.getFieldValue('RET_TYPE')
                        });
                        break;
                }
                currentBlock = currentBlock.getNextBlock();
            }

            return data;
        }

        // Validaci√≥n de pasos
        function validateCurrentStep() {
            switch (appState.currentStep) {
                case 1:
                    return validateSetupStep();
                case 2:
                    return validateTokenData();
                case 3:
                    return true; // El paso 3 no requiere validaci√≥n adicional
                default:
                    return true;
            }
        }

        function validateSetupStep() {
            if (!appState.walletConnected) {
                showToast('Por favor, conecta tu wallet', 'error');
                return false;
            }
            return true;
        }

        function validateWalletConnection() {
            if (!appState.walletConnected) {
                showToast('Please, connect your wallet first', 'error');
                return false;
            }
            return true;
        }

        function validateTokenData() {
            // Validaci√≥n simple para smart contracts gen√©ricos
            const contractBlocks = blocklyWorkspace.getBlocksByType('contract_settings', false);

            if (contractBlocks.length === 0) {
                showToast('Please, configure your contract using the blocks', 'error');
                return false;
            }

            const contractBlock = contractBlocks[0];
            let currentBlock = contractBlock.getInputTargetBlock('SETTINGS');
            let hasName = false;
            let contractName = '';

            while (currentBlock) {
                if (currentBlock.type === 'contract_name') {
                    contractName = currentBlock.getFieldValue('NAME');
                    if (contractName && contractName.trim() !== '') {
                        hasName = true;
                    }
                }
                currentBlock = currentBlock.getNextBlock();
            }

            if (!hasName) {
                showToast('The contract name is required', 'error');
                return false;
            }

            // Actualizar appState con datos b√°sicos del contrato
            appState.tokenData = appState.tokenData || {};
            appState.tokenData.name = contractName;
            appState.tokenData.adminAddress = appState.walletAddress;

            return true;
        }

        function updateTokenSummary() {
            // Leer datos actuales de Blockly
            const blocklyData = readBlocklyData();
            if (!blocklyData) return;

            // Actualizar el appState con los datos de Blockly
            appState.tokenData = { ...appState.tokenData, ...blocklyData };

            // Actualizar elementos del resumen
            if (elements.summaryType) {
                const typeLabels = { 'FUNGIBLE': 'Fungible', 'NON_FUNGIBLE': 'Non-Fungible', 'STABLECOIN': 'Stablecoin' };
                elements.summaryType.textContent = typeLabels[blocklyData.tokenType] || blocklyData.tokenType;
            }
            if (elements.summaryName) elements.summaryName.textContent = blocklyData.name || '-';
            if (elements.summarySymbol) elements.summarySymbol.textContent = blocklyData.symbol || '-';
            if (elements.summarySupply) elements.summarySupply.textContent = blocklyData.supply ? blocklyData.supply.toLocaleString() : '-';

            // Mostrar caracter√≠sticas habilitadas
            if (elements.summaryFeatures) {
                const enabledFeatures = [];
                if (blocklyData.features && blocklyData.features.mintable) enabledFeatures.push('Mintable');
                if (blocklyData.features && blocklyData.features.burnable) enabledFeatures.push('Burnable');
                if (blocklyData.features && blocklyData.features.pausable) enabledFeatures.push('Pausable');
                if (blocklyData.features && blocklyData.features.upgradeable) enabledFeatures.push('Upgradeable');
                if (blocklyData.features && blocklyData.features.accessControl) enabledFeatures.push('Access Control');
                if (blocklyData.features && blocklyData.features.governance) enabledFeatures.push('Governance');
                if (blocklyData.features && blocklyData.features.stakeable) enabledFeatures.push('Stakeable');
                if (blocklyData.features && blocklyData.features.timeLock) enabledFeatures.push('Time Lock');

                elements.summaryFeatures.textContent = enabledFeatures.length > 0 ? enabledFeatures.join(', ') : 'Basic Smart Contract';
            }

            if (elements.summaryLicense) elements.summaryLicense.textContent = blocklyData.license || '-';
            if (elements.summaryAdmin) elements.summaryAdmin.textContent = appState.walletAddress ? appState.walletAddress.substring(0, 8) + '...' + appState.walletAddress.substring(appState.walletAddress.length - 8) : '-';
        }

        // Funciones de utilidad
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function hideError(elementId) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
            }
        }

        function showToast(message, type = 'info') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                color: white;
                font-weight: 500;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;

            if (type === 'success') {
                toast.style.background = '#10b981';
            } else if (type === 'error') {
                toast.style.background = '#dc2626';
            } else {
                toast.style.background = '#6366f1';
            }

            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        // Funciones de conexi√≥n de wallet
        async function connectWallet(walletType) {
            try {
                showToast('Connecting wallet...', 'info');

                let address;

                if (walletType === 'Freighter') {
                    if (!window.freighterApi) {
                        // Redirigir a la p√°gina de instalaci√≥n de Freighter
                        window.open('https://freighter.app/', '_blank');
                        showToast('Freighter is not installed. Opening installation page...', 'info');
                        return;
                    }

                    address = await window.freighterApi.getPublicKey();
                    appState.walletType = 'Freighter';
                } else if (walletType === 'Albedo') {
                    if (!(window.albedo && window.albedo.publicKey)) {
                        window.open('https://albedo.link/', '_blank');
                        showToast('Albedo is not installed/available. Opening page...', 'info');
                        return;
                    }
                    const res = await window.albedo.publicKey({
                        // Albedo funciona sin extensi√≥n, solicitar clave p√∫blica
                        intent: 'public_key'
                    });
                    address = res.pubkey;
                    appState.walletType = 'Albedo';
                } else if (walletType === 'xBull') {
                    if (!window.xBullApi) {
                        // Redirigir a la p√°gina de instalaci√≥n de xBull
                        window.open('https://xbull.app/', '_blank');
                        showToast('xBull is not installed. Opening installation page...', 'info');
                        return;
                    }
                    // Implementar conexi√≥n con xBull cuando est√© disponible
                    throw new Error('xBull wallet is not available at this moment');
                } else if (walletType === 'Rabet') {
                    if (!window.rabetApi) {
                        // Redirigir a la p√°gina de instalaci√≥n de Rabet
                        window.open('https://rabet.io/', '_blank');
                        showToast('Rabet is not installed. Opening installation page...', 'info');
                        return;
                    }
                    // Implementar conexi√≥n con Rabet cuando est√© disponible
                    throw new Error('Rabet wallet is not available at this moment');
                } else {
                    throw new Error(`${walletType} wallet is not available at this moment`);
                }

                appState.walletConnected = true;
                appState.walletAddress = address;

                showToast('Wallet connected successfully', 'success');

                // Navegar autom√°ticamente al siguiente paso con transici√≥n suave
                setTimeout(() => {
                    nextStep();
                }, 800);

            } catch (error) {
                console.error('Error connecting wallet:', error);
                showToast(`Error connecting wallet: ${error.message}`, 'error');
            }
        }

        // Funci√≥n de despliegue mejorada con pipeline
        async function deployToken() {
            try {
                // Validar antes de empezar
                if (!validateSmartContract()) {
                    showToast('‚ùå Validate the contract before deploying it', 'error');
                    return;
                }

                // Ocultar summary y mostrar pipeline
                const contractSummary = document.getElementById('contractSummary');
                const deploymentPipeline = document.getElementById('deploymentPipeline');

                if (contractSummary) contractSummary.style.display = 'none';
                if (deploymentPipeline) deploymentPipeline.style.display = 'block';

                elements.nextBtn.disabled = true;
                elements.prevBtn.disabled = true;

                await updatePipelineStep('pipelineValidation', 'active', 'Validating contract configuration...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                await updatePipelineStep('pipelineValidation', 'completed', 'Configuration validated successfully');

                // Paso 1: Compilaci√≥n del Smart Contract
                await updatePipelineStep('pipelineCompilation', 'active', 'Generating Rust smart contract code...');

                const blocklyData = readBlocklyData();
                const rustCode = generateAdvancedRustCode(blocklyData);

                console.log('üîß Compiling Smart Contract:');
                console.log('   Name:', blocklyData.name);
                console.log('   Features:', Object.keys(blocklyData.features).filter(f => blocklyData.features[f]));

                // Simular tiempo de compilaci√≥n
                await new Promise(resolve => setTimeout(resolve, 2000));
                await updatePipelineStep('pipelineCompilation', 'completed', 'Smart contract compiled successfully');
                appState.contractCompiled = true;

                // Paso 2: Build WASM
                await updatePipelineStep('pipelineWasm', 'active', 'Compiling to optimized WebAssembly...');

                // Simular compilaci√≥n WASM
                await new Promise(resolve => setTimeout(resolve, 2500));
                await updatePipelineStep('pipelineWasm', 'completed', 'Optimized WASM generated');

                // Paso 3: Despliegue a la red
                await updatePipelineStep('pipelineDeployment', 'active', 'Deploying to the Stellar network...');

                console.log('üöÄ Smart Contract data for deployment:');
                console.log('   code:', blocklyData.symbol);
                console.log('   amount:', blocklyData.supply);
                console.log('   userAddress:', appState.walletAddress);
                console.log('   features:', blocklyData.features);
                console.log('   security:', blocklyData.security);
                console.log('   economics:', blocklyData.economics);

                const response = await fetch('/api/build-smart-contract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        // Datos b√°sicos del token
                        code: blocklyData.symbol,
                        amount: blocklyData.supply,
                        userAddress: appState.walletAddress,

                        // Datos del smart contract
                        contractData: {
                            name: blocklyData.name,
                            symbol: blocklyData.symbol,
                            decimals: blocklyData.decimals || 2,
                            supply: blocklyData.supply,
                            features: blocklyData.features,
                            security: blocklyData.security,
                            economics: blocklyData.economics,
                            metadata: blocklyData.metadata,
                            rustCode: rustCode
                        }
                    }),
                });

                let result;
                if (response.ok) {
                    result = await response.json();

                    // Manejar modo fallback
                    if (result.fallbackMode) {
                        console.log('‚ö†Ô∏è Servidor en modo fallback - compilaci√≥n no disponible');
                        await updatePipelineStep('pipelineWasm', 'error', 'Compilation not available in this environment');
                        await updatePipelineStep('pipelineDeployment', 'error', 'Smart contract compilation disabled');

                        // Mostrar mensaje de fallback al usuario
                        const fallbackMessage = `
                            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0;">
                                <h3 style="color: #92400e; margin: 0 0 0.5rem 0;">‚ö†Ô∏è Modo Limitado</h3>
                                <p style="color: #92400e; margin: 0; font-size: 0.9rem;">
                                    La compilaci√≥n de smart contracts no est√° disponible en este entorno. 
                                    La aplicaci√≥n funciona con funcionalidad limitada para tokens simples.
                                </p>
                                <p style="color: #92400e; margin: 0.5rem 0 0 0; font-size: 0.8rem;">
                                    ${result.instructions}
                                </p>
                            </div>
                        `;

                        // Insertar mensaje en el pipeline
                        const pipelineContainer = document.querySelector('.pipeline-container');
                        if (pipelineContainer) {
                            pipelineContainer.insertAdjacentHTML('beforeend', fallbackMessage);
                        }

                        // Esperar un poco y luego intentar fallback
                        await new Promise(resolve => setTimeout(resolve, 3000));
                        console.log('üîÑ Intentando fallback al endpoint original...');
                    }
                } else {
                    console.log('‚ö†Ô∏è Smart contract endpoint failed, trying fallback...');
                    result = null; // Forzar fallback
                }

                // Si no hay resultado v√°lido o estamos en modo fallback, usar endpoint original
                if (!result || result.fallbackMode) {
                    console.log('üîÑ Usando endpoint de fallback para tokens simples...');
                    const fallbackResponse = await fetch('/api/build-transaction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            code: blocklyData.symbol,
                            amount: blocklyData.supply,
                            userAddress: appState.walletAddress,
                            tokenData: blocklyData
                        }),
                    });

                    if (!fallbackResponse.ok) {
                        const errorText = await fallbackResponse.text();
                        throw new Error(`Server error: ${errorText}`);
                    }

                    result = await fallbackResponse.json();

                    if (!result.success) {
                        throw new Error(result.details || 'Unknown server error');
                    }
                } else if (!result.success && !result.fallbackMode) {
                    throw new Error(result.details || 'Unknown server error');
                }

                // Paso 4: Verificar si se despleg√≥ autom√°ticamente o compil√≥ solamente
                const isDeployed = result.deployment.status === 'deployed';
                const stepMessage = isDeployed ?
                    'Smart contract deployed successfully' :
                    'Smart contract compiled - Manual deployment available';

                await updatePipelineStep('pipelineDeployment', 'active', stepMessage);

                console.log('üéâ Smart contract:', result.smartContract.contractName);
                console.log('üì¶ WASM size:', result.wasmSize, 'bytes');
                console.log('üìÅ WASM path:', result.smartContract.wasmPath);

                if (isDeployed) {
                    console.log('üöÄ Contract address:', result.smartContract.contractAddress);
                } else {
                    console.log('‚ö†Ô∏è Manual deployment required');
                }

                // Finalizar proceso seg√∫n el estado del deployment
                const finalMessage = isDeployed ?
                    'Finalizing deployment...' :
                    'Finalizing compilation...';

                await updatePipelineStep('pipelineDeployment', 'active', finalMessage);

                // Crear resultado con informaci√≥n real del deployment
                const processResult = {
                    hash: isDeployed ?
                        result.smartContract.contractAddress :
                        'compiled_' + result.contractId.slice(0, 16),
                    successful: true,
                    result_code: isDeployed ? 'DEPLOYMENT_SUCCESS' : 'COMPILATION_SUCCESS',
                    contract_id: result.contractId,
                    contract_address: result.smartContract.contractAddress,
                    deployed: isDeployed,
                    deployment_instructions: result.deployment.deploymentInstructions
                };

                const logMessage = isDeployed ?
                    `‚úÖ Smart Contract deployed successfully: ${processResult.hash}` :
                    `‚úÖ Smart Contract compiled successfully: ${processResult.hash}`;

                console.log(logMessage);

                // Completar el pipeline
                const completionMessage = isDeployed ?
                    'Smart Contract deployed successfully' :
                    'Smart Contract compiled successfully';

                await updatePipelineStep('pipelineDeployment', 'completed', completionMessage);

                // Mostrar resultado final
                setTimeout(() => {
                    showDeploymentSuccess(result, processResult, blocklyData);
                }, 1000);

            } catch (error) {
                console.error('‚ùå Error deploying Smart Contract:', error);

                // Marcar paso actual como error
                const activeStep = document.querySelector('.pipeline-step.active');
                if (activeStep) {
                    const stepId = activeStep.id;
                    await updatePipelineStep(stepId, 'error', `Error: ${error.message}`);
                }

                showToast(`‚ùå Error deploying contract: ${error.message}`, 'error');

                // Re-habilitar botones
                elements.nextBtn.disabled = false;
                elements.prevBtn.disabled = false;
            }
        }

        // Funci√≥n para mostrar las instrucciones de deployment
        function showDeploymentInstructions(instructions) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            let stepsHtml = '';
            if (instructions.setupSteps && Array.isArray(instructions.setupSteps)) {
                stepsHtml = instructions.setupSteps.map((step, index) =>
                    `<div style="margin: 0.5rem 0;">
                        <strong>${index + 1}.</strong> 
                        <code style="background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-family: monospace;">${step}</code>
                    </div>`
                ).join('');
            }

            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 1rem 0; color: #1f2937;">üìã Deployment Instructions</h3>
                    <p style="margin: 0 0 1rem 0; color: #6b7280;">To deploy your smart contract, run these commands in order:</p>
                    
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0;">
                        ${stepsHtml}
                    </div>
                    
                    <div style="background: #eff6ff; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0;">
                        <p style="margin: 0; color: #1e40af; font-size: 0.9rem;">
                            <strong>‚ÑπÔ∏è Command Explanations:</strong><br>
                            1. <strong>generate</strong>: Creates a new identity to sign transactions<br>
                            2. <strong>fund</strong>: Requests free XLM for the testnet<br>
                            3. <strong>deploy</strong>: Deploys the smart contract to the network
                        </p>
                    </div>
                    
                    <p style="margin: 1rem 0 0 0; color: #6b7280; font-size: 0.9rem;">
                        <strong>Stellar CLI Installation:</strong> 
                        <a href="${instructions.setupGuide || 'https://developers.stellar.org/docs/build/smart-contracts/getting-started/setup'}" target="_blank" style="color: #3b82f6;">View official guide</a>
                        <br><br>
                        <strong>Alternative:</strong> 
                        <a href="${instructions.stellarLaboratory || 'https://laboratory.stellar.org/'}" target="_blank" style="color: #3b82f6;">Use Stellar Laboratory</a>
                    </p>
                    
                    <button onclick="this.parentElement.parentElement.remove()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; margin-top: 1rem; font-weight: 600;">Got it</button>
                </div>
            `;

            document.body.appendChild(modal);

            // Cerrar al hacer click fuera del modal
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Funci√≥n para mostrar el resultado exitoso del despliegue
        function showDeploymentSuccess(result, submitResult, contractData) {
            const deploymentPipeline = document.getElementById('deploymentPipeline');
            const deploymentResult = document.getElementById('deploymentResult');

            if (deploymentPipeline) deploymentPipeline.style.display = 'none';
            if (deploymentResult) {
                deploymentResult.classList.remove('hidden');

                const features = Object.keys(contractData.features || {})
                    .filter(f => contractData.features[f])
                    .map(f => {
                        const names = {
                            'mintable': 'Mintable',
                            'burnable': 'Burnable',
                            'pausable': 'Pausable',
                            'upgradeable': 'Upgradeable',
                            'governance': 'Governance',
                            'stakeable': 'Stakeable',
                            'timeLock': 'Time Lock',
                            'accessControl': 'Access Control'
                        };
                        return names[f] || f;
                    }).join(', ');

                // Generar URLs del Stellar Explorer
                const explorerBaseUrl = 'https://stellar.expert/explorer/testnet';
                const contractExplorerUrl = submitResult.contract_address ?
                    `${explorerBaseUrl}/contract/${submitResult.contract_address}` :
                    `${explorerBaseUrl}/search?term=${submitResult.hash}`;
                const transactionExplorerUrl = `${explorerBaseUrl}/tx/${submitResult.hash}`;

                elements.resultContent.innerHTML = `
                    <div style="text-align: center; max-width: 700px; margin: 0 auto;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üéâ</div>
                        <h2 style="color: #10b981; margin-bottom: 2rem;">${submitResult.deployed ? 'Smart Contract Deployed Successfully!' : 'Smart Contract Compiled Successfully!'}</h2>
                        
                        <div style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; color: white; box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="font-size: 2.5rem;">üîç</div>
                                <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">Stellar Explorer</h3>
                            </div>
                            
                            <p style="margin-bottom: 2rem; font-size: 1.1rem; opacity: 0.9;">
                                Explore your smart contract on the Stellar blockchain
                            </p>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                                ${submitResult.deployed ? `
                                    <a href="${contractExplorerUrl}" 
                                       target="_blank" 
                                       style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); color: white; padding: 1.5rem; text-decoration: none; border-radius: 0.75rem; font-weight: 600; transition: all 0.3s; border: 1px solid rgba(255,255,255,0.2);"
                                       onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 15px 35px rgba(0,0,0,0.2)'"
                                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        <div style="font-size: 1.8rem;">üìÑ</div>
                                        <div>View Smart Contract</div>
                                        <div style="font-size: 0.8rem; opacity: 0.8; text-align: center;">Explore the deployed contract</div>
                                    </a>
                                ` : ''}
                                
                                <a href="${transactionExplorerUrl}" 
                                   target="_blank" 
                                   style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); color: white; padding: 1.5rem; text-decoration: none; border-radius: 0.75rem; font-weight: 600; transition: all 0.3s; border: 1px solid rgba(255,255,255,0.2);"
                                   onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 15px 35px rgba(0,0,0,0.2)'"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                    <div style="font-size: 1.8rem;">‚ö°</div>
                                    <div>${submitResult.deployed ? 'View Transaction' : 'View Hash'}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.8; text-align: center;">${submitResult.deployed ? 'Deployment details' : 'Compilation hash'}</div>
                                </a>
                                
                                <a href="https://stellar.expert/explorer/testnet" 
                                   target="_blank" 
                                   style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); color: white; padding: 1.5rem; text-decoration: none; border-radius: 0.75rem; font-weight: 600; transition: all 0.3s; border: 1px solid rgba(255,255,255,0.2);"
                                   onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 15px 35px rgba(0,0,0,0.2)'"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                    <div style="font-size: 1.8rem;">üåê</div>
                                    <div>Explore Network</div>
                                    <div style="font-size: 0.8rem; opacity: 0.8; text-align: center;">Entire Stellar Network</div>
                                </a>
                            </div>
                            
                            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 0.5rem; font-size: 0.9rem; opacity: 0.9;">
                                <strong>Hash:</strong> <code style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-family: monospace;">${submitResult.hash}</code>
                            </div>
                        </div>
                        
                        <button onclick="window.location.reload()" 
                                style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: #10b981; color: white; padding: 1rem 2rem; border: none; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.3s; margin: 0 auto;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(16, 185, 129, 0.3)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            üîÑ Create Another Smart Contract
                        </button>
                    </div>
                `;
            }

            showToast('üéâ Smart Contract deployed successfully!', 'success');
        }


        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Botones de navegaci√≥n
            elements.nextBtn.addEventListener('click', nextStep);
            elements.prevBtn.addEventListener('click', prevStep);

            // Botones de conexi√≥n de wallet
            document.getElementById('connectFreighter').addEventListener('click', () => connectWallet('Freighter'));
            document.getElementById('connectXbull').addEventListener('click', () => connectWallet('xBull'));
            // document.getElementById('connectAlbedo').addEventListener('click', () => connectWallet('Albedo'));
            // document.getElementById('connectRabet').addEventListener('click', () => connectWallet('Rabet'));

            // Botones de preview y validaci√≥n
            const refreshPreviewBtn = document.getElementById('refreshPreview');
            if (refreshPreviewBtn) {
                refreshPreviewBtn.addEventListener('click', updateCodePreview);
            }

            const validateContractBtn = document.getElementById('validateContract');
            if (validateContractBtn) {
                validateContractBtn.addEventListener('click', () => {
                    const isValid = validateSmartContract();
                    if (isValid) {
                        showToast('‚úÖ Contract validated successfully', 'success');
                    } else {
                        showToast('‚ùå Errors found in the contract', 'error');
                    }
                });
            }

            const viewFullCodeBtn = document.getElementById('viewFullCode');
            if (viewFullCodeBtn) {
                viewFullCodeBtn.addEventListener('click', () => {
                    const blocklyData = readBlocklyData();
                    if (blocklyData && blocklyData.name) {
                        const fullCode = generateAdvancedRustCode(blocklyData);

                        // Crear modal para mostrar c√≥digo completo
                        const modal = document.createElement('div');
                        modal.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0,0,0,0.8);
                            z-index: 1000;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            padding: 2rem;
                        `;

                        modal.innerHTML = `
                            <div style="background: white; border-radius: 1rem; padding: 2rem; max-width: 80%; max-height: 80%; overflow: auto;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h3>üìÑ Full Smart Contract Code</h3>
                                    <button id="closeCodeModal" style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">‚úï Close</button>
                                </div>
                                <pre style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; overflow: auto; font-size: 0.875rem; line-height: 1.5;">${fullCode}</pre>
                                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                                    <button id="downloadCode" style="background: #6366f1; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;">üì• Download</button>
                                    <button id="copyCode" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;">üìã Copy</button>
                                </div>
                            </div>
                        `;

                        document.body.appendChild(modal);

                        // Event listeners del modal
                        document.getElementById('closeCodeModal').addEventListener('click', () => {
                            modal.remove();
                        });

                        document.getElementById('downloadCode').addEventListener('click', () => {
                            const blob = new Blob([fullCode], { type: 'text/rust' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `${blocklyData.symbol || 'token'}_contract.rs`;
                            a.click();
                            URL.revokeObjectURL(url);
                            showToast('üì• Code downloaded', 'success');
                        });

                        document.getElementById('copyCode').addEventListener('click', async () => {
                            try {
                                await navigator.clipboard.writeText(fullCode);
                                showToast('üìã Code copied to clipboard', 'success');
                            } catch (err) {
                                showToast('‚ùå Error copying code', 'error');
                            }
                        });

                        // Cerrar modal al hacer clic fuera
                        modal.addEventListener('click', (e) => {
                            if (e.target === modal) {
                                modal.remove();
                            }
                        });
                    } else {
                        showToast('‚ö†Ô∏è Configure the blocks first', 'error');
                    }
                });
            }

            // Efectos de hover para las opciones de wallet
            document.querySelectorAll('.wallet-option').forEach(option => {
                option.addEventListener('mouseenter', function () {
                    this.style.transform = 'translateY(-6px) scale(1.05)';
                });

                option.addEventListener('mouseleave', function () {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });

            // Inicializar stepper
            updateStepper();
        });

    </script>
</body>

</html>